<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ü§ñ Animation State Machine in Godot3 | Peanuts Code</title>
<meta name=keywords content="GameDev,GodotEngine,Godot3,2D,Animation,StateMachine"><meta name=description content="This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another. There are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, &ldquo;idle&rdquo; and &ldquo;run&rdquo; can transition immediately in both directions, but &ldquo;idle&rdquo; to &ldquo;attack&rdquo; can transition immediately, but &ldquo;attack&rdquo; to &ldquo;run&rdquo; cannot, and &ldquo;attack&rdquo; to &ldquo;idle&rdquo; can transition only after the &ldquo;attack&rdquo; animation ends. The &ldquo;attack&rdquo; to &ldquo;idle&rdquo; transition occurs only after the &ldquo;attack&rdquo; animation is over. If all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot&rsquo;s &ldquo;AnimationTree&rdquo; node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the &ldquo;AnimationTree&rdquo; node. Environment Godot version: 3.5.1 Computer OS: macOS 12.6"><meta name=author content="gobo"><link rel=canonical href=https://www.peanuts-code.com/en/tutorials/gd0019_2d_animation_state_machine/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.peanuts-code.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.peanuts-code.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.peanuts-code.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.peanuts-code.com/apple-touch-icon.png><link rel=mask-icon href=https://www.peanuts-code.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://www.peanuts-code.com/ja/tutorials/gd0019_2d_animation_state_machine/><link rel=alternate hreflang=en href=https://www.peanuts-code.com/en/tutorials/gd0019_2d_animation_state_machine/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="ü§ñ Animation State Machine in Godot3"><meta property="og:description" content="This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another. There are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, &ldquo;idle&rdquo; and &ldquo;run&rdquo; can transition immediately in both directions, but &ldquo;idle&rdquo; to &ldquo;attack&rdquo; can transition immediately, but &ldquo;attack&rdquo; to &ldquo;run&rdquo; cannot, and &ldquo;attack&rdquo; to &ldquo;idle&rdquo; can transition only after the &ldquo;attack&rdquo; animation ends. The &ldquo;attack&rdquo; to &ldquo;idle&rdquo; transition occurs only after the &ldquo;attack&rdquo; animation is over. If all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot&rsquo;s &ldquo;AnimationTree&rdquo; node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the &ldquo;AnimationTree&rdquo; node. Environment Godot version: 3.5.1 Computer OS: macOS 12.6"><meta property="og:type" content="article"><meta property="og:url" content="https://www.peanuts-code.com/en/tutorials/gd0019_2d_animation_state_machine/"><meta property="og:image" content="https://www.peanuts-code.com/images/tutorials/gd0019_state_machine/img31.gif"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2022-10-14T20:25:00+09:00"><meta property="article:modified_time" content="2022-10-14T20:25:00+09:00"><meta property="og:site_name" content="Peanuts Code ü•ú"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.peanuts-code.com/images/tutorials/gd0019_state_machine/img31.gif"><meta name=twitter:title content="ü§ñ Animation State Machine in Godot3"><meta name=twitter:description content="This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another. There are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, &ldquo;idle&rdquo; and &ldquo;run&rdquo; can transition immediately in both directions, but &ldquo;idle&rdquo; to &ldquo;attack&rdquo; can transition immediately, but &ldquo;attack&rdquo; to &ldquo;run&rdquo; cannot, and &ldquo;attack&rdquo; to &ldquo;idle&rdquo; can transition only after the &ldquo;attack&rdquo; animation ends. The &ldquo;attack&rdquo; to &ldquo;idle&rdquo; transition occurs only after the &ldquo;attack&rdquo; animation is over. If all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot&rsquo;s &ldquo;AnimationTree&rdquo; node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the &ldquo;AnimationTree&rdquo; node. Environment Godot version: 3.5.1 Computer OS: macOS 12.6"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ü§ñ Tutorials","item":"https://www.peanuts-code.com/en/tutorials/"},{"@type":"ListItem","position":2,"name":"ü§ñ Animation State Machine in Godot3","item":"https://www.peanuts-code.com/en/tutorials/gd0019_2d_animation_state_machine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ü§ñ Animation State Machine in Godot3","name":"ü§ñ Animation State Machine in Godot3","description":"This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another. There are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, \u0026ldquo;idle\u0026rdquo; and \u0026ldquo;run\u0026rdquo; can transition immediately in both directions, but \u0026ldquo;idle\u0026rdquo; to \u0026ldquo;attack\u0026rdquo; can transition immediately, but \u0026ldquo;attack\u0026rdquo; to \u0026ldquo;run\u0026rdquo; cannot, and \u0026ldquo;attack\u0026rdquo; to \u0026ldquo;idle\u0026rdquo; can transition only after the \u0026ldquo;attack\u0026rdquo; animation ends. The \u0026ldquo;attack\u0026rdquo; to \u0026ldquo;idle\u0026rdquo; transition occurs only after the \u0026ldquo;attack\u0026rdquo; animation is over. If all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot\u0026rsquo;s \u0026ldquo;AnimationTree\u0026rdquo; node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the \u0026ldquo;AnimationTree\u0026rdquo; node. Environment Godot version: 3.5.1 Computer OS: macOS 12.6","keywords":["GameDev","GodotEngine","Godot3","2D","Animation","StateMachine"],"articleBody":"This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another.\nThere are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, ‚Äúidle‚Äù and ‚Äúrun‚Äù can transition immediately in both directions, but ‚Äúidle‚Äù to ‚Äúattack‚Äù can transition immediately, but ‚Äúattack‚Äù to ‚Äúrun‚Äù cannot, and ‚Äúattack‚Äù to ‚Äúidle‚Äù can transition only after the ‚Äúattack‚Äù animation ends. The ‚Äúattack‚Äù to ‚Äúidle‚Äù transition occurs only after the ‚Äúattack‚Äù animation is over.\nIf all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot‚Äôs ‚ÄúAnimationTree‚Äù node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the ‚ÄúAnimationTree‚Äù node.\nEnvironment Godot version: 3.5.1\nComputer OS: macOS 12.6\nBasic Articles You may also find the following articles useful.\nDownloading Godot Project Manager of Godot3 Preparation Project Settings After starting a new project, do some preliminary project settings.\nThe window size is set as follows.\nAdded the following actions to the input map for the player character‚Äôs movement and attacks.\nDownload Assets I have downloaded the asset pack from the following link.\nitch.io - mystic woods Use the three sprite sheets ‚Äúplayer.png‚Äù, ‚Äúslime.png‚Äù and ‚Äúobjects.png‚Äù in the downloaded folder. I can‚Äôt help but be thankful for this wonderful asset.\nThe three sprite sheets (.png files) are added to the project by dragging and dropping them into Godot‚Äôs file system.\nIf the added image appears blurry (it will by default), select the imported file, select ‚ÄúPresets‚Äù \u003e ‚Äú2D Pixel‚Äù from the ‚ÄúImport‚Äù tab, and click the ‚ÄúReimport‚Äù button. The image will now be displayed with the edges characteristic of dot images.\nCreate a Player scene Create a ‚ÄúPlayer‚Äù scene for the player character. The scene tree will look like this:\nPlayer (KinematicBody2D) Sprite BodyCollisionShape (CollisionShape2D) HitBox (Area2D) HitBoxCollisionShape (CollisionShape2D) AnimationPlayer AnimationTree Edit a node in the Player scene Sprite node Apply the previously imported resource ‚Äúplayer.png‚Äù to the ‚ÄúTexture‚Äù property in the inspector.\nSet the value of the ‚ÄúAnimation‚Äù \u003e ‚ÄúHframes‚Äù property to 6 and the ‚ÄúVframes‚Äù property to 5. This is because the applied sprite sheet consists of 6 columns horizontally and 5 rows vertically. Since this is a free version of the sprite sheet, the fourth row is missing, so don‚Äôt worry about it. Later, we will create an animation by changing the number of frames in the ‚ÄúAnimationPlayer‚Äù node.\nChange ‚ÄúOffset‚Äù \u003e ‚ÄúOffset‚Äù property to (0, -17). The feet of the player character‚Äôs texture will now be at the coordinates (0, 0). This is done so that when the player character‚Äôs feet overlap with other objects on the game screen, the y-coordinates of each object are compared, and the object in front (with the larger y-coordinate) is displayed in the foreground.\nBodyCollisionShape (CollisionShape2D) node In the inspector, the ‚ÄúCircleShape2D‚Äù resource was applied to the ‚ÄúShape‚Äù property, and the size and position were adjusted as follows.\nHitBox (Area2D) node This node is for the Hit Box for melee attacks. There is no need to edit this node. The implementation of melee attacks is explained in detail in the following article.\n2D Hit Detection for Melee Attacks in Godot3 HitBoxCollisionShape (CollisionShape2D) node The ‚ÄúRectangleShape2D‚Äù resource is applied to the ‚ÄúShape‚Äù property. The size and position of the collision shape of the Hit Box will be changed in the animation of the ‚ÄúAnimationPlayer‚Äù node, so we will leave them as they are and set them when creating the animation. The ‚ÄúDisabled‚Äù property is also changed in the attack animation, but since the Hit Box needs to be disabled except during the attack, we leave it turned on.\nAnimationPlayer node Confirm that the ‚ÄúRoot Node‚Äù is set to the ‚ÄúPlayer‚Äù node in the inspector.\nCreate animations In the animation panel, create the following six types of animations.\nidle\nJust change the ‚ÄúFrame‚Äù property of the ‚ÄúSprite‚Äù node. Looping is on.\nrun\nJust change the ‚ÄúFrame‚Äù property of the ‚ÄúSprite‚Äù node. Looping is on.\nattack1\nThis is the first animation for the attack. In addition to changing the ‚ÄúFrame‚Äù property of the ‚ÄúSprite‚Äù node, the ‚ÄúDisabled‚Äù properties of the ‚ÄúBodyCollisionShape‚Äù and ‚ÄúHitBoxCollisionShape‚Äù are turned on and off. Looping is off. At this timing, the position and size of the ‚ÄúHitBoxCollisionShape‚Äù collision shape should be set to match the sprite‚Äôs sword trajectory.\nattack2\nThis is the second animation the attack. This is played during the first animation to make it look as if the player character is attacking continuously. It is just ‚Äúattack1‚Äù played backwards. Looping is turned off.\nhurt\nThis is the animation when the player character takes damage. The sprite sheet does not have a texture when it is damaged, so it is represented by blinking colors. The ‚ÄúModulate‚Äù property of the ‚ÄúSprite‚Äù node is switched between white and red (translucent) multiple times. Two ‚ÄúCall Method Tracks‚Äù were added by clicking ‚Äú+Add Track‚Äù in the upper left corner of the panel. One is to call the set_physics_process() method at the end of the animation. In the inspector, turn on ‚ÄúArgs‚Äù \u003e ‚Äú0‚Äù \u003e ‚ÄúValue‚Äù. This means that the argument of this method is passed true. The loop is turned off. The other method will be defined later in the script and then added (here is the state after the addition). The die_on_hurt_anim() method is called. This will be the method that will transition to the ‚Äúdie‚Äù animation when the life reaches 0, and will be explained again when scripting.\ndie\nAnimation when dead. Just change the ‚ÄúFrame‚Äù property of the ‚ÄúSprite‚Äù node. Looping is off.\nThe naming convention ‚Äúattack1‚Äù and ‚Äúattack2‚Äù is based on the following video.\nYouTube - Name Files Logically AnimationTree node Using this node, we will create a state machine to control the animation prepared by ‚ÄúAnimationPlayer‚Äù. 1. In the inspector, select ‚ÄúNew AnimationNodeStateMachine‚Äù for the ‚ÄúTree Root‚Äù property. This is a setting to enable state management of animations.\nMake sure that the ‚ÄúAnimationPlayer‚Äù node is selected in the ‚ÄúAnim Player‚Äù property. Turn on the ‚ÄúActive‚Äù property. If it is not turned on, this node will not function. However, when adding or editing animations on the ‚ÄúAnimationPlayer‚Äù node, you may need to turn it off to stop the animation from playing.\nCreate a State Machine From this point on, we will work on the animation panel. We will compose the animation tree that will carry the state machine.\nOpen the Animation Tree panel.\nRight-click in the panel with the Select/Move tool\nor use the node creation tool and click in the panel, then you can select an animation you want to add as a node from the animations created in ‚ÄúAnimationPlayer‚Äù.\nAt first, all the animations created by ‚ÄúAnimationPlayer‚Äù are added as nodes in the animation tree. In the screenshot below, the nodes are arranged in an orderly fashion, but in the actual creation of the animation tree, the nodes will be connected to each other, and the arrangement will be adjusted each time to make it easier to see.\nThen, in the Select/Move tool, hold down the Shift key and press\nor in the Node Connection tool, press\nnode to node by dragging.\nIf you look at the inspector with the connected arrow selected, you will see that it is a resource called ‚ÄúAnimationNodeStateMachineTransition‚Äù. By changing the ‚ÄúSwitch Mode‚Äù property of this resource from the default ‚ÄúImmediate‚Äù to ‚ÄúAtEnd,‚Äù it is possible to transition to the next node‚Äôs animation after the node‚Äôs animation ends. At this time and in the panel, the arrows will be displayed with lines. In addition, if the ‚ÄúAuto Advance‚Äù property is turned on, the transition can be made automatically without being controlled by a script. In this case, the arrow will be green.\nFor example, when the player character takes damage from an enemy, we want to immediately switch the animation from ‚Äúidle‚Äù to ‚Äúhurt‚Äù, but automatically transition to ‚Äúidle‚Äù when the ‚Äúhurt‚Äù animation ends. In this case, the following is used.\nWe want the first animation at the beginning of the game to play automatically, so select the ‚Äúidle‚Äù animation node and enable autoplay.\nSimilarly, the node for the ‚Äúdie‚Äù animation when the player character dies should be selected and set as the last node.\nThe final configuration was as follows. This time, the attack is not allowed while moving.\nAttach a script to the Player node Attach the script to the ‚ÄúPlayer‚Äù node and edit as follows:\n###Player.gd### extends KinematicBody2D # Life var life: int = 3 # Speed var speed := 80.0 # Velocity var velocity: Vector2 # Referencing a Sprite node onready var sprite = $Sprite # Parameters \u003e Playback property of the AnimationTree node # i.e. AnimationNodeStateMachinePlayback resource onready var state_machine = $AnimationTree.get(\"parameters/playback\") func _physics_process(_delta): get_input() velocity = move_and_slide(velocity) # Methods for player input func get_input(): # Get the current state var current_state = state_machine.get_current_node() # Input for attack if Input.is_action_just_pressed(\"attack\"): # If current_state is not attack1, move to attack1 if current_state ! = \"attack1\": state_machine.travel(\"attack1\") # If current_state is attack1, move to attack2 else: state_machine.travel(\"attack2\") # If an attack is entered, no movement input is accepted and the operation ends. return # Input of movement velocity = Vector2() if Input.is_action_pressed(\"right\"): velocity.x += 1 sprite.flip_h = false if Input.is_action_pressed(\"left\"): velocity.x -= 1 sprite.flip_h = true if Input.is_action_pressed(\"down\"): velocity.y += 1 if Input.is_action_pressed(\"up\"): velocity.y -= 1 velocity = velocity.normalized() * speed # If velocity length is 0, transition the state to idle if velocity.length() == 0: state_machine.travel(\"idle\") # If velocity length is greater than 0, transition the state to run if velocity.length() \u003e 0: state_machine.travel(\"run\") # Methods called when a player is damaged func hurt(): # Life is reduced by 1 life -= 1 # Stop physics process and stop accepting input set_physics_process(false) # Transition state to hurt state_machine.travel(\"hurt\") # Method called at the end of the hurt animation func die_on_hurt_anim(): # If life is greater than 0, do nothing and exit if life \u003e 0: return # Transition the state to die state_machine.travel(\"die\") # Stop the physical process and stop accepting input set_physics_process(false) As mentioned earlier, the method die_on_hurt_anim must be called within the ‚Äúhurt‚Äù animation. At this point, you should go back to the Animation Panel and edit the `hurt‚Äô animation in the ‚ÄúAnimationPlayer‚Äù node.\nThe ‚ÄúAnimationNodeStateMachinePlayback‚Äù resource class, which is the value of the ‚ÄúAnimationTree‚Äù node‚Äôs ‚ÄúParameters‚Äù \u003e ‚ÄúPlayback‚Äù property, has a method called get_current_node that can be called from the current node. Calling this method will get the current animation node. This is useful when you want to make an if statement conditional on the current node.\nThe travel method, also a built-in function of this class, can be used to control the animation transition by passing the name of the animation node to be transitioned as a string argument. Of course, it is necessary to set up the transition on the animation tree (connected by arrows).\nConnect the ‚Äúbody_entered‚Äù signal of the ‚ÄúHitBox (Area2D)‚Äù node at the end of the script and edit the generated method as follows:\n###Player.gd### func _on_HitBox_body_entered(body): # Call the hurt method of the body object that was hit by the sword body.hurt() Operation check This time, a ‚ÄúTree‚Äù scene and a ‚ÄúSlime‚Äù scene were created separately for operation checks. Both scenes can inflict damage by colliding with the ‚ÄúHitBox‚Äù in the ‚ÄúPlayer‚Äù scene. The ‚ÄúSlime‚Äù scene also has a ‚ÄúHitBox‚Äù node, and when the ‚ÄúPlayer‚Äù hits the ‚ÄúSlime‚Äù, the player side takes damage and its life is reduced by one. The life property of the ‚ÄúPlayer‚Äù is set to 3, so that the player will die after hitting Slime three times.\nWe prepared a ‚ÄúWorld‚Äù scene and added instances of the ‚ÄúPlayer,‚Äù ‚ÄúTree,‚Äù and ‚ÄúSlime‚Äù scenes. To check the operation, set the ‚ÄúWorld‚Äù scene as the main scene and run the project.\nYou can see how the state machine smoothly transitions the animation according to the situation.\nConclusion In this article, we explained how to use a state machine to transition the animation (state) of the player character. Let‚Äôs look back at the key points of our work.\nIdentify the states to be used in the game first. Create an animation for each state using ‚ÄúAnimationPlayer‚Äù Create a state machine with ‚ÄúAnimationTree‚Äù Control animation transitions with a script. In fact, if you have a large number of animations, the nodes and the lines connecting them in the animation tree panel may become cluttered and difficult to understand visually. In such cases, it is a good idea to write them down on a piece of paper with a pen first to organize them in your mind.\nOf course, you can also create a state machine with a script instead of relying on the ‚ÄúAnimationTree‚Äù node, so if you are not comfortable with editing the animation tree panel, you can try that.\nReferences Godot Docs - Introduction to the animation features Godot Docs - Using AnimationTree Godot Docs - AnimationNodeStateMachinePlayback KidsCanCode - CONTROLLING ANIMATION STATES YouTube - Godot Recipes: Animation States YouTube - Make an Action RPG in Godot 3.2 (P9 | Attacking Animation + State Machines) YouTube - Name Files Logically itch.io - mystic woods ","wordCount":"2226","inLanguage":"en","image":"https://www.peanuts-code.com/images/tutorials/gd0019_state_machine/img31.gif","datePublished":"2022-10-14T20:25:00+09:00","dateModified":"2022-10-14T20:25:00+09:00","author":{"@type":"Person","name":"gobo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peanuts-code.com/en/tutorials/gd0019_2d_animation_state_machine/"},"publisher":{"@type":"Organization","name":"Peanuts Code","logo":{"@type":"ImageObject","url":"https://www.peanuts-code.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.peanuts-code.com/en/ accesskey=h title="Peanuts Code (Alt + H)"><img src=https://www.peanuts-code.com/images/logomark.png alt aria-label=logo height=35>Peanuts Code</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.peanuts-code.com/ja/ title=Japanese aria-label=üáØüáµÊó•Êú¨Ë™û>üáØüáµÊó•Êú¨Ë™û</a></li></ul></div></div><ul id=menu><li><a href=https://www.peanuts-code.com/en/ title=Home><span>Home</span></a></li><li><a href=https://www.peanuts-code.com/en/portfolio/ title=Works><span>Works</span></a></li><li><a href=https://www.peanuts-code.com/en/posts/ title=Blogs><span>Blogs</span></a></li><li><a href=https://www.peanuts-code.com/en/tutorials/ title=Tutorials><span>Tutorials</span></a></li><li><a href=https://www.peanuts-code.com/en/about/ title=About><span>About</span></a></li><li><a href=https://www.peanuts-code.com/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.peanuts-code.com/en/>Home</a>&nbsp;¬ª&nbsp;<a href=https://www.peanuts-code.com/en/tutorials/>ü§ñ Tutorials</a></div><h1 class="post-title entry-hint-parent">ü§ñ Animation State Machine in Godot3</h1><div class=post-meta><span title='2022-10-14 20:25:00 +0900 +0900'>2022-10-14</span>&nbsp;¬∑&nbsp;5 min&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://www.peanuts-code.com/ja/tutorials/gd0019_2d_animation_state_machine/>üáØüáµÊó•Êú¨Ë™û</a></li></ul></div><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on x" href="https://x.com/intent/tweet/?text=%f0%9f%a4%96%20Animation%20State%20Machine%20in%20Godot3&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f&amp;hashtags=GameDev%2cGodotEngine%2cGodot3%2c2D%2cAnimation%2cStateMachine"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f&title=%f0%9f%a4%96%20Animation%20State%20Machine%20in%20Godot3"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><ul class=post-tags><li><a href=https://www.peanuts-code.com/en/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/en/tags/godotengine/>GodotEngine</a></li><li><a href=https://www.peanuts-code.com/en/tags/godot3/>Godot3</a></li><li><a href=https://www.peanuts-code.com/en/tags/2d/>2D</a></li><li><a href=https://www.peanuts-code.com/en/tags/animation/>Animation</a></li><li><a href=https://www.peanuts-code.com/en/tags/statemachine/>StateMachine</a></li></ul></header><figure class=entry-cover><img loading=eager src=https://www.peanuts-code.com/images/tutorials/gd0019_state_machine/img31.gif alt="Animation State Machine in Godot3"></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#preparation>Preparation</a><ul><li><a href=#project-settings>Project Settings</a></li><li><a href=#download-assets>Download Assets</a></li></ul></li><li><a href=#create-a-player-scene>Create a Player scene</a></li><li><a href=#edit-a-node-in-the-player-scene>Edit a node in the Player scene</a><ul><li><a href=#sprite-node>Sprite node</a></li><li><a href=#bodycollisionshape-collisionshape2d-node>BodyCollisionShape (CollisionShape2D) node</a></li><li><a href=#hitbox-area2d-node>HitBox (Area2D) node</a></li><li><a href=#hitboxcollisionshape-collisionshape2d-node>HitBoxCollisionShape (CollisionShape2D) node</a></li><li><a href=#animationplayer-node>AnimationPlayer node</a></li><li><a href=#animationtree-node>AnimationTree node</a></li></ul></li><li><a href=#attach-a-script-to-the-player-node>Attach a script to the Player node</a></li><li><a href=#operation-check>Operation check</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><p>This article describes an implementation of an animated state machine for a 2D game. A state machine controls the transition of an object from one state to another.</p><p>There are several restrictions on state transitions, such as when an object can only transition from one state to a limited number of states, or when an object can only transition to the next state after the current animation ends. For example, &ldquo;idle&rdquo; and &ldquo;run&rdquo; can transition immediately in both directions, but &ldquo;idle&rdquo; to &ldquo;attack&rdquo; can transition immediately, but &ldquo;attack&rdquo; to &ldquo;run&rdquo; cannot, and &ldquo;attack&rdquo; to &ldquo;idle&rdquo; can transition only after the &ldquo;attack&rdquo; animation ends. The &ldquo;attack&rdquo; to &ldquo;idle&rdquo; transition occurs only after the &ldquo;attack&rdquo; animation is over.</p><p>If all of these controls were coded in script, the code would tend to be rather long and complex. On the other hand, Godot&rsquo;s &ldquo;AnimationTree&rdquo; node can be used to reduce the amount of script code and improve readability. In this article, we will show you how to implement a state machine using the &ldquo;AnimationTree&rdquo; node.</p><blockquote><p><strong><span style=color:salmon>Environment</span></strong><br><em>Godot version: <strong>3.5.1</strong></em><br><em>Computer OS: <strong>macOS 12.6</strong></em></p></blockquote><blockquote><p><strong><span style=color:salmon>Basic Articles</span></strong><br><em>You may also find the following articles useful.<br><a href=https://www.peanuts-code.com/en/tutorials/gd0001_download/>Downloading Godot</a><br><a href=https://www.peanuts-code.com/en/tutorials/gd0002_project_manager/>Project Manager of Godot3</a></em></p></blockquote><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=preparation>Preparation</h2><h3 id=project-settings>Project Settings</h3><p>After starting a new project, do some preliminary project settings.</p><p>The window size is set as follows.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img1.png alt="project settings - window size"></p><p>Added the following actions to the input map for the player character&rsquo;s movement and attacks.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img2.png alt="project settings - add actions to input map"></p><br><h3 id=download-assets>Download Assets</h3><p>I have downloaded the asset pack from the following link.</p><blockquote><p><em><a href=https://game-endeavor.itch.io/mystic-woods target=_blank>itch.io - mystic woods</a></em></p></blockquote><p>Use the three sprite sheets &ldquo;player.png&rdquo;, &ldquo;slime.png&rdquo; and &ldquo;objects.png&rdquo; in the downloaded folder. I can&rsquo;t help but be thankful for this wonderful asset.</p><p>The three sprite sheets (.png files) are added to the project by dragging and dropping them into Godot&rsquo;s file system.</p><p>If the added image appears blurry (it will by default), select the imported file, select &ldquo;Presets&rdquo; > &ldquo;2D Pixel&rdquo; from the &ldquo;Import&rdquo; tab, and click the &ldquo;Reimport&rdquo; button. The image will now be displayed with the edges characteristic of dot images.</p><hr><h2 id=create-a-player-scene>Create a Player scene</h2><p>Create a &ldquo;Player&rdquo; scene for the player character. The scene tree will look like this:</p><ul><li>Player (KinematicBody2D)<ul><li>Sprite</li><li>BodyCollisionShape (CollisionShape2D)</li><li>HitBox (Area2D)<ul><li>HitBoxCollisionShape (CollisionShape2D)</li></ul></li><li>AnimationPlayer</li><li>AnimationTree</li></ul></li></ul><p><img loading=lazy src=/images/tutorials/gd0019_state_machine/img3.png alt="Player scene tree"></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=edit-a-node-in-the-player-scene>Edit a node in the Player scene</h2><h3 id=sprite-node>Sprite node</h3><ol><li>Apply the previously imported resource &ldquo;player.png&rdquo; to the &ldquo;Texture&rdquo; property in the inspector.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img4.png alt="Sprite node - edit properies"><br>Set the value of the &ldquo;Animation&rdquo; > &ldquo;Hframes&rdquo; property to 6 and the &ldquo;Vframes&rdquo; property to 5. This is because the applied sprite sheet consists of 6 columns horizontally and 5 rows vertically. Since this is a free version of the sprite sheet, the fourth row is missing, so don&rsquo;t worry about it. Later, we will create an animation by changing the number of frames in the &ldquo;AnimationPlayer&rdquo; node.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img6.png alt="Sprite node - edit properies">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img4.1.png alt="Sprite node - edit properies"></li><li>Change &ldquo;Offset&rdquo; > &ldquo;Offset&rdquo; property to (0, -17). The feet of the player character&rsquo;s texture will now be at the coordinates (0, 0). This is done so that when the player character&rsquo;s feet overlap with other objects on the game screen, the y-coordinates of each object are compared, and the object in front (with the larger y-coordinate) is displayed in the foreground.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img4.2.png alt="Sprite node - edit properies">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img5.png alt="Sprite node - edit properies"></li></ol><br><h3 id=bodycollisionshape-collisionshape2d-node>BodyCollisionShape (CollisionShape2D) node</h3><p>In the inspector, the &ldquo;CircleShape2D&rdquo; resource was applied to the &ldquo;Shape&rdquo; property, and the size and position were adjusted as follows.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img7.png alt="BodyCollisionShape node - edit properies"></p><br><h3 id=hitbox-area2d-node>HitBox (Area2D) node</h3><p>This node is for the Hit Box for melee attacks. There is no need to edit this node. The implementation of melee attacks is explained in detail in the following article.</p><blockquote><p><em><a href=https://www.peanuts-code.com/en/tutorials/gd0018_melee_attacks/ title="2D Hit Detection for Melee Attacks in Godot3">2D Hit Detection for Melee Attacks in Godot3</a></em></p></blockquote><br><h3 id=hitboxcollisionshape-collisionshape2d-node>HitBoxCollisionShape (CollisionShape2D) node</h3><p>The &ldquo;RectangleShape2D&rdquo; resource is applied to the &ldquo;Shape&rdquo; property. The size and position of the collision shape of the Hit Box will be changed in the animation of the &ldquo;AnimationPlayer&rdquo; node, so we will leave them as they are and set them when creating the animation. The &ldquo;Disabled&rdquo; property is also changed in the attack animation, but since the Hit Box needs to be disabled except during the attack, we leave it turned on.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img8.png alt="HitBoxCollisionShape node - edit properies"></p><br><h3 id=animationplayer-node>AnimationPlayer node</h3><p>Confirm that the &ldquo;Root Node&rdquo; is set to the &ldquo;Player&rdquo; node in the inspector.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img9.png alt="AnimationPlayer node - edit properies"></p><br><h4 id=create-animations>Create animations</h4><p>In the animation panel, create the following six types of animations.</p><ul><li><strong>idle</strong><br>Just change the &ldquo;Frame&rdquo; property of the &ldquo;Sprite&rdquo; node. Looping is on.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img10.gif alt="Animation - idle"></li><li><strong>run</strong><br>Just change the &ldquo;Frame&rdquo; property of the &ldquo;Sprite&rdquo; node. Looping is on.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img11.gif alt="Animation - run"></li><li><strong>attack1</strong><br>This is the first animation for the attack. In addition to changing the &ldquo;Frame&rdquo; property of the &ldquo;Sprite&rdquo; node, the &ldquo;Disabled&rdquo; properties of the &ldquo;BodyCollisionShape&rdquo; and &ldquo;HitBoxCollisionShape&rdquo; are turned on and off. Looping is off. At this timing, the position and size of the &ldquo;HitBoxCollisionShape&rdquo; collision shape should be set to match the sprite&rsquo;s sword trajectory.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img12.gif alt="Animation - attack1"></li><li><strong>attack2</strong><br>This is the second animation the attack. This is played during the first animation to make it look as if the player character is attacking continuously. It is just &ldquo;attack1&rdquo; played backwards. Looping is turned off.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img13.gif alt="Animation - attack2"></li><li><strong>hurt</strong><br>This is the animation when the player character takes damage. The sprite sheet does not have a texture when it is damaged, so it is represented by blinking colors. The &ldquo;Modulate&rdquo; property of the &ldquo;Sprite&rdquo; node is switched between white and red (translucent) multiple times. Two &ldquo;Call Method Tracks&rdquo; were added by clicking &ldquo;+Add Track&rdquo; in the upper left corner of the panel. One is to call the <code>set_physics_process()</code> method at the end of the animation. In the inspector, turn on &ldquo;Args&rdquo; > &ldquo;0&rdquo; > &ldquo;Value&rdquo;. This means that the argument of this method is passed <code>true</code>. The loop is turned off. The other method will be defined later in the script and then added (here is the state after the addition). The <code>die_on_hurt_anim()</code> method is called. This will be the method that will transition to the &ldquo;die&rdquo; animation when the life reaches 0, and will be explained again when scripting.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img14.gif alt="Animation - hurt"></li><li><strong>die</strong><br>Animation when dead. Just change the &ldquo;Frame&rdquo; property of the &ldquo;Sprite&rdquo; node. Looping is off.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img15.gif alt="Animation - die"></li></ul><p>The naming convention &ldquo;attack1&rdquo; and &ldquo;attack2&rdquo; is based on the following video.<br><a href=https://youtu.be/XMzR5mJHPDg target=_blank>YouTube - Name Files Logically</a></p><br><h3 id=animationtree-node>AnimationTree node</h3><p>Using this node, we will create a state machine to control the animation prepared by &ldquo;AnimationPlayer&rdquo;. 1. In the inspector, select &ldquo;New AnimationNodeStateMachine&rdquo; for the &ldquo;Tree Root&rdquo; property. This is a setting to enable state management of animations.</p><ol><li>Make sure that the &ldquo;AnimationPlayer&rdquo; node is selected in the &ldquo;Anim Player&rdquo; property.</li><li>Turn on the &ldquo;Active&rdquo; property. If it is not turned on, this node will not function. However, when adding or editing animations on the &ldquo;AnimationPlayer&rdquo; node, you may need to turn it off to stop the animation from playing.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img16.png alt="AnimationTree - Edit properties"></li></ol><br><h4 id=create-a-state-machine>Create a State Machine</h4><p>From this point on, we will work on the animation panel. We will compose the animation tree that will carry the state machine.</p><ol><li>Open the Animation Tree panel.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img17.png alt="AnimationTree pannel"></li><li>Right-click in the panel with the Select/Move tool<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img18.png alt="AnimationTree pannel">
or use the node creation tool and click in the panel,<img loading=lazy src=/images/tutorials/gd0019_state_machine/img19.png alt="AnimationTree pannel">
then you can select an animation you want to add as a node from the animations created in &ldquo;AnimationPlayer&rdquo;.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img20.png alt="AnimationTree pannel"></li><li>At first, all the animations created by &ldquo;AnimationPlayer&rdquo; are added as nodes in the animation tree. In the screenshot below, the nodes are arranged in an orderly fashion, but in the actual creation of the animation tree, the nodes will be connected to each other, and the arrangement will be adjusted each time to make it easier to see.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img21.png alt="AnimationTree pannel"></li><li>Then, in the Select/Move tool, hold down the Shift key and press<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img18.png alt="AnimationTree pannel">
or in the Node Connection tool, press<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img22.png alt="AnimationTree pannel">
node to node by dragging.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img23.png alt="AnimationTree pannel"></li><li>If you look at the inspector with the connected arrow selected, you will see that it is a resource called &ldquo;AnimationNodeStateMachineTransition&rdquo;. By changing the &ldquo;Switch Mode&rdquo; property of this resource from the default &ldquo;Immediate&rdquo; to &ldquo;AtEnd,&rdquo; it is possible to transition to the next node&rsquo;s animation after the node&rsquo;s animation ends. At this time and in the panel, the arrows will be displayed with lines.<img loading=lazy src=/images/tutorials/gd0019_state_machine/img24.png alt="AnimationTree pannel">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img24.1.png alt="AnimationTree pannel">
In addition, if the &ldquo;Auto Advance&rdquo; property is turned on, the transition can be made automatically without being controlled by a script. In this case, the arrow will be green.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img25.png alt="AnimationTree pannel">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img25.1.png alt="AnimationTree pannel">
For example, when the player character takes damage from an enemy, we want to immediately switch the animation from &ldquo;idle&rdquo; to &ldquo;hurt&rdquo;, but automatically transition to &ldquo;idle&rdquo; when the &ldquo;hurt&rdquo; animation ends. In this case, the following is used.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img26.png alt="AnimationTree pannel"></li><li>We want the first animation at the beginning of the game to play automatically, so select the &ldquo;idle&rdquo; animation node and enable autoplay.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img27.png alt="AnimationTree pannel">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img27.1.png alt="AnimationTree pannel">
Similarly, the node for the &ldquo;die&rdquo; animation when the player character dies should be selected and set as the last node.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img28.png alt="AnimationTree pannel">
<img loading=lazy src=/images/tutorials/gd0019_state_machine/img28.1.png alt="AnimationTree pannel"></li><li>The final configuration was as follows. This time, the attack is not allowed while moving.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img29.png alt="AnimationTree pannel"></li></ol><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=attach-a-script-to-the-player-node>Attach a script to the Player node</h2><p>Attach the script to the &ldquo;Player&rdquo; node and edit as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1>###Player.gd###</span>
</span></span><span class=line><span class=cl><span class=kd>extends</span> <span class=nc>KinematicBody2D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Life</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>life</span><span class=p>:</span> <span class=kt>int</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=c1># Speed</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>speed</span> <span class=o>:=</span> <span class=mf>80.0</span>
</span></span><span class=line><span class=cl><span class=c1># Velocity</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>velocity</span><span class=p>:</span> <span class=nc>Vector2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Referencing a Sprite node</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>sprite</span> <span class=o>=</span> <span class=nx>$Sprite</span>
</span></span><span class=line><span class=cl><span class=c1># Parameters &gt; Playback property of the AnimationTree node</span>
</span></span><span class=line><span class=cl><span class=c1># i.e. AnimationNodeStateMachinePlayback resource</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>state_machine</span> <span class=o>=</span> <span class=nx>$AnimationTree</span><span class=o>.</span><span class=nf>get</span><span class=p>(</span><span class=s2>&#34;parameters/playback&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>_delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nf>move_and_slide</span><span class=p>(</span><span class=n>velocity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Methods for player input</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>get_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># Get the current state</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>current_state</span> <span class=o>=</span> <span class=n>state_machine</span><span class=o>.</span><span class=nf>get_current_node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Input for attack</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;attack&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># If current_state is not attack1, move to attack1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>current_state</span> <span class=o>!</span> <span class=o>=</span> <span class=s2>&#34;attack1&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;attack1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># If current_state is attack1, move to attack2</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;attack2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># If an attack is entered, no movement input is accepted and the operation ends.</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Input of movement</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;right&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;left&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;down&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;up&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=n>velocity</span><span class=o>.</span><span class=nf>normalized</span><span class=p>()</span> <span class=o>*</span> <span class=n>speed</span>
</span></span><span class=line><span class=cl>    <span class=c1># If velocity length is 0, transition the state to idle</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># If velocity length is greater than 0, transition the state to run</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Methods called when a player is damaged</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>hurt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># Life is reduced by 1</span>
</span></span><span class=line><span class=cl>	<span class=n>life</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=c1># Stop physics process and stop accepting input</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_physics_process</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Transition state to hurt</span>
</span></span><span class=line><span class=cl>	<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;hurt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Method called at the end of the hurt animation</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>die_on_hurt_anim</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># If life is greater than 0, do nothing and exit</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>life</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=c1># Transition the state to die</span>
</span></span><span class=line><span class=cl>	<span class=n>state_machine</span><span class=o>.</span><span class=nf>travel</span><span class=p>(</span><span class=s2>&#34;die&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Stop the physical process and stop accepting input</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_physics_process</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span></code></pre></div><p>As mentioned earlier, the method <code>die_on_hurt_anim</code> must be called within the &ldquo;hurt&rdquo; animation. At this point, you should go back to the Animation Panel and edit the `hurt&rsquo; animation in the &ldquo;AnimationPlayer&rdquo; node.</p><p>The &ldquo;AnimationNodeStateMachinePlayback&rdquo; resource class, which is the value of the &ldquo;AnimationTree&rdquo; node&rsquo;s &ldquo;Parameters&rdquo; > &ldquo;Playback&rdquo; property, has a method called <code>get_current_node</code> that can be called from the current node. Calling this method will get the current animation node. This is useful when you want to make an <code>if</code> statement conditional on the current node.</p><p>The <code>travel</code> method, also a built-in function of this class, can be used to control the animation transition by passing the name of the animation node to be transitioned as a string argument. Of course, it is necessary to set up the transition on the animation tree (connected by arrows).<br><br></p><p>Connect the &ldquo;body_entered&rdquo; signal of the &ldquo;HitBox (Area2D)&rdquo; node at the end of the script and edit the generated method as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1>###Player.gd###</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_HitBox_body_entered</span><span class=p>(</span><span class=n>body</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Call the hurt method of the body object that was hit by the sword</span>
</span></span><span class=line><span class=cl>	<span class=n>body</span><span class=o>.</span><span class=nf>hurt</span><span class=p>()</span>
</span></span></code></pre></div><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=operation-check>Operation check</h2><p>This time, a &ldquo;Tree&rdquo; scene and a &ldquo;Slime&rdquo; scene were created separately for operation checks. Both scenes can inflict damage by colliding with the &ldquo;HitBox&rdquo; in the &ldquo;Player&rdquo; scene. The &ldquo;Slime&rdquo; scene also has a &ldquo;HitBox&rdquo; node, and when the &ldquo;Player&rdquo; hits the &ldquo;Slime&rdquo;, the player side takes damage and its life is reduced by one. The <code>life</code> property of the &ldquo;Player&rdquo; is set to 3, so that the player will die after hitting Slime three times.</p><p>We prepared a &ldquo;World&rdquo; scene and added instances of the &ldquo;Player,&rdquo; &ldquo;Tree,&rdquo; and &ldquo;Slime&rdquo; scenes. To check the operation, set the &ldquo;World&rdquo; scene as the main scene and run the project.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img30.png alt="World scene tree"></p><p>You can see how the state machine smoothly transitions the animation according to the situation.<br><img loading=lazy src=/images/tutorials/gd0019_state_machine/img31.gif alt="World scene - 2D Workspace"></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=conclusion>Conclusion</h2><p>In this article, we explained how to use a state machine to transition the animation (state) of the player character. Let&rsquo;s look back at the key points of our work.</p><ul><li>Identify the states to be used in the game first.</li><li>Create an animation for each state using &ldquo;AnimationPlayer&rdquo;</li><li>Create a state machine with &ldquo;AnimationTree&rdquo;</li><li>Control animation transitions with a script.</li></ul><p>In fact, if you have a large number of animations, the nodes and the lines connecting them in the animation tree panel may become cluttered and difficult to understand visually. In such cases, it is a good idea to write them down on a piece of paper with a pen first to organize them in your mind.</p><p>Of course, you can also create a state machine with a script instead of relying on the &ldquo;AnimationTree&rdquo; node, so if you are not comfortable with editing the animation tree panel, you can try that.<br><br></p><hr><h2 id=references>References</h2><ul><li><a href=https://docs.godotengine.org/en/stable/tutorials/animation/introduction.html target=_blank>Godot Docs - Introduction to the animation features</a></li><li><a href=https://docs.godotengine.org/en/stable/tutorials/animation/animation_tree.html target=_blank>Godot Docs - Using AnimationTree</a></li><li><a href=https://docs.godotengine.org/en/stable/classes/class_animationnodestatemachineplayback.html target=_blank>Godot Docs - AnimationNodeStateMachinePlayback</a></li><li><a href=http://kidscancode.org/godot_recipes/3.x/ target=_blank>KidsCanCode - CONTROLLING ANIMATION STATES</a></li><li><a href=https://youtu.be/0bq2OIjHxk4 target=_blank>YouTube - Godot Recipes: Animation States</a></li><li><a href=https://youtu.be/0nd1zNiy0C4/animation/animation_state_machine/ target=_blank>YouTube - Make an Action RPG in Godot 3.2 (P9 | Attacking Animation + State Machines)</a></li><li><a href=https://youtu.be/XMzR5mJHPDg target=_blank>YouTube - Name Files Logically</a></li><li><a href=https://game-endeavor.itch.io/mystic-woods target=_blank>itch.io - mystic woods</a></li></ul><hr><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class=post-footer><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on x" href="https://x.com/intent/tweet/?text=%f0%9f%a4%96%20Animation%20State%20Machine%20in%20Godot3&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f&amp;hashtags=GameDev%2cGodotEngine%2cGodot3%2c2D%2cAnimation%2cStateMachine"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f&title=%f0%9f%a4%96%20Animation%20State%20Machine%20in%20Godot3"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ü§ñ Animation State Machine in Godot3 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fen%2ftutorials%2fgd0019_2d_animation_state_machine%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><ul class=post-tags><li><a href=https://www.peanuts-code.com/en/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/en/tags/godotengine/>GodotEngine</a></li><li><a href=https://www.peanuts-code.com/en/tags/godot3/>Godot3</a></li><li><a href=https://www.peanuts-code.com/en/tags/2d/>2D</a></li><li><a href=https://www.peanuts-code.com/en/tags/animation/>Animation</a></li><li><a href=https://www.peanuts-code.com/en/tags/statemachine/>StateMachine</a></li></ul><nav class=paginav><a class=prev href=https://www.peanuts-code.com/en/tutorials/gd0020_switching_sound_resources/><span class=title>¬´ Prev</span><br><span>ü§ñ Switching Sound Resources by Script in Godot3</span>
</a><a class=next href=https://www.peanuts-code.com/en/tutorials/gd0018_melee_attacks/><span class=title>Next ¬ª</span><br><span>ü§ñ 2D Hit Detection for Melee Attacks in Godot3</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.peanuts-code.com/en/>Peanuts Code</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>