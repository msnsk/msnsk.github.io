<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ | Peanuts Code</title>
<meta name=keywords content="GodotEngine,GameDev,ブロック崩し,2D"><meta name=description content="Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作っ"><meta name=author content="Gobo"><link rel=canonical href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_11/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.peanuts-code.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.peanuts-code.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.peanuts-code.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.peanuts-code.com/apple-touch-icon.png><link rel=mask-icon href=https://www.peanuts-code.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_11/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Godot で作るブロック崩し Part 11：パワーアップを実装しよう！"><meta property="og:description" content="Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作っ"><meta property="og:type" content="article"><meta property="og:url" content="https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_11/"><meta property="og:image" content="https://www.peanuts-code.com/images/tutorials/gd0004_breakout/breakout_11/img_15.gif"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2021-12-11T13:36:54+09:00"><meta property="article:modified_time" content="2021-12-11T13:36:54+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.peanuts-code.com/images/tutorials/gd0004_breakout/breakout_11/img_15.gif"><meta name=twitter:title content="Godot で作るブロック崩し Part 11：パワーアップを実装しよう！"><meta name=twitter:description content="Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作っ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"🤖 チュートリアル","item":"https://www.peanuts-code.com/ja/tutorials/"},{"@type":"ListItem","position":2,"name":"🤖 シリーズ：Godot で作るブロック崩し","item":"https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/"},{"@type":"ListItem","position":3,"name":"Godot で作るブロック崩し Part 11：パワーアップを実装しよう！","item":"https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_11/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Godot で作るブロック崩し Part 11：パワーアップを実装しよう！","name":"Godot で作るブロック崩し Part 11：パワーアップを実装しよう！","description":"Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作っ","keywords":["GodotEngine","GameDev","ブロック崩し","2D"],"articleBody":"Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作ったので、今回は個々のパワーアップ機能自体を実装する。\n具体的には以下のパワーアップ機能をそれぞれ作っていく。\nSlow: ボールのスピードを初期値に戻す（遅くする） Expand: 一定時間、パドルを横に伸ばす Multiple: 一定時間、複数のボールを発射できるようにする Laser: 一定時間、レーザービームを発射できるようにする Life: ライフを一つ増やす（ライフ数の最大は 5） それでは前回に引き続きブロック崩しを開発していこう。\nMemo: 過去のシリーズをまだご覧になっていない方は、そちらを先にご覧いただくことをおすすめします。\nGodot で作るブロック崩し パワーアップ機能のための全体的なコード更新 個々のパワーアップの実装をする前に、スクリプト全体を通して必要な更新を先にやってしまおう。「Game.gd」スクリプトのコード量がだんだん多くなってきたが、頑張ろう。では、順番に更新箇所を見ていく。\nシーンドックから Ball と Level1 を削除する 「Ball」ノードと「Level1」ノードをシーンドックで最初から「Game」シーンのルートノードに追加しておくのではなく、_readyメソッド実行時にスクリプトによって追加するように変更する。このチュートリアルの中盤で、パワーアップ「Multiple」が有効になった時に、スクリプトで「Ball」ノードを追加する必要がある。ならば、そのような消したり追加したりするノードは、最初からすべてスクリプトでコントロールする方がシンプルだ。「Game」シーン上では、「Ball」ノード、「Level_」ノード、そしてあとで登場予定の「Laser」ノードだ。\nではまずシーンドックで「Game」シーンから「Ball」ノードと「Level1」ノードを削除しよう。\nonready 変数を追加・削除する #onready var level = $Level1 #　削除 # 中略 #onready var ball = $Ball #　削除 # 中略 onready var paddle_scale = paddle.scale # 追加 #onready var ball_position = ball.position #　削除 onready var ball = preload(\"res://scene/Ball.tscn\") # 追加 onready var powerup = preload(\"res://scene/Powerup.tscn\") # 追加 onready var level = null # 変更 今シーンドックから削除したノードを示す変数levelとballを削除した。さらに「Ball」ノードのプロパティpositionを示すball_positionの変数も削除した。\n代わりに、preloadした「Ball.tscn」と「Powerup.tscn」の PackedScene それぞれの変数ball、powerupを新たに追加した。levelは読み込む PackedScene ファイルの名前につく数字が実際のレベルによって異なるので、preloadできない。いったん、nullとしておき、必要な場面でloadで読み込んだ PackedScene を代入することになる。\nあとはpaddle_scaleを新たに追加した。値はpaddle.scaleで、scaleプロパティは「Paddle」ノードの座標位置を Vector2 型データとして保持するプロパティだ。つまり、ゲーム開始前にパドルの初期位置をこの変数に代入している。\n_ready メソッドを更新する func _ready(): randomize() add_new_level() # 追加 add_new_ball() # 追加 update_hud_life() # For debug leave_one_brick(43, level) # ラインを移動 #ball.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\") # 削除 #for brick in level.get_children(): # 削除 #brick.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\", [brick.global_position]) 新しいメソッドadd_new_levelとadd_new_ballを2つ追加した。これらの定義は後ほど説明する。コードの行の順番はこの通りにする必要がある。それぞれのメソッドで「Game」ルートノードの子ノードとしての順番を「Level_」ノードが先、「Ball」ノードが後になるように指定しているためだ。\nデバッグ時にブロックを残り1つにするメソッドleave_one_brickは別のラインに移動した。これはadd_new_levelメソッドで現在の「Level」ノード内の各ブロックが全部準備できてからでないと処理の対象がないからだ。\n「Ball」ノードはシーンドック上で「Game」シーンから削除済みなので、ball.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\")を_ready内からは削除した。この処理はのちに定義するadd_new_ballメソッド内に追加する。\n同じくfor brick in level.get_children():のブロックを削除した。理由は「Level1」ノードはシーンドック上で「Game」シーンから削除済みで、かつadd_new_levelメソッド内で、このforブロックと全く同じシグナル接続処理を含んでいるからだ。\nis_playing 変数を追加する var is_playing = true 今回、新たにis_playingという変数を追加した。これは、ゲームプレイ中であればtrueの値をもつようにする。\n使い所だが、ブロックをすべて消してそのレベルをクリアした時に、パワーアップ「Multiple」により、複数のボールが画面上に存在する場面が想定できる。この時、一旦画面上のボールをすべて消してから、新しいボールを追加する処理を、このあとの_on_Ball_tree_exitedメソッドにて実装するのだが、画面上からボールが消えるとライフが一つ減るルールなので、ゲームクリア時はこのis_playing変数をfalseに変更し、falseの場合はライフが減らないように修正していく。\n_on_Ball_tree_exited メソッドを更新する 次はボールが画面から消えたら呼ばれる_on_Ball_tree_exitedメソッドだ。今までは画面下に落ちる場合くらいしかこのメソッドが呼ばれることはなかったが、今回のチュートリアルでパワーアップ「Multiple」を実装するにあたり、レベルクリア時に一旦画面上のボールを一掃することになる。その場合もボールが消されるタイミングでこのメソッドが呼ばれる。\nではどのように編集すべきか見ていこう。先ほど定義した変数is_playingも利用する。\nfunc _on_Ball_tree_exited(): print(\"_on_Ball_tree_exited() called\") var no_ball = true # 追加 for child in get_children(): # 追加 if child.is_in_group(\"Balls\"): print(\"found ball\") no_ball = false break if no_ball: # 追加 if is_playing: # 追加 life -= 1 if life \u003c= 0: get_tree().change_scene(\"res://scene/GameOverView.tscn\") else: update_hud_life() else: is_playing = true # Clear powerup items for child in get_children(): if child.is_in_group(\"PowerupItems\"): child.queue_free() # Set Paddle and Balls as default paddle.position = paddle_position add_new_ball() # 追加 #ball = load(\"res://scene/Ball.tscn\").instance() # 削除 #call_deferred(\"add_child\", ball) # 削除 #call_deferred(\"move_child\", ball, 3) # 削除 #ball.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\") # 削除 そこで先に変数no_ballをtrueとしてBool型の変数として定義しておく。get_childrenメソッドで「Game」の子ノードをforループで順番にチェックしていき、子ノードが「Ball」インスタンスに該当する場合は、メソッド内で新しく定義したno_ballをfalseにする（つまり画面上にボールが存在するという意味）。そのあとそのままbreakでループから抜ける。そして、if構文でno_ballがtrue（つまり「Ball」インスタンスがない）の場合はifブロック内のコードが実行される。\nさらに変数is_playingがtrueの場合はライフを一つ減らす。ライフがもし0だったらゲームオーバーの画面に遷移するし、まだライフが残っていれば、HUDを更新する。一方、is_playingがfalseの場合はゲームクリア直後で次のレベルの準備段階なので、ライフは減らさず、この時点でis_playingをtrueに戻しておくのみだ。\nあとのno_ballがtrueだった場合のコードを少し編集した。まず、以下の処理をする4行のコードは削除した。\n新しい「Ball」シーンのインスタンスを生成 そのインスタンスを「Game」ノードの子ノードにする そのインスタンスの子の順番を3番目にする そのインスタンスのシグナルtree_exitedを「Game.gd」内の_on_Ball_tree_exitedメソッドに接続する 代わりに同様の処理を実行するadd_new_ballというメソッドを追加した。このメソッドの定義はちょうどこのあと説明するところだ。\nadd_new_ball メソッドを追加する ではここで「Gamde.gd」スクリプトに新しくadd_new_ballメソッドを以下のように定義して追加しよう。\n# Add a new ball func add_new_ball(): # 追加 var instance = ball.instance() call_deferred(\"add_child\", instance) call_deferred(\"move_child\", instance, 4) instance.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\") instance.mode = 3 「Ball」シーンのインスタンスを「Game」シーンに追加する際に必要な処理をまとめた。最後のinstance.mode = 3\nは「RigidBody2D」クラスのプロパティ「Mode」の値を3、すなわち「Kinematic」に設定するということだ。これはゲーム開始時の初期値であり、このモードの間はパドルから勝手にボールが離れることはない。\n_on_Brick_tree_exited を更新する ブロックを消した時のシグナルで実行される_on_Brick_tree_exitedメソッドを見ておこう。\n# Method receiving Brick signal func _on_Brick_tree_exited(brick_position): # Update Score score += POINT * bonus_rate bonus_rate += 0.1 hud_score.text = \"Score: \" + str(score) # Exit current Level node if level.get_child_count() \u003c= 0: #level.queue_free() # 削除 #print(\"level queue free\") # 削除 #print(\"PowerupItems / Balls queue free\") ＃ 削除 set_next_level() else: # 追加 # Drop powerup item drop_powerup(brick_position) # else ブロック内に移動 このメソッドの中のif / else構文のifブロック内にはset_next_levelメソッドのみを残し他の行は、このあとすべてset_next_levelメソッドの中に移動させる。\n次にelseブロックだ。このelseブロックは元々はなく、if / else構文が終わった後、その外側の最後の行でdrop_powerupメソッドを実行してパワーアップアイテムを出現させていた。今回elseブロックを用意し、その中にdrop_powerupを移動した。この更新によって「ブロックを消した時、画面上の残りブロック数が0より大きかったら（つまり、まだそのレベルのクリアではなかったら）、パワーアップアイテムを出現させる」という意味になった。逆を言うと、そのレベルをクリアした時はアイテムは出現させない、という意味になる。\ndrop_powerup メソッドを更新する drop_powerupメソッドはパワーアップアイテムをドロップさせるメソッドだ。\nfunc drop_powerup(brick_position: Vector2): if randf() \u003c= drop_rate: var powerup_instance = powerup.instance() powerup_instance.position = brick_position call_deferred(\"add_child\", powerup_instance) call_deferred(\"move_child\", powerup_instance, 5) # 追加 powerup_instance.connect(\"item_collided\", self, \"_on_Powerup_item_collided\") 追加したのは、6行目のcall_deferred(\"move_child\", powerup_instance, 5)だ。call_deferredを利用しているが、実際の処理はmove_childメソッドによる子ノードの順番指定だ。\nadd_childメソッドでPowerup.tscnシーンのインスタンスを「Game」ノードの子ノードにした時、デフォルトでは、子ノードの一番最後の順番に配置される。ここで問題になるのは、画面上にパワーアップアイテムがドロップしている最中に、そのレベルをクリアした場合、デフォルトでは「NextScreen」ノードより全面にパワーアップアイテムが配置されてしまうため、レベルをクリアした時に「NextScreen」の上にパワーアップアイテムが表示され、奇妙な画面になってしまう。そこで、それぞれの子ノードが以下の順番になるように「Powerup」のインスタンスノードの順番を5に指定している。\nHUD Paddle Wall Level_（インスタンス） Ball（インスタンス） Powerup（インスタンス） PauseScreen NextScreen もちろん、ゲームプレイ中にドロップ中のパワーアップアイテムが複数あることもあれば、パワーアップアイテム「Multiple」の機能によって、複数のボールが生成されることもあり、上記のような綺麗な順番にはならないが、少なくとも毎回5番目を指定すれば「PauseScreen」や「NextScreen」より全面に表示されることはない。\nset_next_level メソッドを更新する set_next_levelメソッドは、あるレベルのブロックを全て消してクリアした時に実行される、次のレベルの諸々の準備をするメソッドだ。\nfunc set_next_level(): print(\"set_next_level() called\") # Change status is_playing = false print(\"is_playing: \", is_playing) # Clear left objects # 追加 level.queue_free() # 移動 print(\"level.queue_free() called\") # 移動 for child in get_children(): # 追加 if child.is_in_group(\"Balls\"): # 追加 child.queue_free() print(\"PowerupItems/Balls/Lasers group: child.queue_free() called\") # 追加 level_num += 1 # Stop PauseScreen node pause_screen.pause_mode = 1 # Show NextScreen node next_screen.pause_mode = 2 next_screen_level.text = \"Level: \" + str(level_num) next_screen_score.text = \"Score: \" + str(score) next_screen_life.text = \"x \" + str(life) next_screen.show() # Set Level of HUD the next level hud_level.text = \"Level: \" + str(level_num) # Set Paddle and Ball the first position #paddle.position = paddle_position # 削除 #add_new_ball() # 削除 #ball.position = ball_position # 削除 #ball.mode = 3 # 削除 # Set next Level node add_new_level() # 追加 #level = load(\"res://scene/Level\" + str(level_num) + \".tscn\").instance() # 削除 #add_child(level) # 削除 #move_child(level, 5) # 削除 #for child in level.get_children(): # 削除 #child.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\") # Pause game until NextScreen is hidden get_tree().paused = true 「# Clear left objects」とコメントしている下の6行のコードをまるまる追加した（print関数はデバッグようなのでお好みで消して欲しい）。\nこのうちlevel.queue_freeは別のメソッド_on_Brick_tree_exitedから移動したコードだ。クリアして不要になった「Level_」ノードを消すことも、このメソッドの役割とした。\n続いてget_childrenメソッドで得られる「Game」ルートノードの子ノードで回すforループのブロック3行は新たに追加した。まずifブロックは『ブロックがすべて消えたら（つまり、そのレベルをクリアしたら）』という条件になっている。この状況では、次のレベルの設定を開始する前に、画面上に残っているボールを全て消す必要がある。それをこのforループで行っている。ボールをすべて消すとシグナルによって呼ばれる_on_Ball_tree_exitedメソッドによって、画面上に残っているドロップ中のパワーアップアイテムも一掃されるため、このメソッドに記述する必要はない。\nあとadd_new_levelメソッドを新たに追加し、その下にあるコードを削除しているが、これらの削除したコードはこの新しいメソッドに移動させてまとめた形だ。\nでは、これらのメソッドの定義を見ていこう。\nadd_new_level メソッドを追加する add_new_levelメソッドを新たに定義した。\n# Add new level func add_new_level(): # 追加 level = load(\"res://scene/Level\" + str(level_num) + \".tscn\").instance() add_child(level) move_child(level, 3) # 5 から 3 に変更 for child in level.get_children(): child.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\", [child.global_position]) # 第四引数追加 このメソッドの内容は、さきほどのset_next_levelメソッド内で元々処理していた部分をメソッドにまとめたにすぎない。しかし、少し細かいところを調整している。\nまずmove_childメソッドの第二引数を5から3に変えた。これは新しい「Level_」シーンのインスタンスを「Game」ルートノードの子に追加した時の子ノードの順番である。4番目は「Ball」シーンのインスタンスノードが、5番目は「Powerup」シーンのインスタンスノードが使用するためだ。この順番が少し違っていても大した支障はないだろうが、「Ball」および「Powerup」のインスタンスノードは、ゲーム中に複数生成されることになるので、順番を後ろに持ってきた方が「Level_」ノードが常に同じ順番になって、後々問題にならなくて良い。\nひとまず全体的な更新はここまでだ。なかなか骨の折れる作業だったのではないだろうか。いよいよ個別のパワーアップ機能の実装をしていく。\nパワーアップ「Slow」を実装する。 パワーアップアイテム「Slow」の機能はボールのスピードを初期値に戻すことだ。では実装していこう。\n新しいノードグループ「Balls」を作って「Ball」ノードを追加する まずは、新しく「Balls」というノードグループを作成して「Ball」ノードを追加しておこう。これは、あとで Multiple アイテムを実装することを想定して、複数のボールが画面上にある場合にコードを作りやすくするためだ。\n次に「Game.gd」スクリプトを更新していこう。\nボールのスピードを初期値に戻すメソッドを定義する まずボールのスピードを初期値にするメソッドを追加した。以下のslow_ballだ。\nfunc slow_balls(): for child in get_children(): if child.is_in_group(\"Balls\"): child.ball_speed = child.first_speed get_childrenメソッドで、「Game」ノードの子ノード全てにアクセスする。これはのちにパワーアップアイテム「Multiple」の機能が有効になった時に、ゲーム画面上にボールがたくさん存在する状態になるので、それら全てにアクセスするための布石だ。\n次にif構文で、そのアクセスした子ノードそれぞれに対して、順次「Balls」ノードグループのメンバーかどうかをチェックし、メンバーだったら、次の行のコードが実行される。そして実行されるのが、それぞれの Ball ノードの変数ball_speed（現在のスピード）に、別の変数first_speed（最初のスピード）を代入する、というコードだ。これによって、ボールがゲーム開始時と同じスピードに戻る、という流れになっている。\nSlow が有効になったら slow_balls メソッドを実行するようにする _on_Powerup_item_collided　メソッドを編集しよう。\nfunc _on_Powerup_item_collided(item): match item: 0: # SLOW slow_balls() 1: # EXPAND print(\"Game: \", item) 2: # MULTIPLE print(\"Game: \", item) 3: # LASER print(\"Game: \", item) 4: # LIFE print(\"Game: \", item) _on_Powerup_item_collidedメソッドの中のmatchブロック内で、引数itemの値が0（つまり enum の要素Powerup.SLOW)と一致した場合に実行するコードとして、先に定義したslow_ballsメソッドを追加した。\nプロジェクトを実行して動作確認 では一度プロジェクトを実行して「Slow」の動作を確認しておこう。\nちなみにslow_ballsメソッド内のchild.ball_speed = child.first_speedのコードの前後にprint(child.ball_speed)というコードを2つ用意することで、「出力」コンソールで数値として本当にスピードが初期値の150に戻っているのかを確認できる。あくまでデバッグ用だ。\nprint(child.ball_speed) child.ball_speed = child.first_speed print(child.ball_speed) パワーアップ「Expand」を実装する 次はパワーアップアイテム「Expand」の機能だ。「Expand」は一定時間、パドルを横に伸ばす機能だ（Stretch という名前の方が意味は正確だったかもしれない）。このアイテムは以下の仕様で実装していく。\n伸びた後の長さは通常の2倍 長さが元に戻るまでの時間は 10 秒 長さが元に戻るまでは何回「Expand」アイテムと衝突しても長さは伸びない 長さが元に戻るまでの時間は何回「Expand」アイテムと衝突しても増えない ボールが落ちたり、ブロックをすべて消してレベルをクリアしたら通常の長さに戻る ではまた「Game.gd」スクリプトを編集していこう。\nonready 変数でパドルの最初の長さを定義する まずonreadyつきの変数を一つ追加した。\nonready var paddle_scale = paddle.scale # Added @ P11 これは「Paddle」ノードのscaleプロパティの初期値を格納しておく変数だ。パドルのサイズを元に戻すときに役に立つ。\nボールが画面から消えた時にパドルの長さを初期値に戻す 次に_on_Ball_tree_exitedメソッドにコードを1行追加した。\n# Method receiving Ball signal func _on_Ball_tree_exited(): var ball_count = 0 for child in get_children(): if child.is_in_group(\"Balls\"): ball_count += 1 if ball_count \u003c= 0: life -= 1 update_hud_life() if life \u003c= 0: get_tree().change_scene(\"res://scene/GameOverView.tscn\") else: for child in get_children(): if child.is_in_group(\"PowerupItems\"): child.queue_free() paddle.position = paddle_position paddle.scale = paddle_scale # 追加 add_new_ball() 追加したのはif / else構文のelseブロックのpaddle.scale = paddle_scaleという1行だ。このメソッドはボールが画面下に落ちた時にシグナルによって実行される。この時、ライフがまだ残っている状態では、パドルを初期位置に戻すついでに、「Expand」で2倍に伸びていたサイズも元に戻すようにしているのだ。\nレベルをクリアしたらパドルの長さを初期値に戻す 次にset_next_levelメソッドにコードを1行追加した。\nfunc set_next_level():\t#（中略） # Set Paddle and Ball the first position paddle.position = paddle_position paddle.scale = paddle_scale # 追加 add_new_ball() # Set next Level node add_new_level() # Pause game until NextScreen is hidden get_tree().paused = true このメソッドは、すべてのブロックを消してそのレベルをクリアした時に実行されるメソッドだが、その中で「Paddle」ノードの位置を初期値に戻すコードを実行しているので、その次にサイズも初期値に戻すコードを追加した。これで、パドルサイズが2倍になっている状態でレベルをクリアしても、次のレベルでは通常サイズに戻ることになる。\nパドルの長さを 10 秒間 2 倍にするメソッドを定義する そして次に、expand_paddleメソッドを新たに追加した。\nfunc expand_paddle(): # 追加 if paddle.scale \u003c= paddle_scale: paddle.scale.x *= 2 yield(get_tree().create_timer(10), \"timeout\") paddle.scale = paddle_scale このメソッドは、「Expand」のパワーアップ機能そのものだ。if構文で、パドルのscaleプロパティが初期値だったら、scaleプロパティ（Vector2型）の x 要素を2倍にするようにしている。\nさらにyieldでワンショットタイマーを10秒でセットし、タイムアウトしたタイミングでまたscaleプロパティを初期値に戻すようにしている。つまり、これで10秒間だけパドルが長くなる機能を実装しているのだ。\nこのメソッドは冒頭のif構文により、すでにパドルが伸びている状態で「Expand」アイテムをゲットしても効果や秒数が追加されないようにしている。\nExpand が有効になったら expand_paddle メソッドを実行するようにする そして、今作成したexpand_paddleメソッドを、_on_Powerup_item_collidedメソッドのmatchブロック内で、衝突したアイテムが1（つまり enum Powerup.EXPAND）と一致した場合に実行されるように追加した。\nfunc _on_Powerup_item_collided(item): # Updated @ P11 match item: 0: # SLOW slow_balls() 1: # EXPAND expand_paddle() 2: # MULTIPLE print(\"Game: \", item) 3: # LASER print(\"Game: \", item) 4: # LIFE print(\"Game: \", item) プロジェクトを実行して動作確認 ではプロジェクトを実行して、「EXPAND」機能が以下の条件で実装できているか確認しておこう。\n伸びた後の長さは通常の2倍 長さが元に戻るまでの時間は 10 秒 長さが元に戻るまでは何回「Expand」アイテムと衝突しても長さは伸びない 長さが元に戻るまでの時間は何回「Expand」アイテムと衝突しても増えない ボールが落ちたり、ブロックをすべて消してレベルをクリアしたら通常の長さに戻る パワーアップ「Multiple」を実装する 次はパワーアップ「Multiple」を実装していく。このパワーアップの具体的な仕様は以下のようにしていく。\n3秒間、複数のボールを発射できるようにする。 無効になるまでの3秒間で、新たにこのパワーアップアイテムと衝突しても時間は加算されない。 3秒後、新しくボールを発射することはできなくなるが、発射済みのボールが強制的に消されることはない。 では「Game.gd」スクリプトを編集していこう。\n変数 is_multiple_on を追加する 新しい変数is_multiple_onを定義した。\nvar is_multiple_on = false # 追加 これは Bool 値をとり、初期値はfalseとする。これは、パワーアップ「Multiple」が有効かどうかの情報を保持する変数だ。「Multiple」アイテムと衝突したらtrueになるように別途コーディングする。\nenable_multiple_balls メソッドを追加する 次にパドルが「Multiple」アイテムと衝突した時に実行する新しいメソッドenable_multiple_ballsを追加した。\nfunc enable_multiple_balls(): # 追加 if not is_multiple_on: add_new_ball() is_multiple_on = true yield(get_tree().create_timer(3), \"timeout\") is_multiple_on = false このメソッドの中身はif構文になっていて、さきほど適宜した変数is_multiple_onがfalseだったら、という条件定義だ。これに当てはまる場合、以下の処理を順番に実施していく。\nadd_new_ballメソッドで、新しいボールを1つだけパドルの上に生成する is_multiple_onをtrueにする yieldで3秒間のワンショットタイマーを作成し、タイムアウトまで次のコードを待機させる タイムアウトしたら、再び変数is_multiple_onをfalseに戻す Multiple が有効になったら enable_multiple_balls メソッドを実行するようにする さきほど定義したenable_multiple_ballsメソッドをドロップした「Multiple」アイテムとパドルが衝突した時に実行したい。そのためには、_on_Powerup_item_collidedメソッドのmatchブロック内で、引数item（衝突したアイテム）が2（Multiple）だった場合に実行されるコードとして追加すれば良い。コードは以下のようになる。\nfunc _on_Powerup_item_collided(item): # Updated @ P11 match item: 0: # SLOW slow_balls() 1: # EXPAND expand_paddle() 2: # MULTIPLE enable_multiple_balls() 3: # LASER print(\"Game: \", item) 4: # LIFE print(\"Game: \", item) _process メソッドでキー入力で複数のボールを発射できるようにする enable_multiple_ballsメソッドはパドルの上に1つだけボールを追加するが、その後、複数のボールを発射可能にする処理はまた別で記述していく必要がある。それが以下_processメソッドのコードだ。\nfunc _process(_delta): # 追加 if is_multiple_on and Input.is_action_just_pressed(\"launch_ball\"): add_new_ball() このメソッドは毎フレーム実行されることは以前に説明済みかもしれない。今回このメソッド内はif構文になっている。以下の2つの条件が揃った時にadd_new_ballメソッドが実行される。\n変数is_multiple_onがtrueであること インプットマップに登録された「launch_ball」アクションに当てはまるキー入力がされたこと これで、パドルが「Multiple」アイテムに衝突してから3秒間は「space」キーを押すたびに新しいボールを発射できるようになった。\nプロジェクトを実行して動作確認 ではパワーアップ「Multiple」がうまく実装できたか確認してみよう。\nパワーアップアイテム「Multiple」がパドルに衝突したら、パドルの上に1つボールが追加された そこから3秒間、spaceキーを連打した分だけボールが連射された 3秒後に連射機能は無効になり、画面上に発射したボールだけが残った 一番最初のボールが落ちても、他のボールが残っているのでライフは減らない もし3秒という時間がしっくりこない場合は、お好みで適宜調整していただければと思う。\nパワーアップ「Laser」を実装する ドロップしたパワーアップアイテム「Laser」と衝突後、一定時間、レーザービームを発射できるようにする。具体的な仕様は以下のようにする。\n3秒間パドルからレーザーを打ち放題になる レーザーがブロックに当たるとレーザーとブロックの両方が消える レーザーが画面外に出た場合はレーザーのインスタンスが消去される ブロックをすべて消してそのレベルをクリアすると、残ったレーザーは消える（次のレベルに持ち越さない） 発射されるレーザーオブジェクトは「Game」シーンに複数現れては消えることになる。ということは雛形となる「Laser」シーンを先に作成し、「Game」シーンではそのインスタンスをノードとして追加したり削除したりすれば良い。\n「Laser」シーンを作る 「Game」シーンにレーザーを登場させるためには、その雛形となるシーンを新たに作成する必要がある。そのインスタンスを「Game」シーンにノードとして追加していくパターンだ。\nシーンを新規作成する それではシーンを新しく作成していく。例によって、「シーン」メニュー＞「新規シーン」から開始しよう。\nまずは「Area2D」クラスのノードをルートノードとして追加する。この時点でシーンを保存しておこう。ファイル名はそのまま「Laser.tscn」で問題ない。\n続いて子ノードを追加していく。\n子ノードを追加する 「Laser」ノードに以下の3つのノードを追加しよう。\nLine2D CollisionShape2D VisibilityNotifier2D 追加したら、次はそれぞれのノードをインスペクタドックやノードドックで編集していく。\nLaser ノードを新しいグループに追加する まず、ルートノードの「Laser」については、プロパティはデフォルトのままで良いが、ノードグループを新たに作成して追加しておこう。ノードドック＞グループから「Lasers」の名前でグループを作成して追加する。\nこれは、画面上に複数のレーザーが表示されている状況で、まとめてそれらに対して処理を施す場合にとても便利になる。これまでも「Ball」シーンや「Brick」シーンで利用してきた手法だ。\nコリジョンレイヤーの設定 「Laser」ノード用のコリジョンレイヤーがまだないので、設定していく。まずは「プロジェクト」メニュー＞「プロジェクト設定」＞「一般」タブ＞サイドバーから「2d physics」を開く。次に「Layser 6」に「Laser」と言う名前をつける。\n次にシーンドックで「Laser」ノードを選択し、インスペクタで「Collision」プロパティを編集する。「Layer」がそのノードが属するレイヤー、「Mask」は衝突反応を有効にするレイヤーだ。\nまずは「Layer」プロパティで「Laser」レイヤーを選択、続いて「Mask」プロパティはブロックだけ衝突して欲しいので「Brick」レイヤーのみを選択した。\nLine2D ノードのプロパティを編集する 次にインスペクタドックで「Line2D」ノードのプロパティを編集する。\nまず「Points」プロパティの値になっている「PoolVector2Array(size 0)」をクリックしよう。すると、「サイズ」を調整できるので 2 に変更してみると、「Line2D」の線にポイントが追加される。折線にする場合は、この「サイズ」を複数追加して、それぞれのポイントの座標を指定するわけだ。今回は短い直線でレーザービームを表現するため、ポイント 0 の座標を(0, 0)、ポイント 1 の座標を(0, -24)にする。すると(0, 0)から真っ直ぐ上に長さが - 24 ピクセルの直線ができるはずだ。\n続いてプロパティ「Width」は 4 ピクセルを指定してやや細いレーザーにする。「Default Color」は「77bfff」でちょっと水色っぽい青を指定する。このあたりはお好みで調整して欲しい。\nそして「Capping」カテゴリの「Joint Mode」プロパティについて。これは線のポイントがもっと複数ある場合に、ポイントとポイントをどのような形状でつなぐかを指定する。今回はポイントが 2 つしかないのでデフォルトの「Sharp」ままにしておく。「Begin Cap Mode」と「End Cap Mode」はどちらも「Round」にして、線の両端を丸い形状にしておこう。\nCollisionShape2D ノードのプロパティを編集する 例によってインスペクタドックにて「Shape」プロパティを編集する。今回は「CapsuleShape2D」を選択しよう。続けて 2D ワークスペースで、ハンドルをドラッグして、さっき作った「Line2D」ノードと全く同じ形にしてきれいに重なるように調整しよう。調整するときはツールバーで「ピクセルスナップを使用」を有効にすると作業しやすくなる。\nVisibilityNotifier2D ノードのプロパティを編集する このゲーム開発では2回目の登場である「VisibilityNotifier2D」ノードは、ノードが画面外に出た時にそれを検知してシグナルを発信することができる。これを利用して、レーザーが画面外に出たらそのレーザーのノードを開放するのが狙いだ。\nこちらのノードも「Rect」プロパティを他のノードのサイズに合わせる形で以下の通りに調整していく。\nx: -2 y: -26 w: 4 h: 28 2D ワークスペースを見ながら枠が他のノードと一致しているか確認しておこう。\nインスペクタドックでの編集作業は一旦これで終わりだ。\nスクリプトでレーザーを動かす インスペクタで調整しきれない部分はスクリプトで制御していく。特にレーザーの動きの部分だ。\nではここで「Laser」ノードにスクリプトをアタッチする。スクリプトファイルは「res://scripts/Laser.gd」として保存しておく。\nスクリプトに以下のコードを記述する。\nextends Area2D export (float) var laser_speed = 500 func _physics_process(delta): position += Vector2.UP * laser_speed * delta まずlaser_speedという変数を定義している。これは名前の通り、レーザーの速度だ。500 ピクセル/秒とした。exportキーワードでインスペクタドックでも編集できるようにした。\n続いて、_physics_processメソッドを定義した。\nやっていることは、単純にpositionプロパティを毎フレーム変更して上方向に移動させているだけである。細かく分解すると、まずVector2.UPと言うのは方向だけを示した長さが 1 のベクトルで（0, -1）にあたる。これはゲーム画面上で真っ直ぐ上の方向だ。これがレーザーの飛んでいく向きを決めている。これにさっき定義したlaser_speedを乗じて方向を持った速度にし、さらにdeltaを乗じることで、1フレーム当たりの移動距離を計算している。最終的にこれを現在のpositionプロパティの値に加算して、positionそのものを更新している。\nシーンを実行して動作を確認する ここで一度、ルートノードを画面の中央下部のあたりに一時的に移動させて、動作確認しておこう。\nレーザーの速度が早いと感じたら、適宜プロパティ「laser_speed」を小さくして確認してみて欲しい。\nシグナルを接続する 「Game.tscn」シーンに、「Laser」シーンのインスタンスノードを追加するにあたって、以下の2つのシグナルが必要になる。\nブロックに衝突した時に発信するシグナル 画面外に出た時に発信するシグナル ではシグナルを接続していこう。\nまずは「Laser」ルートノードの「body_entered」というシグナルを「Laser.gd」スクリプトに接続しよう。そして、接亜属先のメソッド_on_body_entered(body)を編集していこう。\nfunc _on_body_entered(body): if body.is_in_group(\"Bricks\"): body.queue_free() queue_free() メソッドの内容は『もし衝突したのが「Bricks」グループのメンバーだったら、ブロックを消す、そしてレーザー自身も消す』という内容になっている。\n次は「VisibilityNotifier2D」ノードのシグナル「screen_exited」というシグナルを「Laser.gd」スクリプトに接続しよう。接続先のメソッド_on_VisibilityNotifier2D_screen_exitedを編集していく\nfunc _on_VisibilityNotifier2D_screen_exited(): queue_free() このメソッドでやるべきことは、画面外に出たレーザーを消すことだ。つまりqueue_freeメソッドを実行するのみである。余計なメモリを消費させないためにも、不要なオブジェクトはできるだけ速やかに消した方がいい。\nこれで「Laser_tscn」シーンの編集は完了だ。シーンドックは以下のようになっているだろう。\nGame シーンにパワーアップ Laser の機能を実装する ここからは「Game」シーンにパワーアップアイテム「Laser」の機能を追加していく。やるべきことは「Multiple」の時と似たようなものなので、楽な気持ちで進めていこう。\nそれでは「Game.gd」スクリプトを開いて順番にアップデートしていこう。\n今 Laser が有効かどうかを示す変数を追加する 以下の変数を追加する。\nvar is_laser_on = false この変数is_laser_onがfalseの間はパワーアップ「Laser」が無効の状態、trueの場合は有効の状態を示すものとして定義した。\nLaser シーンの PackedScene ファイルを Preload する 次はlaserという変数で、preloadした「Laser.tscn」の PackedScene ファイルを値として定義する。\nonready var laser = preload(\"res://scene/Laser.tscn\") preloadしたファイルからレーザーのインスタンスを複数生成することになるため、変数を定義しておくと便利だ。\nLaser が有効になったら enable_laser メソッドを実行するようにする この_on_Powerup_item_collidedメソッドはパワーアップアイテムがパドルに衝突した時のシグナルによって実行され、match構文によって、アイテムの種類ごとに異なる処理を実行する。\nfunc _on_Powerup_item_collided(item): # Updated @ P11 match item: 0: # SLOW slow_balls() 1: # EXPAND expand_paddle() 2: # MULTIPLE enable_multiple_balls() 3: # LASER enable_laser() # 追加 4: # LIFE print(\"Game: \", item) パワーアップアイテムが「Laser」だった場合は、enable_laserというメソッドを実行している。続いて、このメソッドを定義しよう。\nenable_laser メソッドでパワーアップ Laser を有効にする処理を実装する こちらが新たに定義したメソッドenable_laserだ。\nfunc enable_laser(): if not is_laser_on: is_laser_on = true print(\"is laser on\") # デバッグ用 yield(get_tree().create_timer(3), \"timeout\") is_laser_on = false print(\"is laser off\") # デバッグ用 このメソッドはまず全体が一つのifブロックになっていて、is_laser_onがfalseの場合のみ実行され、trueの場合は何もせずに終了する。ではif構文がtrueだった場合に実行される処理を見ていこう。\nまずis_laser_on = trueのコードでis_laser_onをtrueに変更する。trueの間だけレーザーを好きなだけ発射できるように別のメソッドで実装するが、このメソッドではとにかくこの変数の値を変更してステータス管理のみを行う。yieldで3秒間のタイマーをセットし、タイムアウトしたらis_laser_on = falseで、また「Laser」機能が無効の状態に戻るようにしている。\n次は、先に作っていおいた「Laser.tscn」シーンのインスタンスを作成して「Game」シーンに追加するメソッドを定義していく。\nfire_laser メソッドでレーザーを発射できるようにする 以下のようにfire_laserというメソッドを定義しよう。\nfunc fire_laser(): var instance = laser.instance() call_deferred(\"add_child\", instance) call_deferred(\"move_child\", instance, 6) instance.position.x = paddle.position.x instance.position.y = paddle.position.y - 16 やっていることはボールの追加と同様で、以下の通りである。\npreloadしておいた「Laser.tscn」ファイルのインスタンスの作成する 作成したインスタンスをadd_childで「Game」ルートノードの子にする 「Game」ルートノードの子ノード内の順番を6番目に変更する インスタンスのpositionプロパティの x 座標を「Paddle」のそれと同じにする インスタンスのpositionプロパティの y 座標を「Paddle」より 16 ピクセル上にする 「Laser」ノードは生成された瞬間から、それ自身がqueue_freeで消されるまで、画面の上方向へ飛んでいく。\nこのfire_laserメソッドが実行されるのは、プレイヤーがキー入力した時だけにしたい。そこで「Multiple」の時と同様に_process内にInputのメソッドを使って記述していく。\n_process メソッドでキー入力によるレーザー発射を実装する _processメソッドにはすでに、パワーアップ「Multiple」でボールを複数連射するコードが2行あるので、その下に記述していく。\nfunc _process(_delta): if is_multiple_on and Input.is_action_just_pressed(\"launch_ball\"): add_new_ball() if is_laser_on and Input.is_action_just_pressed(\"ui_up\"): # 追加 fire_laser() レーザーはインプットマップにデフォルトで登録されている「ui_up」アクションのキー操作で発射されることにした。「ui_up」に割り当てられているのはキーボードの「上矢印」キーだ。キーを叩いただけレーザーが発射される。\nここまでの内容を少しまとめておこう。\nパワーアップアイテムがパドルと衝突すると_on_Powerup_item_collidedメソッドが呼ばれる パワーアップアイテムが「Laser」だった場合、_on_Powerup_item_collidedメソッド内でenable_laserメソッドが呼ばれる enable_laserメソッド内で、変数is_laser_onが3秒間だけtrueになる 変数is_laser_onがtrueの間だけ上矢印キーが入力をされるたびに_processメソッド内でfire_laserメソッドが呼ばれる fire_laserメソッドにより「Laser.tscn」シーンのインスタンスが生成され、レーザーが発射される set_next_level のブロックをすべて消した時にレーザーも全て消す処理を追加する ではset_next_levelに処理を追加していく。\nfunc set_next_level(): print(\"set_next_level() called\") # Change status is_playing = false print(\"is_playing: \", is_playing) # Clear left objects level.queue_free() print(\"level.queue_free() called\") for child in get_children(): if child.is_in_group(\"Balls\") or child.is_in_group(\"Lasers\"): # 追加 child.queue_free() #（後略） コメントで「# 追加」と記載しているところが変更点だ。\nブロックをすべて消して、次の新しいレベルの諸々の準備をする前に、「Game」ノードの子ノードをチェックする。その時、「Balls」グループと一緒に「Lasers」グループもチェックして、グループに属するノードが残っていれば、すべて消すようにした。\nプロジェクトを実行して動作確認する 他のアイテムがドロップすると確認の効率が悪いので、「Powerup/gd」スクリプトのadd_sprite_framesメソッドを以下のように一時的に編集してからプロジェクトを実行しよう。\nパワーアップ「Life」を実装する 最後はパワーアップ「Life」の機能を実装する。ここまでやってきた他のパワーアップアイテムに比べてかなり簡単な作業なので気楽にやっていこう。\n定数でライフの上限を設定する MAX_LIFEという定数を定義しよう。\nconst MAX_LIFE = 5 UI上、ライフは5つまでしか表示できないようにしているので、その上限をスクリプト上で設定する必要がある。変わることがない値なので、変数ではなく定数としてキーワードconstを使って定義した。\n上限に達してなければライフが1つ増えるメソッドを作る 単純にライフが 1 増えるメソッドを定義しよう。名前はadd_lifeにする。\nfunc add_life(): if life \u003c MAX_LIFE: life += 1 update_hud_life() if構文で、変数lifeの現在の値が先ほど定義した定数MAX_LIFEの値5より小さければ、ライフを 1 増やす処理をしている。変数の値だけ増えてもプレイヤーはわからないので、update_hud_lifeメソッドで、HUDのライフの表示も更新させている。\nLife が有効になったら add_life メソッドを実行するようにする パワーアップアイテム「Life」とパドルが衝突したら、add_lifeメソッドを実行するように、_on_Powerup_item_collidedメソッドのmatch構文を編集していこう。\nmatchブロック内で、引数item（衝突したアイテム）が4（LIFE）だった場合に実行されるコードとして追加すれば良い。コードは以下のようになる。\nfunc _on_Powerup_item_collided(item): match item: 0: # SLOW slow_balls() 1: # EXPAND expand_paddle() 2: # MULTIPLE enable_multiple_balls() 3: # LASER enable_laser() 4: # LIFE add_life() # 追加 パワーアップ「Life」の実装はこれだけだ。とても簡単だったのではないだろうか。\nプロジェクトを実行して動作確認する では、最後にライフ追加の機能がきちんと実装されているかどうかチェックをしておこう。\nドロップした「Life」アイテムにパドルが衝突したらライフが 1 増えること ライフが 5 の場合はそれ以上増えないこと 全体を通して 最後に全体を通して調整と確認をしておこう。\n細かなバグの修正 この時点で確認できた細かなバグを修正する。\n「Multiple」「Laser」が残るバグを修正する 2021/12/23 追加 ボールが画面上からすべて消えた時やレベルをクリアして次のレベルに切り替わった時に、まだ「Multiple」のボールや「Laser」のビームが残っていることがある。これはパワーアップが有効な 3 秒の時間がまだ残っている場合に発生する。\n「Game.gd」スクリプトを以下のように編集する。\nfunc _on_Ball_tree_exited(): print(\"_on_Ball_tree_exited() called\") #（中略） if no_ball: # Added and Edited @ P11 #（中略） # Set Paddle and Balls as default is_multiple_on = false # 追加 is_laser_on = false # 追加 paddle.position = paddle_position paddle.scale = paddle_scale add_new_ball() まずはボールが画面上から消えた時に実行される_on_Ball_tree_exitedメソッドだ。if no_ballのブロックで、ボールが画面上からすべて無くなったら、という条件の下、is_multiple_on = falseおよびis_laser_on = falseの処理により、「Multiple」や「Laser」の有効時間3秒がまだ残っていても、強制的に無効になるようにした。\nfunc set_next_level(): print(\"set_next_level() called\") # Change status is_playing = false is_multiple_on = false # 追加 is_laser_on = false # 追加 #（後略） 続いて編集するのは、次のレベルに切り替えるためのset_next_levelメソッドだ。これも先ほどと考え方は同様で、メソッドが呼ばれたらすぐにis_multiple_on = falseおよびis_laser_on = falseの処理で、「Multiple」と「Laser」を無効化している。\nボール生成時に一瞬だけ x 座標 0 に表示されるバグを修正する 2021/12/23 追加 最後に、「Multiple」が有効な時に、ボールが生成される一瞬だけ、その新しいボールが x 座標0の位置に見える現象を修正する。\nまずは「Ball.tscn」を開き、インスペクタで「Ball」ルートノードの「Position」プロパティをデフォルトの(0, 0)に戻そう。\nあとは念の為程度の修正だが、再度「Game.gd」スクリプトを見てほしい。\nfunc add_new_ball(): # Added @ P11 print(\"add_new_ball() called\") var instance = ball.instance() instance.position = Vector2(paddle.position.x, paddle.position.y - 10) # 追加 call_deferred(\"add_child\", instance) call_deferred(\"move_child\", instance, 4) instance.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\")\t#instance.mode = 3 # 削除 修正するのはadd_new_ballメソッドだ。\ninstance.position = Vector2(paddle.position.x, paddle.position.y - 10)のコードを1行、インスタンス生成直後に追加した。これでボールの x 座標が画面に表示されるタイミングからパドルのそれに一致するようになる。\nついでにinstance.mode = 3のコードは、元々インスタンス生成時に3になっており不要だったので削除した。\nアイテムのドロップ率を通常に戻す アイテムのドロップ率を1にしていた。これは100%という意味だ。パワーアップアイテムのデバッグを終えたので、通常のドロップ率に戻そう。お好みで0.5~0.25の間くらいで適当に調整しておこう。\nGame.gd スクリプト全体の確認 「Game.gd」スクリプトの全体が最終的にどうなったのか、念の為、最後にここで公開しておく。確認されたい方は展開して確認していただければ結構だ。\n「Game.gd」スクリプト全体のコード extends Node2D const POINT = 100 const MAX_LIFE = 5 # Added @ P11 export var drop_rate = 0.2 var level_num = 1 var score = 0 var bonus_rate = 1.0 var life = 3 var is_playing = true var is_multiple_on = false # Added @ P11 var is_laser_on = false # Added @ P11 #onready var level = $Level1 # Removed @ P11 onready var next_screen = $NextScreen onready var next_screen_level = $NextScreen/VBox/Level onready var next_screen_score = $NextScreen/VBox/Score onready var next_screen_life = $NextScreen/VBox/HBox/Life onready var hud_level = $HUD/LeftBox/Level onready var hud_score = $HUD/LeftBox/Score onready var hud_rightbox = $HUD/RightBox onready var paddle = $Paddle #onready var ball = $Ball # Removed @ P11 onready var pause_screen = $PauseScreen onready var paddle_position = paddle.position onready var paddle_scale = paddle.scale # Added @ P11 #onready var ball_position = ball.position # Removed @ P11 onready var ball = preload(\"res://scene/Ball.tscn\") # Added @ P11 onready var laser = preload(\"res://scene/Laser.tscn\") # Added @ P11 onready var powerup = preload(\"res://scene/Powerup.tscn\") # Added @ P10 onready var level = null # Updated @ P11 func _ready(): randomize() # Added @ P10 add_new_level() # Added @ P11 add_new_ball() # Added @ P11 update_hud_life() # For debug #leave_one_brick(43) # Moved @ P11 #ball.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\") # Removed @ P11 #for brick in level.get_children(): # Removed @ P11 #brick.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\", [brick.global_position]) # Updated @ P10 func _process(_delta): # Added @ P11 if is_multiple_on and Input.is_action_just_pressed(\"launch_ball\"): add_new_ball() if is_laser_on and Input.is_action_just_pressed(\"ui_up\"): fire_laser() # For debug func leave_one_brick(brick_num: int): for child in level.get_children(): if child.get_name() == \"Brick\" + str(brick_num): continue child.queue_free() # Method receiving Ball signal func _on_Ball_tree_exited(): print(\"_on_Ball_tree_exited() called\") var no_ball = true # Added @ P11 for child in get_children(): # Added @ P11 if child.is_in_group(\"Balls\"): print(\"found ball\") no_ball = false break if no_ball: # Added and Edited @ P11 if is_playing: life -= 1 if life \u003c= 0: get_tree().change_scene(\"res://scene/GameOverView.tscn\") else: update_hud_life() life_down_sound.play() else: is_playing = true # Clear powerup items for child in get_children(): # Added @ P10 if child.is_in_group(\"PowerupItems\"): child.queue_free() # Set Paddle and Balls as default is_multiple_on = false # Added @ P11 is_laser_on = false # Added @ P11 paddle.position = paddle_position paddle.scale = paddle_scale # Added @ P11 add_new_ball() # Added @ P11 #ball = load(\"res://scene/Ball.tscn\").instance() # Removed @ P11 #call_deferred(\"add_child\", ball) # Removed @ P11 #call_deferred(\"move_child\", ball, 3) # Removed @ P11 #ball.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\") # Removed @ P11 # Set life nodes shown and hidden as life variable func update_hud_life(): var count = 0 for child in hud_rightbox.get_children(): count += 1 if count \u003c= life: child.show() else: child.hide() # Add a new ball func add_new_ball(): # Added @ P11 print(\"add_new_ball() called\") var instance = ball.instance() instance.mode = 3 # Fixed the order @ P11 call_deferred(\"add_child\", instance) call_deferred(\"move_child\", instance, 4) instance.connect(\"tree_exited\", self, \"_on_Ball_tree_exited\")\t# Method receiving Brick signal func _on_Brick_tree_exited(brick_position): # Update Score score += POINT * bonus_rate bonus_rate += 0.1 hud_score.text = \"Score: \" + str(score) # Exit current Level node if level.get_child_count() \u003c= 0: set_next_level() else: # Added @ P11 # Drop powerup item drop_powerup(brick_position) # Added @ P10 func drop_powerup(brick_position: Vector2): # Added @ P10 if randf() \u003c= drop_rate: var powerup_instance = powerup.instance() powerup_instance.position = brick_position call_deferred(\"add_child\", powerup_instance) call_deferred(\"move_child\", powerup_instance, 5) # Added @ P 11 powerup_instance.connect(\"item_collided\", self, \"_on_Powerup_item_collided\") # Action when powerup item collided func _on_Powerup_item_collided(item): # Updated @ P11 match item: 0: # SLOW slow_balls() 1: # EXPAND expand_paddle() 2: # MULTIPLE enable_multiple_balls() 3: # LASER enable_laser() 4: # LIFE add_life() # slow balls func slow_balls(): # Added @ P11 for child in get_children(): if child.is_in_group(\"Balls\"): child.ball_speed = child.first_speed # Stretch paddle func expand_paddle(): # Added @ P11 if paddle.scale \u003c= paddle_scale: paddle.scale.x *= 2 yield(get_tree().create_timer(10), \"timeout\") paddle.scale = paddle_scale # enable powerup Multiple func enable_multiple_balls(): # Added @ P11 if not is_multiple_on: is_multiple_on = true yield(get_tree().create_timer(3), \"timeout\") is_multiple_on = false # enable powerup Laser func enable_laser(): # Added @ P11 if not is_laser_on: is_laser_on = true yield(get_tree().create_timer(3), \"timeout\") is_laser_on = false # fire laser beam func fire_laser(): var instance = laser.instance() call_deferred(\"add_child\", instance) call_deferred(\"move_child\", instance, 6) instance.position.x = paddle.position.x instance.position.y = paddle.position.y - 16 # Add a life if less than 5 func add_life(): # Added @ P11 if life \u003c MAX_LIFE: life += 1 update_hud_life() # set next level func set_next_level(): print(\"set_next_level() called\") # Change status is_playing = false is_multiple_on = false # Added @ P11 is_laser_on = false # Added @ P11 # Clear left objects level.queue_free() for child in get_children(): if child.is_in_group(\"Balls\") or child.is_in_group(\"Lasers\"): # 追加 child.queue_free() # Increment level number level_num += 1 # Stop PauseScreen node pause_screen.pause_mode = 1 # Show NextScreen node next_screen.pause_mode = 2 next_screen_level.text = \"Level: \" + str(level_num) next_screen_score.text = \"Score: \" + str(score) next_screen_life.text = \"x \" + str(life) next_screen.show() # Set Level of HUD the next level hud_level.text = \"Level: \" + str(level_num) # Set Paddle and Ball the first position #paddle.position = paddle_position # Removed @ P11 #paddle.scale = paddle_scale # Removed @ P11 #ball.position = ball_position # Removed @ P11 #ball.mode = 3 # Removed @ P11 # Set next Level node add_new_level() # Added @ P11 #level = load(\"res://scene/Level\" + str(level_num) + \".tscn\").instance() # Removed @ P11 #add_child(level) # Removed @ P11 #move_child(level, 5) # Removed @ P11 #for child in level.get_children(): # Removed @ P11 #child.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\") # Removed @ P11 # Pause game until NextScreen is hidden get_tree().paused = true # Add new level func add_new_level(): # Added @ P11 level = load(\"res://scene/Level\" + str(level_num) + \".tscn\").instance() add_child(level) move_child(level, 3) # Changed from 5 to 3 @ P11 for child in level.get_children(): child.connect(\"tree_exited\", self, \"_on_Brick_tree_exited\", [child.global_position]) # Updated to add th 4th arg @ P11 func _on_PauseScreen_visibility_changed(): play_bgm.stream_paused = not play_bgm.stream_paused おわりに 以上で Part 11 は完了だ。今回はパワーアップアイテムを取得した後の個々のパワーアップ機能を実装した。特に「Laser」の実装はかなりボリュームがあり、また全体を通しても、相当な長文になっている。無理に1日で終える必要はなく、適宜日にちを分けてチャレンジして欲しい。\nPart 10、11 とパワーアップ機能の話であったが、次の Part 12 ではブロック崩しに BGM とサウンドエフェクトを追加する。\n","wordCount":"19147","inLanguage":"ja","image":"https://www.peanuts-code.com/images/tutorials/gd0004_breakout/breakout_11/img_15.gif","datePublished":"2021-12-11T13:36:54+09:00","dateModified":"2021-12-11T13:36:54+09:00","author":{"@type":"Person","name":"Gobo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_11/"},"publisher":{"@type":"Organization","name":"Peanuts Code","logo":{"@type":"ImageObject","url":"https://www.peanuts-code.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.peanuts-code.com/ja/ accesskey=h title="Peanuts Code (Alt + H)"><img src=https://www.peanuts-code.com/images/logomark.png alt aria-label=logo height=35>Peanuts Code</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.peanuts-code.com/ja/ title=ホーム><span>ホーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/portfolio/ title=作ったゲーム><span>作ったゲーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/posts/ title=ブログ><span>ブログ</span></a></li><li><a href=https://www.peanuts-code.com/ja/tutorials/ title=チュートリアル><span>チュートリアル</span></a></li><li><a href=https://www.peanuts-code.com/ja/about/ title=サイト情報><span>サイト情報</span></a></li><li><a href=https://www.peanuts-code.com/ja/search/ title="検索 (Alt + /)" accesskey=/><span>検索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.peanuts-code.com/ja/>ホーム</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/tutorials/>🤖 チュートリアル</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/>🤖 シリーズ：Godot で作るブロック崩し</a></div><h1 class=post-title>Godot で作るブロック崩し Part 11：パワーアップを実装しよう！</h1><div class=post-meta><span title='2021-12-11 13:36:54 +0900 +0900'>2021-12-11</span>&nbsp;·&nbsp;39 分&nbsp;·&nbsp;Gobo</div></header><figure class=entry-cover><img loading=lazy src=https://www.peanuts-code.com/images/tutorials/gd0004_breakout/breakout_11/img_15.gif alt="ブロック崩し Part 11 サムネイル"></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e6%a9%9f%e8%83%bd%e3%81%ae%e3%81%9f%e3%82%81%e3%81%ae%e5%85%a8%e4%bd%93%e7%9a%84%e3%81%aa%e3%82%b3%e3%83%bc%e3%83%89%e6%9b%b4%e6%96%b0 aria-label=パワーアップ機能のための全体的なコード更新>パワーアップ機能のための全体的なコード更新</a><ul><ul><li><a href=#%e3%82%b7%e3%83%bc%e3%83%b3%e3%83%89%e3%83%83%e3%82%af%e3%81%8b%e3%82%89-ball-%e3%81%a8-level1-%e3%82%92%e5%89%8a%e9%99%a4%e3%81%99%e3%82%8b aria-label="シーンドックから Ball と Level1 を削除する">シーンドックから Ball と Level1 を削除する</a></li><li><a href=#onready-%e5%a4%89%e6%95%b0%e3%82%92%e8%bf%bd%e5%8a%a0%e5%89%8a%e9%99%a4%e3%81%99%e3%82%8b aria-label="onready 変数を追加・削除する">onready 変数を追加・削除する</a></li><li><a href=#_ready-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e6%9b%b4%e6%96%b0%e3%81%99%e3%82%8b aria-label="_ready メソッドを更新する">_ready メソッドを更新する</a></li><li><a href=#is_playing-%e5%a4%89%e6%95%b0%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="is_playing 変数を追加する">is_playing 変数を追加する</a></li><li><a href=#_on_ball_tree_exited-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e6%9b%b4%e6%96%b0%e3%81%99%e3%82%8b aria-label="_on_Ball_tree_exited メソッドを更新する">_on_Ball_tree_exited メソッドを更新する</a></li><li><a href=#add_new_ball-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="add_new_ball メソッドを追加する">add_new_ball メソッドを追加する</a></li><li><a href=#_on_brick_tree_exited-%e3%82%92%e6%9b%b4%e6%96%b0%e3%81%99%e3%82%8b aria-label="_on_Brick_tree_exited を更新する">_on_Brick_tree_exited を更新する</a></li><li><a href=#drop_powerup-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e6%9b%b4%e6%96%b0%e3%81%99%e3%82%8b aria-label="drop_powerup メソッドを更新する">drop_powerup メソッドを更新する</a></li><li><a href=#set_next_level-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e6%9b%b4%e6%96%b0%e3%81%99%e3%82%8b aria-label="set_next_level メソッドを更新する">set_next_level メソッドを更新する</a></li><li><a href=#add_new_level-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="add_new_level メソッドを追加する">add_new_level メソッドを追加する</a></li></ul></ul></li><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97slow%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label=パワーアップ「Slow」を実装する。>パワーアップ「Slow」を実装する。</a><ul><ul><li><a href=#%e6%96%b0%e3%81%97%e3%81%84%e3%83%8e%e3%83%bc%e3%83%89%e3%82%b0%e3%83%ab%e3%83%bc%e3%83%97balls%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%a6ball%e3%83%8e%e3%83%bc%e3%83%89%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label=新しいノードグループ「Balls」を作って「Ball」ノードを追加する>新しいノードグループ「Balls」を作って「Ball」ノードを追加する</a></li><li><a href=#%e3%83%9c%e3%83%bc%e3%83%ab%e3%81%ae%e3%82%b9%e3%83%94%e3%83%bc%e3%83%89%e3%82%92%e5%88%9d%e6%9c%9f%e5%80%a4%e3%81%ab%e6%88%bb%e3%81%99%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9a%e7%be%a9%e3%81%99%e3%82%8b aria-label=ボールのスピードを初期値に戻すメソッドを定義する>ボールのスピードを初期値に戻すメソッドを定義する</a></li><li><a href=#slow-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%9f%e3%82%89-slow_balls-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="Slow が有効になったら slow_balls メソッドを実行するようにする">Slow が有効になったら slow_balls メソッドを実行するようにする</a></li><li><a href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d aria-label=プロジェクトを実行して動作確認>プロジェクトを実行して動作確認</a></li></ul></ul></li><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97expand%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label=パワーアップ「Expand」を実装する>パワーアップ「Expand」を実装する</a><ul><ul><li><a href=#onready-%e5%a4%89%e6%95%b0%e3%81%a7%e3%83%91%e3%83%89%e3%83%ab%e3%81%ae%e6%9c%80%e5%88%9d%e3%81%ae%e9%95%b7%e3%81%95%e3%82%92%e5%ae%9a%e7%be%a9%e3%81%99%e3%82%8b aria-label="onready 変数でパドルの最初の長さを定義する">onready 変数でパドルの最初の長さを定義する</a></li><li><a href=#%e3%83%9c%e3%83%bc%e3%83%ab%e3%81%8c%e7%94%bb%e9%9d%a2%e3%81%8b%e3%82%89%e6%b6%88%e3%81%88%e3%81%9f%e6%99%82%e3%81%ab%e3%83%91%e3%83%89%e3%83%ab%e3%81%ae%e9%95%b7%e3%81%95%e3%82%92%e5%88%9d%e6%9c%9f%e5%80%a4%e3%81%ab%e6%88%bb%e3%81%99 aria-label=ボールが画面から消えた時にパドルの長さを初期値に戻す>ボールが画面から消えた時にパドルの長さを初期値に戻す</a></li><li><a href=#%e3%83%ac%e3%83%99%e3%83%ab%e3%82%92%e3%82%af%e3%83%aa%e3%82%a2%e3%81%97%e3%81%9f%e3%82%89%e3%83%91%e3%83%89%e3%83%ab%e3%81%ae%e9%95%b7%e3%81%95%e3%82%92%e5%88%9d%e6%9c%9f%e5%80%a4%e3%81%ab%e6%88%bb%e3%81%99 aria-label=レベルをクリアしたらパドルの長さを初期値に戻す>レベルをクリアしたらパドルの長さを初期値に戻す</a></li><li><a href=#%e3%83%91%e3%83%89%e3%83%ab%e3%81%ae%e9%95%b7%e3%81%95%e3%82%92-10-%e7%a7%92%e9%96%93-2-%e5%80%8d%e3%81%ab%e3%81%99%e3%82%8b%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9a%e7%be%a9%e3%81%99%e3%82%8b aria-label="パドルの長さを 10 秒間 2 倍にするメソッドを定義する">パドルの長さを 10 秒間 2 倍にするメソッドを定義する</a></li><li><a href=#expand-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%9f%e3%82%89-expand_paddle-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="Expand が有効になったら expand_paddle メソッドを実行するようにする">Expand が有効になったら expand_paddle メソッドを実行するようにする</a></li><li><a href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d-1 aria-label=プロジェクトを実行して動作確認>プロジェクトを実行して動作確認</a></li></ul></ul></li><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97multiple%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label=パワーアップ「Multiple」を実装する>パワーアップ「Multiple」を実装する</a><ul><ul><li><a href=#%e5%a4%89%e6%95%b0-is_multiple_on-%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="変数 is_multiple_on を追加する">変数 is_multiple_on を追加する</a></li><li><a href=#enable_multiple_balls-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="enable_multiple_balls メソッドを追加する">enable_multiple_balls メソッドを追加する</a></li><li><a href=#multiple-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%9f%e3%82%89-enable_multiple_balls-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="Multiple が有効になったら enable_multiple_balls メソッドを実行するようにする">Multiple が有効になったら enable_multiple_balls メソッドを実行するようにする</a></li><li><a href=#_process-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%a7%e3%82%ad%e3%83%bc%e5%85%a5%e5%8a%9b%e3%81%a7%e8%a4%87%e6%95%b0%e3%81%ae%e3%83%9c%e3%83%bc%e3%83%ab%e3%82%92%e7%99%ba%e5%b0%84%e3%81%a7%e3%81%8d%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="_process メソッドでキー入力で複数のボールを発射できるようにする">_process メソッドでキー入力で複数のボールを発射できるようにする</a></li><li><a href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d-2 aria-label=プロジェクトを実行して動作確認>プロジェクトを実行して動作確認</a></li></ul></ul></li><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97laser%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label=パワーアップ「Laser」を実装する>パワーアップ「Laser」を実装する</a><ul><li><a href=#laser%e3%82%b7%e3%83%bc%e3%83%b3%e3%82%92%e4%bd%9c%e3%82%8b aria-label=「Laser」シーンを作る>「Laser」シーンを作る</a><ul><li><a href=#%e3%82%b7%e3%83%bc%e3%83%b3%e3%82%92%e6%96%b0%e8%a6%8f%e4%bd%9c%e6%88%90%e3%81%99%e3%82%8b aria-label=シーンを新規作成する>シーンを新規作成する</a></li><li><a href=#%e5%ad%90%e3%83%8e%e3%83%bc%e3%83%89%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label=子ノードを追加する>子ノードを追加する</a></li><li><a href=#laser-%e3%83%8e%e3%83%bc%e3%83%89%e3%82%92%e6%96%b0%e3%81%97%e3%81%84%e3%82%b0%e3%83%ab%e3%83%bc%e3%83%97%e3%81%ab%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="Laser ノードを新しいグループに追加する">Laser ノードを新しいグループに追加する</a></li><li><a href=#%e3%82%b3%e3%83%aa%e3%82%b8%e3%83%a7%e3%83%b3%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label=コリジョンレイヤーの設定>コリジョンレイヤーの設定</a></li><li><a href=#line2d-%e3%83%8e%e3%83%bc%e3%83%89%e3%81%ae%e3%83%97%e3%83%ad%e3%83%91%e3%83%86%e3%82%a3%e3%82%92%e7%b7%a8%e9%9b%86%e3%81%99%e3%82%8b aria-label="Line2D ノードのプロパティを編集する">Line2D ノードのプロパティを編集する</a></li><li><a href=#collisionshape2d-%e3%83%8e%e3%83%bc%e3%83%89%e3%81%ae%e3%83%97%e3%83%ad%e3%83%91%e3%83%86%e3%82%a3%e3%82%92%e7%b7%a8%e9%9b%86%e3%81%99%e3%82%8b aria-label="CollisionShape2D ノードのプロパティを編集する">CollisionShape2D ノードのプロパティを編集する</a></li><li><a href=#visibilitynotifier2d-%e3%83%8e%e3%83%bc%e3%83%89%e3%81%ae%e3%83%97%e3%83%ad%e3%83%91%e3%83%86%e3%82%a3%e3%82%92%e7%b7%a8%e9%9b%86%e3%81%99%e3%82%8b aria-label="VisibilityNotifier2D ノードのプロパティを編集する">VisibilityNotifier2D ノードのプロパティを編集する</a></li><li><a href=#%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88%e3%81%a7%e3%83%ac%e3%83%bc%e3%82%b6%e3%83%bc%e3%82%92%e5%8b%95%e3%81%8b%e3%81%99 aria-label=スクリプトでレーザーを動かす>スクリプトでレーザーを動かす</a></li><li><a href=#%e3%82%b7%e3%83%bc%e3%83%b3%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e3%82%92%e7%a2%ba%e8%aa%8d%e3%81%99%e3%82%8b aria-label=シーンを実行して動作を確認する>シーンを実行して動作を確認する</a></li><li><a href=#%e3%82%b7%e3%82%b0%e3%83%8a%e3%83%ab%e3%82%92%e6%8e%a5%e7%b6%9a%e3%81%99%e3%82%8b aria-label=シグナルを接続する>シグナルを接続する</a></li></ul></li><li><a href=#game-%e3%82%b7%e3%83%bc%e3%83%b3%e3%81%ab%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97-laser-%e3%81%ae%e6%a9%9f%e8%83%bd%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label="Game シーンにパワーアップ Laser の機能を実装する">Game シーンにパワーアップ Laser の機能を実装する</a><ul><li><a href=#%e4%bb%8a-laser-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%8b%e3%81%a9%e3%81%86%e3%81%8b%e3%82%92%e7%a4%ba%e3%81%99%e5%a4%89%e6%95%b0%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="今 Laser が有効かどうかを示す変数を追加する">今 Laser が有効かどうかを示す変数を追加する</a></li><li><a href=#laser-%e3%82%b7%e3%83%bc%e3%83%b3%e3%81%ae-packedscene-%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%82%92-preload-%e3%81%99%e3%82%8b aria-label="Laser シーンの PackedScene ファイルを Preload する">Laser シーンの PackedScene ファイルを Preload する</a></li><li><a href=#laser-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%9f%e3%82%89-enable_laser-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="Laser が有効になったら enable_laser メソッドを実行するようにする">Laser が有効になったら enable_laser メソッドを実行するようにする</a></li><li><a href=#enable_laser-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%a7%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97-laser-%e3%82%92%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%99%e3%82%8b%e5%87%a6%e7%90%86%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label="enable_laser メソッドでパワーアップ Laser を有効にする処理を実装する">enable_laser メソッドでパワーアップ Laser を有効にする処理を実装する</a></li><li><a href=#fire_laser-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%a7%e3%83%ac%e3%83%bc%e3%82%b6%e3%83%bc%e3%82%92%e7%99%ba%e5%b0%84%e3%81%a7%e3%81%8d%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="fire_laser メソッドでレーザーを発射できるようにする">fire_laser メソッドでレーザーを発射できるようにする</a></li><li><a href=#_process-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%a7%e3%82%ad%e3%83%bc%e5%85%a5%e5%8a%9b%e3%81%ab%e3%82%88%e3%82%8b%e3%83%ac%e3%83%bc%e3%82%b6%e3%83%bc%e7%99%ba%e5%b0%84%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label="_process メソッドでキー入力によるレーザー発射を実装する">_process メソッドでキー入力によるレーザー発射を実装する</a></li><li><a href=#set_next_level-%e3%81%ae%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e3%82%92%e3%81%99%e3%81%b9%e3%81%a6%e6%b6%88%e3%81%97%e3%81%9f%e6%99%82%e3%81%ab%e3%83%ac%e3%83%bc%e3%82%b6%e3%83%bc%e3%82%82%e5%85%a8%e3%81%a6%e6%b6%88%e3%81%99%e5%87%a6%e7%90%86%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b aria-label="set_next_level のブロックをすべて消した時にレーザーも全て消す処理を追加する">set_next_level のブロックをすべて消した時にレーザーも全て消す処理を追加する</a></li><li><a href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d%e3%81%99%e3%82%8b aria-label=プロジェクトを実行して動作確認する>プロジェクトを実行して動作確認する</a></li></ul></li></ul></li><li><a href=#%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97life%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b aria-label=パワーアップ「Life」を実装する>パワーアップ「Life」を実装する</a><ul><ul><li><a href=#%e5%ae%9a%e6%95%b0%e3%81%a7%e3%83%a9%e3%82%a4%e3%83%95%e3%81%ae%e4%b8%8a%e9%99%90%e3%82%92%e8%a8%ad%e5%ae%9a%e3%81%99%e3%82%8b aria-label=定数でライフの上限を設定する>定数でライフの上限を設定する</a></li><li><a href=#%e4%b8%8a%e9%99%90%e3%81%ab%e9%81%94%e3%81%97%e3%81%a6%e3%81%aa%e3%81%91%e3%82%8c%e3%81%b0%e3%83%a9%e3%82%a4%e3%83%95%e3%81%8c1%e3%81%a4%e5%a2%97%e3%81%88%e3%82%8b%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e4%bd%9c%e3%82%8b aria-label=上限に達してなければライフが1つ増えるメソッドを作る>上限に達してなければライフが1つ増えるメソッドを作る</a></li><li><a href=#life-%e3%81%8c%e6%9c%89%e5%8a%b9%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%9f%e3%82%89-add_life-%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b aria-label="Life が有効になったら add_life メソッドを実行するようにする">Life が有効になったら add_life メソッドを実行するようにする</a></li><li><a href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%82%92%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d%e3%81%99%e3%82%8b-1 aria-label=プロジェクトを実行して動作確認する>プロジェクトを実行して動作確認する</a></li></ul></ul></li><li><a href=#%e5%85%a8%e4%bd%93%e3%82%92%e9%80%9a%e3%81%97%e3%81%a6 aria-label=全体を通して>全体を通して</a><ul><li><a href=#%e7%b4%b0%e3%81%8b%e3%81%aa%e3%83%90%e3%82%b0%e3%81%ae%e4%bf%ae%e6%ad%a3 aria-label=細かなバグの修正>細かなバグの修正</a><ul><li><a href=#multiplelaser%e3%81%8c%e6%ae%8b%e3%82%8b%e3%83%90%e3%82%b0%e3%82%92%e4%bf%ae%e6%ad%a3%e3%81%99%e3%82%8b aria-label=「Multiple」「Laser」が残るバグを修正する>「Multiple」「Laser」が残るバグを修正する</a><ul><ul><li><a href=#20211223-%e8%bf%bd%e5%8a%a0 aria-label="2021/12/23 追加">2021/12/23 追加</a></li></ul></ul></li><li><a href=#%e3%83%9c%e3%83%bc%e3%83%ab%e7%94%9f%e6%88%90%e6%99%82%e3%81%ab%e4%b8%80%e7%9e%ac%e3%81%a0%e3%81%91-x-%e5%ba%a7%e6%a8%99-0-%e3%81%ab%e8%a1%a8%e7%a4%ba%e3%81%95%e3%82%8c%e3%82%8b%e3%83%90%e3%82%b0%e3%82%92%e4%bf%ae%e6%ad%a3%e3%81%99%e3%82%8b aria-label="ボール生成時に一瞬だけ x 座標 0 に表示されるバグを修正する">ボール生成時に一瞬だけ x 座標 0 に表示されるバグを修正する</a><ul><ul><li><a href=#20211223-%e8%bf%bd%e5%8a%a0-1 aria-label="2021/12/23 追加">2021/12/23 追加</a></li></ul></ul></li></ul></li><li><a href=#%e3%82%a2%e3%82%a4%e3%83%86%e3%83%a0%e3%81%ae%e3%83%89%e3%83%ad%e3%83%83%e3%83%97%e7%8e%87%e3%82%92%e9%80%9a%e5%b8%b8%e3%81%ab%e6%88%bb%e3%81%99 aria-label=アイテムのドロップ率を通常に戻す>アイテムのドロップ率を通常に戻す</a></li><li><a href=#gamegd-%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88%e5%85%a8%e4%bd%93%e3%81%ae%e7%a2%ba%e8%aa%8d aria-label="Game.gd スクリプト全体の確認">Game.gd スクリプト全体の確認</a></li></ul></li><li><a href=#%e3%81%8a%e3%82%8f%e3%82%8a%e3%81%ab aria-label=おわりに>おわりに</a></li></ul></div></details></div><div class=post-content><p>Part 11 の今回は、ブロック崩しにパワーアップ機能を実装していく。前回の Part 11 でブロックを消すとパワーアップアイテムが落ちてきて、パドルとアイテムが衝突するとパワーアップが適用される、という仕組みの部分を作ったので、今回は個々のパワーアップ機能自体を実装する。</p><p>具体的には以下のパワーアップ機能をそれぞれ作っていく。</p><ul><li>Slow: ボールのスピードを初期値に戻す（遅くする）</li><li>Expand: 一定時間、パドルを横に伸ばす</li><li>Multiple: 一定時間、複数のボールを発射できるようにする</li><li>Laser: 一定時間、レーザービームを発射できるようにする</li><li>Life: ライフを一つ増やす（ライフ数の最大は 5）</li></ul><p>それでは前回に引き続き<strong>ブロック崩し</strong>を開発していこう。</p><br><blockquote><p><em><strong><span style=color:salmon>Memo:</span></strong><br>過去のシリーズをまだご覧になっていない方は、そちらを先にご覧いただくことをおすすめします。<br><a href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/ title="Godot で作るブロック崩し">Godot で作るブロック崩し</a></em></p></blockquote><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=パワーアップ機能のための全体的なコード更新>パワーアップ機能のための全体的なコード更新<a hidden class=anchor aria-hidden=true href=#パワーアップ機能のための全体的なコード更新>#</a></h1><p>個々のパワーアップの実装をする前に、スクリプト全体を通して必要な更新を先にやってしまおう。「Game.gd」スクリプトのコード量がだんだん多くなってきたが、頑張ろう。では、順番に更新箇所を見ていく。</p><h3 id=シーンドックから-ball-と-level1-を削除する>シーンドックから Ball と Level1 を削除する<a hidden class=anchor aria-hidden=true href=#シーンドックから-ball-と-level1-を削除する>#</a></h3><p>「Ball」ノードと「Level1」ノードをシーンドックで最初から「Game」シーンのルートノードに追加しておくのではなく、<code>_ready</code>メソッド実行時にスクリプトによって追加するように変更する。このチュートリアルの中盤で、パワーアップ「Multiple」が有効になった時に、スクリプトで「Ball」ノードを追加する必要がある。ならば、そのような消したり追加したりするノードは、最初からすべてスクリプトでコントロールする方がシンプルだ。「Game」シーン上では、「Ball」ノード、「Level_」ノード、そしてあとで登場予定の「Laser」ノードだ。</p><p>ではまずシーンドックで「Game」シーンから「Ball」ノードと「Level1」ノードを削除しよう。</p><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_0.1.png alt=Ballsグループを作ってBallノードを追加></p><h3 id=onready-変数を追加削除する>onready 変数を追加・削除する<a hidden class=anchor aria-hidden=true href=#onready-変数を追加削除する>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#75715e>#onready var level = $Level1 #　削除</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 中略</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#onready var ball = $Ball #　削除</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 中略</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> paddle_scale <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>scale <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#onready var ball_position = ball.position #　削除</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> ball <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Ball.tscn&#34;</span>) <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> powerup <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Powerup.tscn&#34;</span>) <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> level <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e># 変更</span>
</span></span></code></pre></div><p>今シーンドックから削除したノードを示す変数<code>level</code>と<code>ball</code>を削除した。さらに「Ball」ノードのプロパティ<code>position</code>を示す<code>ball_position</code>の変数も削除した。</p><p>代わりに、<code>preload</code>した「Ball.tscn」と「Powerup.tscn」の PackedScene それぞれの変数<code>ball</code>、<code>powerup</code>を新たに追加した。<code>level</code>は読み込む PackedScene ファイルの名前につく数字が実際のレベルによって異なるので、<code>preload</code>できない。いったん、<code>null</code>としておき、必要な場面で<code>load</code>で読み込んだ PackedScene を代入することになる。</p><p>あとは<code>paddle_scale</code>を新たに追加した。値は<code>paddle.scale</code>で、<code>scale</code>プロパティは「Paddle」ノードの座標位置を Vector2 型データとして保持するプロパティだ。つまり、ゲーム開始前にパドルの初期位置をこの変数に代入している。</p><h3 id=_ready-メソッドを更新する>_ready メソッドを更新する<a hidden class=anchor aria-hidden=true href=#_ready-メソッドを更新する>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_ready</span>():
</span></span><span style=display:flex><span>	randomize()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_level</span>() <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_ball</span>() <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e># For debug</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>leave_one_brick</span>(<span style=color:#ae81ff>43</span>, level) <span style=color:#75715e># ラインを移動</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.connect(&#34;tree_exited&#34;, self, &#34;_on_Ball_tree_exited&#34;) # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#for brick in level.get_children(): # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#brick.connect(&#34;tree_exited&#34;, self, &#34;_on_Brick_tree_exited&#34;, [brick.global_position])</span>
</span></span></code></pre></div><p>新しいメソッド<code>add_new_level</code>と<code>add_new_ball</code>を2つ追加した。これらの定義は後ほど説明する。コードの行の順番はこの通りにする必要がある。それぞれのメソッドで「Game」ルートノードの子ノードとしての順番を「Level_」ノードが先、「Ball」ノードが後になるように指定しているためだ。</p><p>デバッグ時にブロックを残り1つにするメソッド<code>leave_one_brick</code>は別のラインに移動した。これは<code>add_new_level</code>メソッドで現在の「Level」ノード内の各ブロックが全部準備できてからでないと処理の対象がないからだ。</p><p>「Ball」ノードはシーンドック上で「Game」シーンから削除済みなので、<code>ball.connect("tree_exited", self, "_on_Ball_tree_exited")</code>を<code>_ready</code>内からは削除した。この処理はのちに定義する<code>add_new_ball</code>メソッド内に追加する。</p><p>同じく<code>for brick in level.get_children():</code>のブロックを削除した。理由は「Level1」ノードはシーンドック上で「Game」シーンから削除済みで、かつ<code>add_new_level</code>メソッド内で、この<code>for</code>ブロックと全く同じシグナル接続処理を含んでいるからだ。</p><h3 id=is_playing-変数を追加する>is_playing 変数を追加する<a hidden class=anchor aria-hidden=true href=#is_playing-変数を追加する>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>var</span> is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>今回、新たに<code>is_playing</code>という変数を追加した。これは、ゲームプレイ中であれば<code>true</code>の値をもつようにする。</p><p>使い所だが、ブロックをすべて消してそのレベルをクリアした時に、パワーアップ「Multiple」により、複数のボールが画面上に存在する場面が想定できる。この時、一旦画面上のボールをすべて消してから、新しいボールを追加する処理を、このあとの<code>_on_Ball_tree_exited</code>メソッドにて実装するのだが、画面上からボールが消えるとライフが一つ減るルールなので、ゲームクリア時はこの<code>is_playing</code>変数を<code>false</code>に変更し、<code>false</code>の場合はライフが減らないように修正していく。</p><h3 id=_on_ball_tree_exited-メソッドを更新する>_on_Ball_tree_exited メソッドを更新する<a hidden class=anchor aria-hidden=true href=#_on_ball_tree_exited-メソッドを更新する>#</a></h3><p>次はボールが画面から消えたら呼ばれる<code>_on_Ball_tree_exited</code>メソッドだ。今までは画面下に落ちる場合くらいしかこのメソッドが呼ばれることはなかったが、今回のチュートリアルでパワーアップ「Multiple」を実装するにあたり、レベルクリア時に一旦画面上のボールを一掃することになる。その場合もボールが消されるタイミングでこのメソッドが呼ばれる。</p><p>ではどのように編集すべきか見ていこう。先ほど定義した変数<code>is_playing</code>も利用する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Ball_tree_exited</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;_on_Ball_tree_exited() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> no_ball <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>):
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;found ball&#34;</span>)
</span></span><span style=display:flex><span>			no_ball <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> no_ball: <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> is_playing: <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>			life <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> life <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>change_scene</span>(<span style=color:#e6db74>&#34;res://scene/GameOverView.tscn&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># Clear powerup items</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;PowerupItems&#34;</span>):
</span></span><span style=display:flex><span>				child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e># Set Paddle and Balls as default</span>
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> paddle_position
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>() <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#ball = load(&#34;res://scene/Ball.tscn&#34;).instance() # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#call_deferred(&#34;add_child&#34;, ball) # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#call_deferred(&#34;move_child&#34;, ball, 3) # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#ball.connect(&#34;tree_exited&#34;, self, &#34;_on_Ball_tree_exited&#34;) # 削除</span>
</span></span></code></pre></div><p>そこで先に変数<code>no_ball</code>を<code>true</code>としてBool型の変数として定義しておく。<code>get_children</code>メソッドで「Game」の子ノードを<code>for</code>ループで順番にチェックしていき、子ノードが「Ball」インスタンスに該当する場合は、メソッド内で新しく定義した<code>no_ball</code>を<code>false</code>にする（つまり画面上にボールが存在するという意味）。そのあとそのまま<code>break</code>でループから抜ける。そして、<code>if</code>構文で<code>no_ball</code>が<code>true</code>（つまり「Ball」インスタンスがない）の場合は<code>if</code>ブロック内のコードが実行される。</p><p>さらに変数<code>is_playing</code>が<code>true</code>の場合はライフを一つ減らす。ライフがもし<code>0</code>だったらゲームオーバーの画面に遷移するし、まだライフが残っていれば、HUDを更新する。一方、<code>is_playing</code>が<code>false</code>の場合はゲームクリア直後で次のレベルの準備段階なので、ライフは減らさず、この時点で<code>is_playing</code>を<code>true</code>に戻しておくのみだ。</p><p>あとの<code>no_ball</code>が<code>true</code>だった場合のコードを少し編集した。まず、以下の処理をする4行のコードは削除した。</p><ul><li>新しい「Ball」シーンのインスタンスを生成</li><li>そのインスタンスを「Game」ノードの子ノードにする</li><li>そのインスタンスの子の順番を<code>3</code>番目にする</li><li>そのインスタンスのシグナル<code>tree_exited</code>を「Game.gd」内の<code>_on_Ball_tree_exited</code>メソッドに接続する</li></ul><p>代わりに同様の処理を実行する<code>add_new_ball</code>というメソッドを追加した。このメソッドの定義はちょうどこのあと説明するところだ。</p><h3 id=add_new_ball-メソッドを追加する>add_new_ball メソッドを追加する<a hidden class=anchor aria-hidden=true href=#add_new_ball-メソッドを追加する>#</a></h3><p>ではここで「Gamde.gd」スクリプトに新しく<code>add_new_ball</code>メソッドを以下のように定義して追加しよう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#75715e># Add a new ball</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_new_ball</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> ball<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, instance)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, instance, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;tree_exited&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Ball_tree_exited&#34;</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>「Ball」シーンのインスタンスを「Game」シーンに追加する際に必要な処理をまとめた。最後の<code>instance.mode = 3</code><br>は「RigidBody2D」クラスのプロパティ「Mode」の値を<code>3</code>、すなわち「Kinematic」に設定するということだ。これはゲーム開始時の初期値であり、このモードの間はパドルから勝手にボールが離れることはない。</p><h3 id=_on_brick_tree_exited-を更新する>_on_Brick_tree_exited を更新する<a hidden class=anchor aria-hidden=true href=#_on_brick_tree_exited-を更新する>#</a></h3><p>ブロックを消した時のシグナルで実行される<code>_on_Brick_tree_exited</code>メソッドを見ておこう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#75715e># Method receiving Brick signal</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Brick_tree_exited</span>(brick_position):
</span></span><span style=display:flex><span>	<span style=color:#75715e># Update Score</span>
</span></span><span style=display:flex><span>	score <span style=color:#f92672>+=</span> POINT <span style=color:#f92672>*</span> bonus_rate
</span></span><span style=display:flex><span>	bonus_rate <span style=color:#f92672>+=</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>	hud_score<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Score: &#34;</span> <span style=color:#f92672>+</span> str(score)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Exit current Level node</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> level<span style=color:#f92672>.</span><span style=color:#a6e22e>get_child_count</span>() <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>#level.queue_free() # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#print(&#34;level queue free&#34;) # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#print(&#34;PowerupItems / Balls queue free&#34;) ＃ 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>set_next_level</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>: <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># Drop powerup item</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>drop_powerup</span>(brick_position) <span style=color:#75715e># else ブロック内に移動</span>
</span></span></code></pre></div><p>このメソッドの中の<code>if / else</code>構文の<code>if</code>ブロック内には<code>set_next_level</code>メソッドのみを残し他の行は、このあとすべて<code>set_next_level</code>メソッドの中に移動させる。</p><p>次に<code>else</code>ブロックだ。この<code>else</code>ブロックは元々はなく、<code>if / else</code>構文が終わった後、その外側の最後の行で<code>drop_powerup</code>メソッドを実行してパワーアップアイテムを出現させていた。今回<code>else</code>ブロックを用意し、その中に<code>drop_powerup</code>を移動した。この更新によって「ブロックを消した時、画面上の残りブロック数が<code>0</code>より大きかったら（つまり、まだそのレベルのクリアではなかったら）、パワーアップアイテムを出現させる」という意味になった。逆を言うと、そのレベルをクリアした時はアイテムは出現させない、という意味になる。</p><h3 id=drop_powerup-メソッドを更新する>drop_powerup メソッドを更新する<a hidden class=anchor aria-hidden=true href=#drop_powerup-メソッドを更新する>#</a></h3><p><code>drop_powerup</code>メソッドはパワーアップアイテムをドロップさせるメソッドだ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>drop_powerup</span>(brick_position: <span style=color:#a6e22e>Vector2</span>):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> randf() <span style=color:#f92672>&lt;=</span> drop_rate:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> powerup_instance <span style=color:#f92672>=</span> powerup<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>		powerup_instance<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> brick_position
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, powerup_instance)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, powerup_instance, <span style=color:#ae81ff>5</span>) <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		powerup_instance<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;item_collided&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Powerup_item_collided&#34;</span>) 
</span></span></code></pre></div><p>追加したのは、6行目の<code>call_deferred("move_child", powerup_instance, 5)</code>だ。<code>call_deferred</code>を利用しているが、実際の処理は<code>move_child</code>メソッドによる子ノードの順番指定だ。</p><p><code>add_child</code>メソッドで<code>Powerup.tscn</code>シーンのインスタンスを「Game」ノードの子ノードにした時、デフォルトでは、子ノードの一番最後の順番に配置される。ここで問題になるのは、画面上にパワーアップアイテムがドロップしている最中に、そのレベルをクリアした場合、デフォルトでは「NextScreen」ノードより全面にパワーアップアイテムが配置されてしまうため、レベルをクリアした時に「NextScreen」の上にパワーアップアイテムが表示され、奇妙な画面になってしまう。そこで、それぞれの子ノードが以下の順番になるように「Powerup」のインスタンスノードの順番を<code>5</code>に指定している。</p><ol start=0><li>HUD</li><li>Paddle</li><li>Wall</li><li>Level_（インスタンス）</li><li>Ball（インスタンス）</li><li>Powerup（インスタンス）</li><li>PauseScreen</li><li>NextScreen</li></ol><p>もちろん、ゲームプレイ中にドロップ中のパワーアップアイテムが複数あることもあれば、パワーアップアイテム「Multiple」の機能によって、複数のボールが生成されることもあり、上記のような綺麗な順番にはならないが、少なくとも毎回<code>5</code>番目を指定すれば「PauseScreen」や「NextScreen」より全面に表示されることはない。</p><h3 id=set_next_level-メソッドを更新する>set_next_level メソッドを更新する<a hidden class=anchor aria-hidden=true href=#set_next_level-メソッドを更新する>#</a></h3><p><code>set_next_level</code>メソッドは、あるレベルのブロックを全て消してクリアした時に実行される、次のレベルの諸々の準備をするメソッドだ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>set_next_level</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;set_next_level() called&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e># Change status</span>
</span></span><span style=display:flex><span>	is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;is_playing: &#34;</span>, is_playing)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e># Clear left objects # 追加</span>
</span></span><span style=display:flex><span>	level<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>() <span style=color:#75715e># 移動</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;level.queue_free() called&#34;</span>) <span style=color:#75715e># 移動</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;PowerupItems/Balls/Lasers group: child.queue_free() called&#34;</span>) <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	level_num <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Stop PauseScreen node</span>
</span></span><span style=display:flex><span>	pause_screen<span style=color:#f92672>.</span>pause_mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Show NextScreen node</span>
</span></span><span style=display:flex><span>	next_screen<span style=color:#f92672>.</span>pause_mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	next_screen_level<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Level: &#34;</span> <span style=color:#f92672>+</span> str(level_num)
</span></span><span style=display:flex><span>	next_screen_score<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Score: &#34;</span> <span style=color:#f92672>+</span> str(score)
</span></span><span style=display:flex><span>	next_screen_life<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x &#34;</span> <span style=color:#f92672>+</span> str(life)
</span></span><span style=display:flex><span>	next_screen<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set Level of HUD the next level</span>
</span></span><span style=display:flex><span>	hud_level<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Level: &#34;</span> <span style=color:#f92672>+</span> str(level_num)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set Paddle and Ball the first position</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#paddle.position = paddle_position # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#add_new_ball() # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.position = ball_position # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.mode = 3 # 削除</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set next Level node</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_level</span>() <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#level = load(&#34;res://scene/Level&#34; + str(level_num) + &#34;.tscn&#34;).instance() # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#add_child(level) # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#move_child(level, 5) # 削除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#for child in level.get_children(): # 削除</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#child.connect(&#34;tree_exited&#34;, self, &#34;_on_Brick_tree_exited&#34;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Pause game until NextScreen is hidden</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span>paused <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>「# Clear left objects」とコメントしている下の6行のコードをまるまる追加した（<code>print</code>関数はデバッグようなのでお好みで消して欲しい）。</p><p>このうち<code>level.queue_free</code>は別のメソッド<code>_on_Brick_tree_exited</code>から移動したコードだ。クリアして不要になった「Level_」ノードを消すことも、このメソッドの役割とした。</p><p>続いて<code>get_children</code>メソッドで得られる「Game」ルートノードの子ノードで回す<code>for</code>ループのブロック3行は新たに追加した。まず<code>if</code>ブロックは『ブロックがすべて消えたら（つまり、そのレベルをクリアしたら）』という条件になっている。この状況では、次のレベルの設定を開始する前に、画面上に残っているボールを全て消す必要がある。それをこの<code>for</code>ループで行っている。ボールをすべて消すとシグナルによって呼ばれる<code>_on_Ball_tree_exited</code>メソッドによって、画面上に残っているドロップ中のパワーアップアイテムも一掃されるため、このメソッドに記述する必要はない。</p><p>あと<code>add_new_level</code>メソッドを新たに追加し、その下にあるコードを削除しているが、これらの削除したコードはこの新しいメソッドに移動させてまとめた形だ。</p><p>では、これらのメソッドの定義を見ていこう。</p><h3 id=add_new_level-メソッドを追加する>add_new_level メソッドを追加する<a hidden class=anchor aria-hidden=true href=#add_new_level-メソッドを追加する>#</a></h3><p><code>add_new_level</code>メソッドを新たに定義した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#75715e># Add new level</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_new_level</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	level <span style=color:#f92672>=</span> load(<span style=color:#e6db74>&#34;res://scene/Level&#34;</span> <span style=color:#f92672>+</span> str(level_num) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.tscn&#34;</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_child</span>(level)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>move_child</span>(level, <span style=color:#ae81ff>3</span>) <span style=color:#75715e># 5 から 3 に変更</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> level<span style=color:#f92672>.</span><span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		child<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;tree_exited&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Brick_tree_exited&#34;</span>, [child<span style=color:#f92672>.</span>global_position]) <span style=color:#75715e># 第四引数追加 </span>
</span></span></code></pre></div><p>このメソッドの内容は、さきほどの<code>set_next_level</code>メソッド内で元々処理していた部分をメソッドにまとめたにすぎない。しかし、少し細かいところを調整している。</p><p>まず<code>move_child</code>メソッドの第二引数を<code>5</code>から<code>3</code>に変えた。これは新しい「Level_」シーンのインスタンスを「Game」ルートノードの子に追加した時の子ノードの順番である。<code>4</code>番目は「Ball」シーンのインスタンスノードが、<code>5</code>番目は「Powerup」シーンのインスタンスノードが使用するためだ。この順番が少し違っていても大した支障はないだろうが、「Ball」および「Powerup」のインスタンスノードは、ゲーム中に複数生成されることになるので、順番を後ろに持ってきた方が「Level_」ノードが常に同じ順番になって、後々問題にならなくて良い。</p><p>ひとまず全体的な更新はここまでだ。なかなか骨の折れる作業だったのではないだろうか。いよいよ個別のパワーアップ機能の実装をしていく。</p><br><hr><h1 id=パワーアップslowを実装する>パワーアップ「Slow」を実装する。<a hidden class=anchor aria-hidden=true href=#パワーアップslowを実装する>#</a></h1><p>パワーアップアイテム「Slow」の機能はボールのスピードを初期値に戻すことだ。では実装していこう。</p><h3 id=新しいノードグループballsを作ってballノードを追加する>新しいノードグループ「Balls」を作って「Ball」ノードを追加する<a hidden class=anchor aria-hidden=true href=#新しいノードグループballsを作ってballノードを追加する>#</a></h3><p>まずは、新しく「Balls」というノードグループを作成して「Ball」ノードを追加しておこう。これは、あとで Multiple アイテムを実装することを想定して、複数のボールが画面上にある場合にコードを作りやすくするためだ。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_1.png alt=Ballsグループを作ってBallノードを追加></p><p>次に「Game.gd」スクリプトを更新していこう。</p><h3 id=ボールのスピードを初期値に戻すメソッドを定義する>ボールのスピードを初期値に戻すメソッドを定義する<a hidden class=anchor aria-hidden=true href=#ボールのスピードを初期値に戻すメソッドを定義する>#</a></h3><p>まずボールのスピードを初期値にするメソッドを追加した。以下の<code>slow_ball</code>だ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>slow_balls</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>):
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span>ball_speed <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span>first_speed
</span></span></code></pre></div><p><code>get_children</code>メソッドで、「Game」ノードの子ノード全てにアクセスする。これはのちにパワーアップアイテム「Multiple」の機能が有効になった時に、ゲーム画面上にボールがたくさん存在する状態になるので、それら全てにアクセスするための布石だ。</p><p>次に<code>if</code>構文で、そのアクセスした子ノードそれぞれに対して、順次「Balls」ノードグループのメンバーかどうかをチェックし、メンバーだったら、次の行のコードが実行される。そして実行されるのが、それぞれの Ball ノードの変数<code>ball_speed</code>（現在のスピード）に、別の変数<code>first_speed</code>（最初のスピード）を代入する、というコードだ。これによって、ボールがゲーム開始時と同じスピードに戻る、という流れになっている。</p><h3 id=slow-が有効になったら-slow_balls-メソッドを実行するようにする>Slow が有効になったら slow_balls メソッドを実行するようにする<a hidden class=anchor aria-hidden=true href=#slow-が有効になったら-slow_balls-メソッドを実行するようにする>#</a></h3><p>_on_Powerup_item_collided　メソッドを編集しよう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span></code></pre></div><p><code>_on_Powerup_item_collided</code>メソッドの中の<code>match</code>ブロック内で、引数<code>item</code>の値が<code>0</code>（つまり enum の要素<code>Powerup.SLOW</code>)と一致した場合に実行するコードとして、先に定義した<code>slow_balls</code>メソッドを追加した。</p><h3 id=プロジェクトを実行して動作確認>プロジェクトを実行して動作確認<a hidden class=anchor aria-hidden=true href=#プロジェクトを実行して動作確認>#</a></h3><p>では一度プロジェクトを実行して「Slow」の動作を確認しておこう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_2.gif alt="パワーアップ Slow の動作確認"></p><p>ちなみに<code>slow_balls</code>メソッド内の<code>child.ball_speed = child.first_speed</code>のコードの前後に<code>print(child.ball_speed)</code>というコードを2つ用意することで、「出力」コンソールで数値として本当にスピードが初期値の<code>150</code>に戻っているのかを確認できる。あくまでデバッグ用だ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span>print(child<span style=color:#f92672>.</span>ball_speed)
</span></span><span style=display:flex><span>child<span style=color:#f92672>.</span>ball_speed <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span>first_speed
</span></span><span style=display:flex><span>print(child<span style=color:#f92672>.</span>ball_speed)
</span></span></code></pre></div><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_3.png alt=出力コンソールでball_speedの初期化を確認></p><br><hr><h1 id=パワーアップexpandを実装する>パワーアップ「Expand」を実装する<a hidden class=anchor aria-hidden=true href=#パワーアップexpandを実装する>#</a></h1><p>次はパワーアップアイテム「Expand」の機能だ。「Expand」は一定時間、パドルを横に伸ばす機能だ（Stretch という名前の方が意味は正確だったかもしれない）。このアイテムは以下の仕様で実装していく。</p><ul><li>伸びた後の長さは通常の2倍</li><li>長さが元に戻るまでの時間は 10 秒</li><li>長さが元に戻るまでは何回「Expand」アイテムと衝突しても長さは伸びない</li><li>長さが元に戻るまでの時間は何回「Expand」アイテムと衝突しても増えない</li><li>ボールが落ちたり、ブロックをすべて消してレベルをクリアしたら通常の長さに戻る</li></ul><p>ではまた「Game.gd」スクリプトを編集していこう。</p><h3 id=onready-変数でパドルの最初の長さを定義する>onready 変数でパドルの最初の長さを定義する<a hidden class=anchor aria-hidden=true href=#onready-変数でパドルの最初の長さを定義する>#</a></h3><p>まず<code>onready</code>つきの変数を一つ追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> paddle_scale <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>scale <span style=color:#75715e># Added @ P11</span>
</span></span></code></pre></div><p>これは「Paddle」ノードの<code>scale</code>プロパティの初期値を格納しておく変数だ。パドルのサイズを元に戻すときに役に立つ。</p><h3 id=ボールが画面から消えた時にパドルの長さを初期値に戻す>ボールが画面から消えた時にパドルの長さを初期値に戻す<a hidden class=anchor aria-hidden=true href=#ボールが画面から消えた時にパドルの長さを初期値に戻す>#</a></h3><p>次に<code>_on_Ball_tree_exited</code>メソッドにコードを1行追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#75715e># Method receiving Ball signal</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Ball_tree_exited</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> ball_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>):
</span></span><span style=display:flex><span>			ball_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ball_count <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		life <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> life <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>change_scene</span>(<span style=color:#e6db74>&#34;res://scene/GameOverView.tscn&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>(): 
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;PowerupItems&#34;</span>):
</span></span><span style=display:flex><span>					child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>			paddle<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> paddle_position
</span></span><span style=display:flex><span>			paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>add_new_ball</span>()
</span></span></code></pre></div><p>追加したのは<code>if / else</code>構文の<code>else</code>ブロックの<code>paddle.scale = paddle_scale</code>という1行だ。このメソッドはボールが画面下に落ちた時にシグナルによって実行される。この時、ライフがまだ残っている状態では、パドルを初期位置に戻すついでに、「Expand」で2倍に伸びていたサイズも元に戻すようにしているのだ。</p><h3 id=レベルをクリアしたらパドルの長さを初期値に戻す>レベルをクリアしたらパドルの長さを初期値に戻す<a hidden class=anchor aria-hidden=true href=#レベルをクリアしたらパドルの長さを初期値に戻す>#</a></h3><p>次に<code>set_next_level</code>メソッドにコードを1行追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>set_next_level</span>():	
</span></span><span style=display:flex><span>	<span style=color:#75715e>#（中略）</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set Paddle and Ball the first position</span>
</span></span><span style=display:flex><span>	paddle<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> paddle_position
</span></span><span style=display:flex><span>	paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_ball</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set next Level node</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_level</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e># Pause game until NextScreen is hidden</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span>paused <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>このメソッドは、すべてのブロックを消してそのレベルをクリアした時に実行されるメソッドだが、その中で「Paddle」ノードの位置を初期値に戻すコードを実行しているので、その次にサイズも初期値に戻すコードを追加した。これで、パドルサイズが2倍になっている状態でレベルをクリアしても、次のレベルでは通常サイズに戻ることになる。</p><h3 id=パドルの長さを-10-秒間-2-倍にするメソッドを定義する>パドルの長さを 10 秒間 2 倍にするメソッドを定義する<a hidden class=anchor aria-hidden=true href=#パドルの長さを-10-秒間-2-倍にするメソッドを定義する>#</a></h3><p>そして次に、<code>expand_paddle</code>メソッドを新たに追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>expand_paddle</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>&lt;=</span> paddle_scale:
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale<span style=color:#f92672>.</span>x <span style=color:#f92672>*=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>10</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale
</span></span></code></pre></div><p>このメソッドは、「Expand」のパワーアップ機能そのものだ。<code>if</code>構文で、パドルの<code>scale</code>プロパティが初期値だったら、<code>scale</code>プロパティ（Vector2型）の x 要素を2倍にするようにしている。</p><p>さらに<code>yield</code>でワンショットタイマーを10秒でセットし、タイムアウトしたタイミングでまた<code>scale</code>プロパティを初期値に戻すようにしている。つまり、これで10秒間だけパドルが長くなる機能を実装しているのだ。</p><p>このメソッドは冒頭の<code>if</code>構文により、すでにパドルが伸びている状態で「Expand」アイテムをゲットしても効果や秒数が追加されないようにしている。</p><h3 id=expand-が有効になったら-expand_paddle-メソッドを実行するようにする>Expand が有効になったら expand_paddle メソッドを実行するようにする<a hidden class=anchor aria-hidden=true href=#expand-が有効になったら-expand_paddle-メソッドを実行するようにする>#</a></h3><p>そして、今作成した<code>expand_paddle</code>メソッドを、<code>_on_Powerup_item_collided</code>メソッドの<code>match</code>ブロック内で、衝突したアイテムが<code>1</code>（つまり enum <code>Powerup.EXPAND</code>）と一致した場合に実行されるように追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item): <span style=color:#75715e># Updated @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>expand_paddle</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span></code></pre></div><h3 id=プロジェクトを実行して動作確認-1>プロジェクトを実行して動作確認<a hidden class=anchor aria-hidden=true href=#プロジェクトを実行して動作確認-1>#</a></h3><p>ではプロジェクトを実行して、「EXPAND」機能が以下の条件で実装できているか確認しておこう。</p><ul><li>伸びた後の長さは通常の2倍</li><li>長さが元に戻るまでの時間は 10 秒</li><li>長さが元に戻るまでは何回「Expand」アイテムと衝突しても長さは伸びない</li><li>長さが元に戻るまでの時間は何回「Expand」アイテムと衝突しても増えない</li><li>ボールが落ちたり、ブロックをすべて消してレベルをクリアしたら通常の長さに戻る</li></ul><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_4.gif alt="パワーアップ Expand の動作確認"></p><br><hr><h1 id=パワーアップmultipleを実装する>パワーアップ「Multiple」を実装する<a hidden class=anchor aria-hidden=true href=#パワーアップmultipleを実装する>#</a></h1><p>次はパワーアップ「Multiple」を実装していく。このパワーアップの具体的な仕様は以下のようにしていく。</p><ul><li>3秒間、複数のボールを発射できるようにする。</li><li>無効になるまでの3秒間で、新たにこのパワーアップアイテムと衝突しても時間は加算されない。</li><li>3秒後、新しくボールを発射することはできなくなるが、発射済みのボールが強制的に消されることはない。</li></ul><p>では「Game.gd」スクリプトを編集していこう。</p><h3 id=変数-is_multiple_on-を追加する>変数 is_multiple_on を追加する<a hidden class=anchor aria-hidden=true href=#変数-is_multiple_on-を追加する>#</a></h3><p>新しい変数<code>is_multiple_on</code>を定義した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>var</span> is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># 追加</span>
</span></span></code></pre></div><p>これは Bool 値をとり、初期値は<code>false</code>とする。これは、パワーアップ「Multiple」が有効かどうかの情報を保持する変数だ。「Multiple」アイテムと衝突したら<code>true</code>になるように別途コーディングする。</p><h3 id=enable_multiple_balls-メソッドを追加する>enable_multiple_balls メソッドを追加する<a hidden class=anchor aria-hidden=true href=#enable_multiple_balls-メソッドを追加する>#</a></h3><p>次にパドルが「Multiple」アイテムと衝突した時に実行する新しいメソッド<code>enable_multiple_balls</code>を追加した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>enable_multiple_balls</span>(): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_multiple_on:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>()
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>3</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>このメソッドの中身は<code>if</code>構文になっていて、さきほど適宜した変数<code>is_multiple_on</code>が<code>false</code>だったら、という条件定義だ。これに当てはまる場合、以下の処理を順番に実施していく。</p><ol><li><code>add_new_ball</code>メソッドで、新しいボールを1つだけパドルの上に生成する</li><li><code>is_multiple_on</code>を<code>true</code>にする</li><li><code>yield</code>で3秒間のワンショットタイマーを作成し、タイムアウトまで次のコードを待機させる</li><li>タイムアウトしたら、再び変数<code>is_multiple_on</code>を<code>false</code>に戻す</li></ol><h3 id=multiple-が有効になったら-enable_multiple_balls-メソッドを実行するようにする>Multiple が有効になったら enable_multiple_balls メソッドを実行するようにする<a hidden class=anchor aria-hidden=true href=#multiple-が有効になったら-enable_multiple_balls-メソッドを実行するようにする>#</a></h3><p>さきほど定義した<code>enable_multiple_balls</code>メソッドをドロップした「Multiple」アイテムとパドルが衝突した時に実行したい。そのためには、<code>_on_Powerup_item_collided</code>メソッドの<code>match</code>ブロック内で、引数<code>item</code>（衝突したアイテム）が<code>2</code>（Multiple）だった場合に実行されるコードとして追加すれば良い。コードは以下のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item): <span style=color:#75715e># Updated @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>expand_paddle</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_multiple_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span></code></pre></div><h3 id=_process-メソッドでキー入力で複数のボールを発射できるようにする>_process メソッドでキー入力で複数のボールを発射できるようにする<a hidden class=anchor aria-hidden=true href=#_process-メソッドでキー入力で複数のボールを発射できるようにする>#</a></h3><p><code>enable_multiple_balls</code>メソッドはパドルの上に1つだけボールを追加するが、その後、複数のボールを発射可能にする処理はまた別で記述していく必要がある。それが以下<code>_process</code>メソッドのコードだ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_process</span>(_delta): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> is_multiple_on <span style=color:#f92672>and</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>is_action_just_pressed</span>(<span style=color:#e6db74>&#34;launch_ball&#34;</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>()
</span></span></code></pre></div><p>このメソッドは毎フレーム実行されることは以前に説明済みかもしれない。今回このメソッド内は<code>if</code>構文になっている。以下の2つの条件が揃った時に<code>add_new_ball</code>メソッドが実行される。</p><ul><li>変数<code>is_multiple_on</code>が<code>true</code>であること</li><li>インプットマップに登録された「launch_ball」アクションに当てはまるキー入力がされたこと</li></ul><p>これで、パドルが「Multiple」アイテムに衝突してから3秒間は「space」キーを押すたびに新しいボールを発射できるようになった。</p><h3 id=プロジェクトを実行して動作確認-2>プロジェクトを実行して動作確認<a hidden class=anchor aria-hidden=true href=#プロジェクトを実行して動作確認-2>#</a></h3><p>ではパワーアップ「Multiple」がうまく実装できたか確認してみよう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_5.gif alt="パワーアップ Multiple の動作確認"></p><ul><li>パワーアップアイテム「Multiple」がパドルに衝突したら、パドルの上に1つボールが追加された</li><li>そこから3秒間、spaceキーを連打した分だけボールが連射された</li><li>3秒後に連射機能は無効になり、画面上に発射したボールだけが残った</li><li>一番最初のボールが落ちても、他のボールが残っているのでライフは減らない</li></ul><p>もし3秒という時間がしっくりこない場合は、お好みで適宜調整していただければと思う。</p><br><hr><h1 id=パワーアップlaserを実装する>パワーアップ「Laser」を実装する<a hidden class=anchor aria-hidden=true href=#パワーアップlaserを実装する>#</a></h1><p>ドロップしたパワーアップアイテム「Laser」と衝突後、一定時間、レーザービームを発射できるようにする。具体的な仕様は以下のようにする。</p><ul><li>3秒間パドルからレーザーを打ち放題になる</li><li>レーザーがブロックに当たるとレーザーとブロックの両方が消える</li><li>レーザーが画面外に出た場合はレーザーのインスタンスが消去される</li><li>ブロックをすべて消してそのレベルをクリアすると、残ったレーザーは消える（次のレベルに持ち越さない）</li></ul><p>発射されるレーザーオブジェクトは「Game」シーンに複数現れては消えることになる。ということは雛形となる「Laser」シーンを先に作成し、「Game」シーンではそのインスタンスをノードとして追加したり削除したりすれば良い。</p><br><h2 id=laserシーンを作る>「Laser」シーンを作る<a hidden class=anchor aria-hidden=true href=#laserシーンを作る>#</a></h2><p>「Game」シーンにレーザーを登場させるためには、その雛形となるシーンを新たに作成する必要がある。そのインスタンスを「Game」シーンにノードとして追加していくパターンだ。</p><br><h3 id=シーンを新規作成する>シーンを新規作成する<a hidden class=anchor aria-hidden=true href=#シーンを新規作成する>#</a></h3><p>それではシーンを新しく作成していく。例によって、「シーン」メニュー＞「新規シーン」から開始しよう。</p><p>まずは「Area2D」クラスのノードをルートノードとして追加する。この時点でシーンを保存しておこう。ファイル名はそのまま「Laser.tscn」で問題ない。</p><p>続いて子ノードを追加していく。</p><h3 id=子ノードを追加する>子ノードを追加する<a hidden class=anchor aria-hidden=true href=#子ノードを追加する>#</a></h3><p>「Laser」ノードに以下の3つのノードを追加しよう。</p><ul><li>Line2D</li><li>CollisionShape2D</li><li>VisibilityNotifier2D</li></ul><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_5.1.png alt=Lasersグループの追加></p><p>追加したら、次はそれぞれのノードをインスペクタドックやノードドックで編集していく。</p><h3 id=laser-ノードを新しいグループに追加する>Laser ノードを新しいグループに追加する<a hidden class=anchor aria-hidden=true href=#laser-ノードを新しいグループに追加する>#</a></h3><p>まず、ルートノードの「Laser」については、プロパティはデフォルトのままで良いが、ノードグループを新たに作成して追加しておこう。ノードドック＞グループから「Lasers」の名前でグループを作成して追加する。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_6.png alt=Lasersグループの追加></p><p>これは、画面上に複数のレーザーが表示されている状況で、まとめてそれらに対して処理を施す場合にとても便利になる。これまでも「Ball」シーンや「Brick」シーンで利用してきた手法だ。</p><h3 id=コリジョンレイヤーの設定>コリジョンレイヤーの設定<a hidden class=anchor aria-hidden=true href=#コリジョンレイヤーの設定>#</a></h3><p>「Laser」ノード用のコリジョンレイヤーがまだないので、設定していく。まずは「プロジェクト」メニュー＞「プロジェクト設定」＞「一般」タブ＞サイドバーから「2d physics」を開く。次に「Layser 6」に「Laser」と言う名前をつける。</p><p>次にシーンドックで「Laser」ノードを選択し、インスペクタで「Collision」プロパティを編集する。「Layer」がそのノードが属するレイヤー、「Mask」は衝突反応を有効にするレイヤーだ。</p><p>まずは「Layer」プロパティで「Laser」レイヤーを選択、続いて「Mask」プロパティはブロックだけ衝突して欲しいので「Brick」レイヤーのみを選択した。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_6.1.png alt=コリジョンレイヤー追加後Collisionプロパティの設定></p><h3 id=line2d-ノードのプロパティを編集する>Line2D ノードのプロパティを編集する<a hidden class=anchor aria-hidden=true href=#line2d-ノードのプロパティを編集する>#</a></h3><p>次にインスペクタドックで「Line2D」ノードのプロパティを編集する。</p><p>まず「Points」プロパティの値になっている「PoolVector2Array(size 0)」をクリックしよう。すると、「サイズ」を調整できるので 2 に変更してみると、「Line2D」の線にポイントが追加される。折線にする場合は、この「サイズ」を複数追加して、それぞれのポイントの座標を指定するわけだ。今回は短い直線でレーザービームを表現するため、ポイント 0 の座標を(0, 0)、ポイント 1 の座標を(0, -24)にする。すると(0, 0)から真っ直ぐ上に長さが - 24 ピクセルの直線ができるはずだ。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_7.png alt=Line2Dプロパティ1></p><p>続いてプロパティ「Width」は 4 ピクセルを指定してやや細いレーザーにする。「Default Color」は「77bfff」でちょっと水色っぽい青を指定する。このあたりはお好みで調整して欲しい。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_8.png alt=Line2Dプロパティ2></p><p>そして「Capping」カテゴリの「Joint Mode」プロパティについて。これは線のポイントがもっと複数ある場合に、ポイントとポイントをどのような形状でつなぐかを指定する。今回はポイントが 2 つしかないのでデフォルトの「Sharp」ままにしておく。「Begin Cap Mode」と「End Cap Mode」はどちらも「Round」にして、線の両端を丸い形状にしておこう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_9.png alt=Line2Dプロパティ3></p><h3 id=collisionshape2d-ノードのプロパティを編集する>CollisionShape2D ノードのプロパティを編集する<a hidden class=anchor aria-hidden=true href=#collisionshape2d-ノードのプロパティを編集する>#</a></h3><p>例によってインスペクタドックにて「Shape」プロパティを編集する。今回は「CapsuleShape2D」を選択しよう。続けて 2D ワークスペースで、ハンドルをドラッグして、さっき作った「Line2D」ノードと全く同じ形にしてきれいに重なるように調整しよう。調整するときはツールバーで「ピクセルスナップを使用」を有効にすると作業しやすくなる。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_10.png alt=CollisionShape2DのShapeを編集></p><h3 id=visibilitynotifier2d-ノードのプロパティを編集する>VisibilityNotifier2D ノードのプロパティを編集する<a hidden class=anchor aria-hidden=true href=#visibilitynotifier2d-ノードのプロパティを編集する>#</a></h3><p>このゲーム開発では2回目の登場である「VisibilityNotifier2D」ノードは、ノードが画面外に出た時にそれを検知してシグナルを発信することができる。これを利用して、レーザーが画面外に出たらそのレーザーのノードを開放するのが狙いだ。</p><p>こちらのノードも「Rect」プロパティを他のノードのサイズに合わせる形で以下の通りに調整していく。</p><ul><li>x: -2</li><li>y: -26</li><li>w: 4</li><li>h: 28</li></ul><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_11.png alt=VisibilityNotifier2DのRectを編集></p><p>2D ワークスペースを見ながら枠が他のノードと一致しているか確認しておこう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_12.png alt=VisibilityNotifier2Dを2Dワークスペースで確認></p><p>インスペクタドックでの編集作業は一旦これで終わりだ。</p><br><h3 id=スクリプトでレーザーを動かす>スクリプトでレーザーを動かす<a hidden class=anchor aria-hidden=true href=#スクリプトでレーザーを動かす>#</a></h3><p>インスペクタで調整しきれない部分はスクリプトで制御していく。特にレーザーの動きの部分だ。</p><p>ではここで「Laser」ノードにスクリプトをアタッチする。スクリプトファイルは「res://scripts/Laser.gd」として保存しておく。</p><p>スクリプトに以下のコードを記述する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Area2D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export (<span style=color:#66d9ef>float</span>) <span style=color:#66d9ef>var</span> laser_speed <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_physics_process</span>(delta):
</span></span><span style=display:flex><span>	position <span style=color:#f92672>+=</span> <span style=color:#a6e22e>Vector2</span><span style=color:#f92672>.</span>UP <span style=color:#f92672>*</span> laser_speed <span style=color:#f92672>*</span> delta
</span></span></code></pre></div><p>まず<code>laser_speed</code>という変数を定義している。これは名前の通り、レーザーの速度だ。500 ピクセル/秒とした。<code>export</code>キーワードでインスペクタドックでも編集できるようにした。</p><p>続いて、<code>_physics_process</code>メソッドを定義した。</p><p>やっていることは、単純に<code>position</code>プロパティを毎フレーム変更して上方向に移動させているだけである。細かく分解すると、まず<code>Vector2.UP</code>と言うのは方向だけを示した長さが 1 のベクトルで（0, -1）にあたる。これはゲーム画面上で真っ直ぐ上の方向だ。これがレーザーの飛んでいく向きを決めている。これにさっき定義した<code>laser_speed</code>を乗じて方向を持った速度にし、さらに<code>delta</code>を乗じることで、1フレーム当たりの移動距離を計算している。最終的にこれを現在の<code>position</code>プロパティの値に加算して、<code>position</code>そのものを更新している。</p><br><h3 id=シーンを実行して動作を確認する>シーンを実行して動作を確認する<a hidden class=anchor aria-hidden=true href=#シーンを実行して動作を確認する>#</a></h3><p>ここで一度、ルートノードを画面の中央下部のあたりに一時的に移動させて、動作確認しておこう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_13.gif alt=シーンを実行してレーザーの動きを確認></p><p>レーザーの速度が早いと感じたら、適宜プロパティ「laser_speed」を小さくして確認してみて欲しい。</p><br><h3 id=シグナルを接続する>シグナルを接続する<a hidden class=anchor aria-hidden=true href=#シグナルを接続する>#</a></h3><p>「Game.tscn」シーンに、「Laser」シーンのインスタンスノードを追加するにあたって、以下の2つのシグナルが必要になる。</p><ul><li>ブロックに衝突した時に発信するシグナル</li><li>画面外に出た時に発信するシグナル</li></ul><p>ではシグナルを接続していこう。<br>まずは「Laser」ルートノードの「body_entered」というシグナルを「Laser.gd」スクリプトに接続しよう。そして、接亜属先のメソッド<code>_on_body_entered(body)</code>を編集していこう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_body_entered</span>(body):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Bricks&#34;</span>):
</span></span><span style=display:flex><span>		body<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>queue_free</span>()
</span></span></code></pre></div><p>メソッドの内容は『もし衝突したのが「Bricks」グループのメンバーだったら、ブロックを消す、そしてレーザー自身も消す』という内容になっている。</p><p>次は「VisibilityNotifier2D」ノードのシグナル「screen_exited」というシグナルを「Laser.gd」スクリプトに接続しよう。接続先のメソッド<code>_on_VisibilityNotifier2D_screen_exited</code>を編集していく</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_VisibilityNotifier2D_screen_exited</span>():
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>queue_free</span>()
</span></span></code></pre></div><p>このメソッドでやるべきことは、画面外に出たレーザーを消すことだ。つまり<code>queue_free</code>メソッドを実行するのみである。余計なメモリを消費させないためにも、不要なオブジェクトはできるだけ速やかに消した方がいい。</p><p>これで「Laser_tscn」シーンの編集は完了だ。シーンドックは以下のようになっているだろう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_14.png alt=シーンドックの確認></p><br><h2 id=game-シーンにパワーアップ-laser-の機能を実装する>Game シーンにパワーアップ Laser の機能を実装する<a hidden class=anchor aria-hidden=true href=#game-シーンにパワーアップ-laser-の機能を実装する>#</a></h2><p>ここからは「Game」シーンにパワーアップアイテム「Laser」の機能を追加していく。やるべきことは「Multiple」の時と似たようなものなので、楽な気持ちで進めていこう。</p><p>それでは「Game.gd」スクリプトを開いて順番にアップデートしていこう。</p><h3 id=今-laser-が有効かどうかを示す変数を追加する>今 Laser が有効かどうかを示す変数を追加する<a hidden class=anchor aria-hidden=true href=#今-laser-が有効かどうかを示す変数を追加する>#</a></h3><p>以下の変数を追加する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>var</span> is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> 
</span></span></code></pre></div><p>この変数<code>is_laser_on</code>が<code>false</code>の間はパワーアップ「Laser」が無効の状態、<code>true</code>の場合は有効の状態を示すものとして定義した。</p><h3 id=laser-シーンの-packedscene-ファイルを-preload-する>Laser シーンの PackedScene ファイルを Preload する<a hidden class=anchor aria-hidden=true href=#laser-シーンの-packedscene-ファイルを-preload-する>#</a></h3><p>次は<code>laser</code>という変数で、<code>preload</code>した「Laser.tscn」の PackedScene ファイルを値として定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> laser <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Laser.tscn&#34;</span>)
</span></span></code></pre></div><p><code>preload</code>したファイルからレーザーのインスタンスを複数生成することになるため、変数を定義しておくと便利だ。</p><h3 id=laser-が有効になったら-enable_laser-メソッドを実行するようにする>Laser が有効になったら enable_laser メソッドを実行するようにする<a hidden class=anchor aria-hidden=true href=#laser-が有効になったら-enable_laser-メソッドを実行するようにする>#</a></h3><p>この<code>_on_Powerup_item_collided</code>メソッドはパワーアップアイテムがパドルに衝突した時のシグナルによって実行され、<code>match</code>構文によって、アイテムの種類ごとに異なる処理を実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item): <span style=color:#75715e># Updated @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>expand_paddle</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_multiple_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_laser</span>() <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Game: &#34;</span>, item)
</span></span></code></pre></div><p>パワーアップアイテムが「Laser」だった場合は、<code>enable_laser</code>というメソッドを実行している。続いて、このメソッドを定義しよう。</p><h3 id=enable_laser-メソッドでパワーアップ-laser-を有効にする処理を実装する>enable_laser メソッドでパワーアップ Laser を有効にする処理を実装する<a hidden class=anchor aria-hidden=true href=#enable_laser-メソッドでパワーアップ-laser-を有効にする処理を実装する>#</a></h3><p>こちらが新たに定義したメソッド<code>enable_laser</code>だ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>enable_laser</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_laser_on:
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;is laser on&#34;</span>) <span style=color:#75715e># デバッグ用</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>3</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;is laser off&#34;</span>) <span style=color:#75715e># デバッグ用</span>
</span></span></code></pre></div><p>このメソッドはまず全体が一つの<code>if</code>ブロックになっていて、<code>is_laser_on</code>が<code>false</code>の場合のみ実行され、<code>true</code>の場合は何もせずに終了する。では<code>if</code>構文が<code>true</code>だった場合に実行される処理を見ていこう。</p><p>まず<code>is_laser_on = true</code>のコードで<code>is_laser_on</code>を<code>true</code>に変更する。<code>true</code>の間だけレーザーを好きなだけ発射できるように別のメソッドで実装するが、このメソッドではとにかくこの変数の値を変更してステータス管理のみを行う。<code>yield</code>で<code>3</code>秒間のタイマーをセットし、タイムアウトしたら<code>is_laser_on = false</code>で、また「Laser」機能が無効の状態に戻るようにしている。</p><p>次は、先に作っていおいた「Laser.tscn」シーンのインスタンスを作成して「Game」シーンに追加するメソッドを定義していく。</p><h3 id=fire_laser-メソッドでレーザーを発射できるようにする>fire_laser メソッドでレーザーを発射できるようにする<a hidden class=anchor aria-hidden=true href=#fire_laser-メソッドでレーザーを発射できるようにする>#</a></h3><p>以下のように<code>fire_laser</code>というメソッドを定義しよう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fire_laser</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> laser<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, instance)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, instance, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>y <span style=color:#f92672>-</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>やっていることはボールの追加と同様で、以下の通りである。</p><ol><li><code>preload</code>しておいた「Laser.tscn」ファイルのインスタンスの作成する</li><li>作成したインスタンスを<code>add_child</code>で「Game」ルートノードの子にする</li><li>「Game」ルートノードの子ノード内の順番を<code>6</code>番目に変更する</li><li>インスタンスの<code>position</code>プロパティの x 座標を「Paddle」のそれと同じにする</li><li>インスタンスの<code>position</code>プロパティの y 座標を「Paddle」より 16 ピクセル上にする</li></ol><p>「Laser」ノードは生成された瞬間から、それ自身が<code>queue_free</code>で消されるまで、画面の上方向へ飛んでいく。</p><p>この<code>fire_laser</code>メソッドが実行されるのは、プレイヤーがキー入力した時だけにしたい。そこで「Multiple」の時と同様に<code>_process</code>内に<code>Input</code>のメソッドを使って記述していく。</p><h3 id=_process-メソッドでキー入力によるレーザー発射を実装する>_process メソッドでキー入力によるレーザー発射を実装する<a hidden class=anchor aria-hidden=true href=#_process-メソッドでキー入力によるレーザー発射を実装する>#</a></h3><p><code>_process</code>メソッドにはすでに、パワーアップ「Multiple」でボールを複数連射するコードが2行あるので、その下に記述していく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_process</span>(_delta):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> is_multiple_on <span style=color:#f92672>and</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>is_action_just_pressed</span>(<span style=color:#e6db74>&#34;launch_ball&#34;</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> is_laser_on <span style=color:#f92672>and</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>is_action_just_pressed</span>(<span style=color:#e6db74>&#34;ui_up&#34;</span>): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fire_laser</span>()
</span></span></code></pre></div><p>レーザーはインプットマップにデフォルトで登録されている「ui_up」アクションのキー操作で発射されることにした。「ui_up」に割り当てられているのはキーボードの「上矢印」キーだ。キーを叩いただけレーザーが発射される。</p><p>ここまでの内容を少しまとめておこう。</p><ol><li>パワーアップアイテムがパドルと衝突すると<code>_on_Powerup_item_collided</code>メソッドが呼ばれる</li><li>パワーアップアイテムが「Laser」だった場合、<code>_on_Powerup_item_collided</code>メソッド内で<code>enable_laser</code>メソッドが呼ばれる</li><li><code>enable_laser</code>メソッド内で、変数<code>is_laser_on</code>が3秒間だけ<code>true</code>になる</li><li>変数<code>is_laser_on</code>が<code>true</code>の間だけ上矢印キーが入力をされるたびに<code>_process</code>メソッド内で<code>fire_laser</code>メソッドが呼ばれる</li><li><code>fire_laser</code>メソッドにより「Laser.tscn」シーンのインスタンスが生成され、レーザーが発射される</li></ol><h3 id=set_next_level-のブロックをすべて消した時にレーザーも全て消す処理を追加する>set_next_level のブロックをすべて消した時にレーザーも全て消す処理を追加する<a hidden class=anchor aria-hidden=true href=#set_next_level-のブロックをすべて消した時にレーザーも全て消す処理を追加する>#</a></h3><p>では<code>set_next_level</code>に処理を追加していく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>set_next_level</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;set_next_level() called&#34;</span>)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e># Change status</span>
</span></span><span style=display:flex><span>	is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;is_playing: &#34;</span>, is_playing)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Clear left objects</span>
</span></span><span style=display:flex><span>	level<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;level.queue_free() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>) <span style=color:#f92672>or</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Lasers&#34;</span>): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>  <span style=color:#75715e>#（後略）</span>
</span></span></code></pre></div><p>コメントで「# 追加」と記載しているところが変更点だ。</p><p>ブロックをすべて消して、次の新しいレベルの諸々の準備をする前に、「Game」ノードの子ノードをチェックする。その時、「Balls」グループと一緒に「Lasers」グループもチェックして、グループに属するノードが残っていれば、すべて消すようにした。</p><h3 id=プロジェクトを実行して動作確認する>プロジェクトを実行して動作確認する<a hidden class=anchor aria-hidden=true href=#プロジェクトを実行して動作確認する>#</a></h3><p>他のアイテムがドロップすると確認の効率が悪いので、「Powerup/gd」スクリプトの<code>add_sprite_frames</code>メソッドを以下のように一時的に編集してからプロジェクトを実行しよう。</p><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_15.gif alt="パワーアップ Laser の動作確認 1"></p><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_16.gif alt="パワーアップ Laser の動作確認 2"></p><br><hr><h1 id=パワーアップlifeを実装する>パワーアップ「Life」を実装する<a hidden class=anchor aria-hidden=true href=#パワーアップlifeを実装する>#</a></h1><p>最後はパワーアップ「Life」の機能を実装する。ここまでやってきた他のパワーアップアイテムに比べてかなり簡単な作業なので気楽にやっていこう。</p><h3 id=定数でライフの上限を設定する>定数でライフの上限を設定する<a hidden class=anchor aria-hidden=true href=#定数でライフの上限を設定する>#</a></h3><p><code>MAX_LIFE</code>という定数を定義しよう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>const</span> MAX_LIFE <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>UI上、ライフは5つまでしか表示できないようにしているので、その上限をスクリプト上で設定する必要がある。変わることがない値なので、変数ではなく定数としてキーワード<code>const</code>を使って定義した。</p><h3 id=上限に達してなければライフが1つ増えるメソッドを作る>上限に達してなければライフが1つ増えるメソッドを作る<a hidden class=anchor aria-hidden=true href=#上限に達してなければライフが1つ増えるメソッドを作る>#</a></h3><p>単純にライフが 1 増えるメソッドを定義しよう。名前は<code>add_life</code>にする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_life</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> life <span style=color:#f92672>&lt;</span> MAX_LIFE:
</span></span><span style=display:flex><span>		life <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>update_hud_life</span>()
</span></span></code></pre></div><p><code>if</code>構文で、変数<code>life</code>の現在の値が先ほど定義した定数<code>MAX_LIFE</code>の値<code>5</code>より小さければ、ライフを 1 増やす処理をしている。変数の値だけ増えてもプレイヤーはわからないので、<code>update_hud_life</code>メソッドで、HUDのライフの表示も更新させている。</p><h3 id=life-が有効になったら-add_life-メソッドを実行するようにする>Life が有効になったら add_life メソッドを実行するようにする<a hidden class=anchor aria-hidden=true href=#life-が有効になったら-add_life-メソッドを実行するようにする>#</a></h3><p>パワーアップアイテム「Life」とパドルが衝突したら、<code>add_life</code>メソッドを実行するように、<code>_on_Powerup_item_collided</code>メソッドの<code>match</code>構文を編集していこう。</p><p><code>match</code>ブロック内で、引数<code>item</code>（衝突したアイテム）が<code>4</code>（LIFE）だった場合に実行されるコードとして追加すれば良い。コードは以下のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item): 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>expand_paddle</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_multiple_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_laser</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>add_life</span>() <span style=color:#75715e># 追加</span>
</span></span></code></pre></div><p>パワーアップ「Life」の実装はこれだけだ。とても簡単だったのではないだろうか。</p><h3 id=プロジェクトを実行して動作確認する-1>プロジェクトを実行して動作確認する<a hidden class=anchor aria-hidden=true href=#プロジェクトを実行して動作確認する-1>#</a></h3><p>では、最後にライフ追加の機能がきちんと実装されているかどうかチェックをしておこう。</p><ul><li>ドロップした「Life」アイテムにパドルが衝突したらライフが 1 増えること</li><li>ライフが 5 の場合はそれ以上増えないこと</li></ul><p><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_17.gif alt="パワーアップ Life の動作確認"></p><br><hr><h1 id=全体を通して>全体を通して<a hidden class=anchor aria-hidden=true href=#全体を通して>#</a></h1><p>最後に全体を通して調整と確認をしておこう。</p><br><h2 id=細かなバグの修正>細かなバグの修正<a hidden class=anchor aria-hidden=true href=#細かなバグの修正>#</a></h2><p>この時点で確認できた細かなバグを修正する。</p><h3 id=multiplelaserが残るバグを修正する>「Multiple」「Laser」が残るバグを修正する<a hidden class=anchor aria-hidden=true href=#multiplelaserが残るバグを修正する>#</a></h3><h5 id=20211223-追加>2021/12/23 追加<a hidden class=anchor aria-hidden=true href=#20211223-追加>#</a></h5><p>ボールが画面上からすべて消えた時やレベルをクリアして次のレベルに切り替わった時に、まだ「Multiple」のボールや「Laser」のビームが残っていることがある。これはパワーアップが有効な 3 秒の時間がまだ残っている場合に発生する。</p><p>「Game.gd」スクリプトを以下のように編集する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Ball_tree_exited</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;_on_Ball_tree_exited() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>#（中略）</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> no_ball: <span style=color:#75715e># Added and Edited @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#（中略）</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># Set Paddle and Balls as default</span>
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> paddle_position
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>()
</span></span></code></pre></div><p>まずはボールが画面上から消えた時に実行される<code>_on_Ball_tree_exited</code>メソッドだ。<code>if no_ball</code>のブロックで、ボールが画面上からすべて無くなったら、という条件の下、<code>is_multiple_on = false</code>および<code>is_laser_on = false</code>の処理により、「Multiple」や「Laser」の有効時間3秒がまだ残っていても、強制的に無効になるようにした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>set_next_level</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;set_next_level() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Change status</span>
</span></span><span style=display:flex><span>	is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>#（後略）</span>
</span></span></code></pre></div><p>続いて編集するのは、次のレベルに切り替えるための<code>set_next_level</code>メソッドだ。これも先ほどと考え方は同様で、メソッドが呼ばれたらすぐに<code>is_multiple_on = false</code>および<code>is_laser_on = false</code>の処理で、「Multiple」と「Laser」を無効化している。</p><br><h3 id=ボール生成時に一瞬だけ-x-座標-0-に表示されるバグを修正する>ボール生成時に一瞬だけ x 座標 0 に表示されるバグを修正する<a hidden class=anchor aria-hidden=true href=#ボール生成時に一瞬だけ-x-座標-0-に表示されるバグを修正する>#</a></h3><h5 id=20211223-追加-1>2021/12/23 追加<a hidden class=anchor aria-hidden=true href=#20211223-追加-1>#</a></h5><p>最後に、「Multiple」が有効な時に、ボールが生成される一瞬だけ、その新しいボールが x 座標<code>0</code>の位置に見える現象を修正する。</p><p>まずは「Ball.tscn」を開き、インスペクタで「Ball」ルートノードの「Position」プロパティをデフォルトの(0, 0)に戻そう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_17.1.png alt=BallのPositionを初期値に戻す></p><p>あとは念の為程度の修正だが、再度「Game.gd」スクリプトを見てほしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_new_ball</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;add_new_ball() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> ball<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> <span style=color:#a6e22e>Vector2</span>(paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>x, paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>y <span style=color:#f92672>-</span> <span style=color:#ae81ff>10</span>) <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, instance)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, instance, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;tree_exited&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Ball_tree_exited&#34;</span>)	
</span></span><span style=display:flex><span>	<span style=color:#75715e>#instance.mode = 3 # 削除</span>
</span></span></code></pre></div><p>修正するのは<code>add_new_ball</code>メソッドだ。</p><p><code>instance.position = Vector2(paddle.position.x, paddle.position.y - 10)</code>のコードを1行、インスタンス生成直後に追加した。これでボールの x 座標が画面に表示されるタイミングからパドルのそれに一致するようになる。</p><p>ついでに<code>instance.mode = 3</code>のコードは、元々インスタンス生成時に<code>3</code>になっており不要だったので削除した。</p><br><h2 id=アイテムのドロップ率を通常に戻す>アイテムのドロップ率を通常に戻す<a hidden class=anchor aria-hidden=true href=#アイテムのドロップ率を通常に戻す>#</a></h2><p>アイテムのドロップ率を<code>1</code>にしていた。これは100%という意味だ。パワーアップアイテムのデバッグを終えたので、通常のドロップ率に戻そう。お好みで<code>0.5</code>~<code>0.25</code>の間くらいで適当に調整しておこう。<br><img loading=lazy src=/images/tutorials/gd0004_breakout/breakout_11/img_18.png alt="パワーアップ Life の動作確認"></p><h2 id=gamegd-スクリプト全体の確認>Game.gd スクリプト全体の確認<a hidden class=anchor aria-hidden=true href=#gamegd-スクリプト全体の確認>#</a></h2><p>「Game.gd」スクリプトの全体が最終的にどうなったのか、念の為、最後にここで公開しておく。確認されたい方は展開して確認していただければ結構だ。</p><details><summary>「Game.gd」スクリプト全体のコード</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GDScript data-lang=GDScript><span style=display:flex><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node2D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> POINT <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> MAX_LIFE <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export <span style=color:#66d9ef>var</span> drop_rate <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> level_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> score <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> bonus_rate <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> life <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#onready var level = $Level1 # Removed @ P11</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> next_screen <span style=color:#f92672>=</span> <span style=color:#a6e22e>$NextScreen</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> next_screen_level <span style=color:#f92672>=</span> <span style=color:#a6e22e>$NextScreen/VBox/Level</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> next_screen_score <span style=color:#f92672>=</span> <span style=color:#a6e22e>$NextScreen/VBox/Score</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> next_screen_life <span style=color:#f92672>=</span> <span style=color:#a6e22e>$NextScreen/VBox/HBox/Life</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> hud_level <span style=color:#f92672>=</span> <span style=color:#a6e22e>$HUD/LeftBox/Level</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> hud_score <span style=color:#f92672>=</span> <span style=color:#a6e22e>$HUD/LeftBox/Score</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> hud_rightbox <span style=color:#f92672>=</span> <span style=color:#a6e22e>$HUD/RightBox</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> paddle <span style=color:#f92672>=</span> <span style=color:#a6e22e>$Paddle</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#onready var ball = $Ball # Removed @ P11</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> pause_screen <span style=color:#f92672>=</span> <span style=color:#a6e22e>$PauseScreen</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> paddle_position <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>position
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> paddle_scale <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>scale <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#onready var ball_position = ball.position # Removed @ P11</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> ball <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Ball.tscn&#34;</span>) <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> laser <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Laser.tscn&#34;</span>) <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> powerup <span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scene/Powerup.tscn&#34;</span>) <span style=color:#75715e># Added @ P10</span>
</span></span><span style=display:flex><span>onready <span style=color:#66d9ef>var</span> level <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e># Updated @ P11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_ready</span>():
</span></span><span style=display:flex><span>	randomize() <span style=color:#75715e># Added @ P10</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_level</span>() <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_ball</span>() <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e># For debug</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#leave_one_brick(43) # Moved @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.connect(&#34;tree_exited&#34;, self, &#34;_on_Ball_tree_exited&#34;) # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#for brick in level.get_children(): # Removed @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#brick.connect(&#34;tree_exited&#34;, self, &#34;_on_Brick_tree_exited&#34;, [brick.global_position]) # Updated @ P10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_process</span>(_delta): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> is_multiple_on <span style=color:#f92672>and</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>is_action_just_pressed</span>(<span style=color:#e6db74>&#34;launch_ball&#34;</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> is_laser_on <span style=color:#f92672>and</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>is_action_just_pressed</span>(<span style=color:#e6db74>&#34;ui_up&#34;</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fire_laser</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For debug</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>leave_one_brick</span>(brick_num: <span style=color:#66d9ef>int</span>):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> level<span style=color:#f92672>.</span><span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>get_name</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Brick&#34;</span> <span style=color:#f92672>+</span> str(brick_num):
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Method receiving Ball signal</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Ball_tree_exited</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;_on_Ball_tree_exited() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> no_ball <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>):
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;found ball&#34;</span>)
</span></span><span style=display:flex><span>			no_ball <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> no_ball: <span style=color:#75715e># Added and Edited @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> is_playing:
</span></span><span style=display:flex><span>			life <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> life <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>change_scene</span>(<span style=color:#e6db74>&#34;res://scene/GameOverView.tscn&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>				life_down_sound<span style=color:#f92672>.</span><span style=color:#a6e22e>play</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># Clear powerup items</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>(): <span style=color:#75715e># Added @ P10</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;PowerupItems&#34;</span>):
</span></span><span style=display:flex><span>				child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e># Set Paddle and Balls as default</span>
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> paddle_position
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>add_new_ball</span>() <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#ball = load(&#34;res://scene/Ball.tscn&#34;).instance() # Removed @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#call_deferred(&#34;add_child&#34;, ball) # Removed @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#call_deferred(&#34;move_child&#34;, ball, 3) # Removed @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#ball.connect(&#34;tree_exited&#34;, self, &#34;_on_Ball_tree_exited&#34;) # Removed @ P11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set life nodes shown and hidden as life variable</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>update_hud_life</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> hud_rightbox<span style=color:#f92672>.</span><span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> count <span style=color:#f92672>&lt;=</span> life:
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span><span style=color:#a6e22e>hide</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add a new ball</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_new_ball</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;add_new_ball() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> ball<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span> <span style=color:#75715e># Fixed the order @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, instance)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, instance, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;tree_exited&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Ball_tree_exited&#34;</span>)	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Method receiving Brick signal</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Brick_tree_exited</span>(brick_position):
</span></span><span style=display:flex><span>	<span style=color:#75715e># Update Score</span>
</span></span><span style=display:flex><span>	score <span style=color:#f92672>+=</span> POINT <span style=color:#f92672>*</span> bonus_rate
</span></span><span style=display:flex><span>	bonus_rate <span style=color:#f92672>+=</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>	hud_score<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Score: &#34;</span> <span style=color:#f92672>+</span> str(score)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Exit current Level node</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> level<span style=color:#f92672>.</span><span style=color:#a6e22e>get_child_count</span>() <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>set_next_level</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>: <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># Drop powerup item</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>drop_powerup</span>(brick_position) <span style=color:#75715e># Added @ P10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>drop_powerup</span>(brick_position: <span style=color:#a6e22e>Vector2</span>): <span style=color:#75715e># Added @ P10</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> randf() <span style=color:#f92672>&lt;=</span> drop_rate:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> powerup_instance <span style=color:#f92672>=</span> powerup<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>		powerup_instance<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> brick_position
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, powerup_instance)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, powerup_instance, <span style=color:#ae81ff>5</span>) <span style=color:#75715e># Added @ P 11</span>
</span></span><span style=display:flex><span>		powerup_instance<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;item_collided&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Powerup_item_collided&#34;</span>) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Action when powerup item collided</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_Powerup_item_collided</span>(item): <span style=color:#75715e># Updated @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>match</span> item:
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>: <span style=color:#75715e># SLOW</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slow_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>: <span style=color:#75715e># EXPAND</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>expand_paddle</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>2</span>: <span style=color:#75715e># MULTIPLE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_multiple_balls</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span>: <span style=color:#75715e># LASER</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>enable_laser</span>()
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>4</span>: <span style=color:#75715e># LIFE</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>add_life</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># slow balls</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>slow_balls</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>):
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span>ball_speed <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span>first_speed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Stretch paddle</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>expand_paddle</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>&lt;=</span> paddle_scale:
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale<span style=color:#f92672>.</span>x <span style=color:#f92672>*=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>10</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		paddle<span style=color:#f92672>.</span>scale <span style=color:#f92672>=</span> paddle_scale
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># enable powerup Multiple</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>enable_multiple_balls</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_multiple_on:
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>3</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># enable powerup Laser</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>enable_laser</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_laser_on:
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>yield</span>(<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span><span style=color:#a6e22e>create_timer</span>(<span style=color:#ae81ff>3</span>), <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>		is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># fire laser beam</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fire_laser</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> laser<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;add_child&#34;</span>, instance)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>call_deferred</span>(<span style=color:#e6db74>&#34;move_child&#34;</span>, instance, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span>	instance<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>y <span style=color:#f92672>-</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add a life if less than 5</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_life</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> life <span style=color:#f92672>&lt;</span> MAX_LIFE:
</span></span><span style=display:flex><span>		life <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>update_hud_life</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># set next level</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>set_next_level</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;set_next_level() called&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Change status</span>
</span></span><span style=display:flex><span>	is_playing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	is_multiple_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	is_laser_on <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e># Clear left objects</span>
</span></span><span style=display:flex><span>	level<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> <span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Balls&#34;</span>) <span style=color:#f92672>or</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>is_in_group</span>(<span style=color:#e6db74>&#34;Lasers&#34;</span>): <span style=color:#75715e># 追加</span>
</span></span><span style=display:flex><span>			child<span style=color:#f92672>.</span><span style=color:#a6e22e>queue_free</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e># Increment level number</span>
</span></span><span style=display:flex><span>	level_num <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Stop PauseScreen node</span>
</span></span><span style=display:flex><span>	pause_screen<span style=color:#f92672>.</span>pause_mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Show NextScreen node</span>
</span></span><span style=display:flex><span>	next_screen<span style=color:#f92672>.</span>pause_mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	next_screen_level<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Level: &#34;</span> <span style=color:#f92672>+</span> str(level_num)
</span></span><span style=display:flex><span>	next_screen_score<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Score: &#34;</span> <span style=color:#f92672>+</span> str(score)
</span></span><span style=display:flex><span>	next_screen_life<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x &#34;</span> <span style=color:#f92672>+</span> str(life)
</span></span><span style=display:flex><span>	next_screen<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set Level of HUD the next level</span>
</span></span><span style=display:flex><span>	hud_level<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Level: &#34;</span> <span style=color:#f92672>+</span> str(level_num)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set Paddle and Ball the first position</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#paddle.position = paddle_position # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#paddle.scale = paddle_scale # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.position = ball_position # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ball.mode = 3 # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Set next Level node</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_new_level</span>() <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#level = load(&#34;res://scene/Level&#34; + str(level_num) + &#34;.tscn&#34;).instance() # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#add_child(level) # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#move_child(level, 5) # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#for child in level.get_children(): # Removed @ P11</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>#child.connect(&#34;tree_exited&#34;, self, &#34;_on_Brick_tree_exited&#34;) # Removed @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Pause game until NextScreen is hidden</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>get_tree</span>()<span style=color:#f92672>.</span>paused <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add new level</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add_new_level</span>(): <span style=color:#75715e># Added @ P11</span>
</span></span><span style=display:flex><span>	level <span style=color:#f92672>=</span> load(<span style=color:#e6db74>&#34;res://scene/Level&#34;</span> <span style=color:#f92672>+</span> str(level_num) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.tscn&#34;</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>instance</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add_child</span>(level)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>move_child</span>(level, <span style=color:#ae81ff>3</span>) <span style=color:#75715e># Changed from 5 to 3 @ P11</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> level<span style=color:#f92672>.</span><span style=color:#a6e22e>get_children</span>():
</span></span><span style=display:flex><span>		child<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;tree_exited&#34;</span>, self, <span style=color:#e6db74>&#34;_on_Brick_tree_exited&#34;</span>, [child<span style=color:#f92672>.</span>global_position]) <span style=color:#75715e># Updated to add th 4th arg @ P11 </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_on_PauseScreen_visibility_changed</span>():
</span></span><span style=display:flex><span>	play_bgm<span style=color:#f92672>.</span>stream_paused <span style=color:#f92672>=</span> <span style=color:#f92672>not</span> play_bgm<span style=color:#f92672>.</span>stream_paused
</span></span></code></pre></div></details><br><hr><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><h1 id=おわりに>おわりに<a hidden class=anchor aria-hidden=true href=#おわりに>#</a></h1><p>以上で Part 11 は完了だ。今回はパワーアップアイテムを取得した後の個々のパワーアップ機能を実装した。特に「Laser」の実装はかなりボリュームがあり、また全体を通しても、相当な長文になっている。無理に1日で終える必要はなく、適宜日にちを分けてチャレンジして欲しい。</p><p>Part 10、11 とパワーアップ機能の話であったが、次の Part 12 ではブロック崩しに BGM とサウンドエフェクトを追加する。</p><hr></div><footer class=post-footer><br><div class=recommendation><span>🩵この記事を気に入ってくれたらうれしいです🩵</span></div><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on x" href="https://x.com/intent/tweet/?text=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f&amp;hashtags=GodotEngine%2cGameDev%2c%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%2c2D"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f&amp;title=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;summary=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;source=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f&title=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on whatsapp" href="https://api.whatsapp.com/send?text=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81%20-%20https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on telegram" href="https://telegram.me/share/url?text=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るブロック崩し Part 11：パワーアップを実装しよう！ on ycombinator" href="https://news.ycombinator.com/submitlink?t=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e5%b4%a9%e3%81%97%20Part%2011%ef%bc%9a%e3%83%91%e3%83%af%e3%83%bc%e3%82%a2%e3%83%83%e3%83%97%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&u=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0004_breakout%2fbreakout_11%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div><ul class=post-tags><li><a href=https://www.peanuts-code.com/ja/tags/godotengine/>GodotEngine</a></li><li><a href=https://www.peanuts-code.com/ja/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%B4%A9%E3%81%97/>ブロック崩し</a></li><li><a href=https://www.peanuts-code.com/ja/tags/2d/>2D</a></li></ul><nav class=paginav><a class=prev href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_10/><span class=title>« 前へ</span><br><span>Godot で作るブロック崩し Part 10：パワーアップアイテムをドロップさせよう！</span>
</a><a class=next href=https://www.peanuts-code.com/ja/tutorials/gd0004_breakout/breakout_12/><span class=title>次へ »</span><br><span>Godot で作るブロック崩し Part 12：BGMとサウンドエフェクトを追加しよう！</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.peanuts-code.com/ja/>Peanuts Code</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>