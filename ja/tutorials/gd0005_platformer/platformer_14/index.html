<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ | Peanuts Code</title>
<meta name=keywords content="GodotEngine,GameDev,2D,アクションゲーム,横スクロール,プラットフォーマー,プレイヤーキャラクター,ゴーストエフェクト,ダブルジャンプ,壁ジャンプ,砂埃"><meta name=description content="第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。 落下時のアニメーション 壁ジャンプ ダブルジャンプ（2段ジャンプ） 走っている時の砂埃 ダッシュ時のゴーストエフェクト（残像効果） おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やっ"><meta name=author content="gobo"><link rel=canonical href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_14/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.peanuts-code.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.peanuts-code.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.peanuts-code.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.peanuts-code.com/apple-touch-icon.png><link rel=mask-icon href=https://www.peanuts-code.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_14/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！"><meta property="og:description" content="第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。 落下時のアニメーション 壁ジャンプ ダブルジャンプ（2段ジャンプ） 走っている時の砂埃 ダッシュ時のゴーストエフェクト（残像効果） おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やっ"><meta property="og:type" content="article"><meta property="og:url" content="https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_14/"><meta property="og:image" content="https://www.peanuts-code.com/images/tutorials/gd0005_platformer/platformer_14/img24.gif"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2022-04-14T02:07:00+09:00"><meta property="article:modified_time" content="2022-04-14T02:07:00+09:00"><meta property="og:site_name" content="Peanuts Code 🥜"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.peanuts-code.com/images/tutorials/gd0005_platformer/platformer_14/img24.gif"><meta name=twitter:title content="Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！"><meta name=twitter:description content="第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。 落下時のアニメーション 壁ジャンプ ダブルジャンプ（2段ジャンプ） 走っている時の砂埃 ダッシュ時のゴーストエフェクト（残像効果） おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やっ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"🤖 チュート","item":"https://www.peanuts-code.com/ja/tutorials/"},{"@type":"ListItem","position":2,"name":"🤖 シリーズ：Godot で作るプラットフォーマー","item":"https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/"},{"@type":"ListItem","position":3,"name":"Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！","item":"https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_14/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！","name":"Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！","description":"第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。 落下時のアニメーション 壁ジャンプ ダブルジャンプ（2段ジャンプ） 走っている時の砂埃 ダッシュ時のゴーストエフェクト（残像効果） おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やっ","keywords":["GodotEngine","GameDev","2D","アクションゲーム","横スクロール","プラットフォーマー","プレイヤーキャラクター","ゴーストエフェクト","ダブルジャンプ","壁ジャンプ","砂埃"],"articleBody":"第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。\n落下時のアニメーション 壁ジャンプ ダブルジャンプ（2段ジャンプ） 走っている時の砂埃 ダッシュ時のゴーストエフェクト（残像効果） おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やってみてほしい。\nMemo： 過去のシリーズをまだご覧になっていない方は、そちらを先にご覧いただくことをおすすめします。\nGodot で作るプラットフォーマー 落下時のアニメーション 実はチュートリアル Part 1 で実装しておけばいいのに放置したままなのが、この落下時のプレイヤーキャラクターのアニメーションだ。例えば、プレイヤーキャラクターがジャンプした時、現時点では地面から離れてまた地面に着地するまでずっと同じアニメーションだ。しかし今回、プレイヤーキャラクターがジャンプして一番高い位置まで達したあと、次に地面に着地するまでは別のアニメーションを再生するようにアップデートする。\n実はアニメーション自体はチュートリアル Part 1 で、「Player」シーンの「AnimatedSprite」ノードに「fall」というアニメーションを作成済みだ。\nMemo: Godot で作るプラットフォーマー Part 1：プレイヤーキャラクターを作ろう！ この作成済みのアニメーションを特定のタイミングで再生するようにスクリプトで制御する。\nでは「Player.gd」スクリプトを開いて編集しよう。編集するのはスクリプトの中の_physics_processメソッドだ。このメソッドの最後の方に「# 追加」とコメントしているところが更新箇所だ。\nfunc _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) else: velocity.x = clamp(velocity.x, -max_speed, max_speed) sprite.flip_h = x_input \u003c 0 # 地面にいる場合 if is_on_floor(): if x_input == 0: sprite.play(\"idle\") velocity.x = lerp(velocity.x, 0, friction) else: sprite.play(\"run\") if Input.is_action_just_pressed(\"jump\"): sprite.play(\"jump\") velocity.y = -jump_force jump_sfx.play() # 空中にいる場合 else: if x_input == 0: velocity.x = lerp(velocity.x, 0, air_resistance) if Input.is_action_just_released(\"jump\") and velocity.y \u003c -jump_force / 2: velocity.y = -jump_force / 2 # y軸方向の速度が 0 より大きければ（下向きに落下）「fall」アニメーションを再生 if velocity.y \u003e 0: # 追加 sprite.play(\"fall\") velocity = move_and_slide(velocity, Vector2.UP) if position.x \u003c 16: position.x = 16 コードの編集はこれだけだ。「Level1.tscn」シーンファイルを開いてシーンを実行して確認してみよう。一番高い位置までジャンプしたあとの落下時は「fall」アニメーションが再生されているのがわかるだろう。\n壁ジャンプを実装する 壁ジャンプというのは、プレイヤーキャラクターが壁に接触している状態からジャンプすることだ。これを利用して、マップによっては左右の壁を蹴りながら上方向に進むことができたり、画面下に落下しそうになった時に壁ジャンプで難を逃れたりすることができる。\n壁ジャンプのアニメーションも、チュートリアル Part 1 ですでに作成済みだ。「Player」シーンの「AnimatedSprite」ノードの「wall_jump」アニメーションがそれだ。特定のタイミングでこのアニメーションを再生するように、のちほどスクリプトを編集する。\nところで、壁ジャンプを実装するにはプレイヤーキャラクターが壁に接触しているかどうかを判定する必要がある。これには「KinematicBody2D」クラスでもともと用意されているis_on_wallメソッドを使えば良い、と考えてしまいそうだが、実は少し扱いにくい。\nこのメソッドは、move_and_slideメソッドが最後に呼ばれた時（_physics_processメソッドで1フレーム前に呼ばれる）に壁と衝突していたらtrueを返すようだ。実際に検証してみたところ、常に壁に向かってプレイヤーキャラクターが移動しようとしている状態でなければ、検知し続けてくれないようだ。例えば、右側の壁にジャンプしてis_on_wallメソッドでtrueを返させるにはには、空中で右矢印キーを押し続けなければならないが、壁ジャンプする時は壁と反対側にジャンプしたいものだ。右を押し続けている状態からジャンプすると、その直後はまだ右を押しているので、反対の左へ飛びにくい。この操作性の悪さから、このチュートリアルではis_on_wallメソッドを利用する方法は不採用だ。\n代わりの方法としてよく使われているのが、「Area2D」または「RayCast2D」クラスで壁との衝突を検出する方法だ。このチュートリアルでは、ちょうど「Player」ルートノードに「HitBox」という「Area2D」クラスのノードを追加している。このコリジョン形状は元々敵キャラクターとの衝突を検出するために利用しているが、壁との衝突にも流用してしまおうというわけだ。\nでは「Player.gd」スクリプトを更新していく。\nまずは壁ジャンプが可能かどうかのステートを格納するプロパティcan_wall_jumpを定義する。\n# 壁ジャンプ可能かどうかを示すプロパティ（壁ジャンプ可能な場合は true） var can_wall_jump = false # 追加 次に、壁が「Area2D」のコリジョン形状に入った時と出た時に発信されるシグナルを利用して、プレイヤーキャラクターが壁に接触しているかどうかを判定させたい。壁がコリジョン形状に入った時のシグナル「body_entered」はすでに接続済みだ。出た時のシグナル「body_exited」を新たにスクリプトに接続しよう。\nこれで_on_HitBox_body_entered(body)メソッドと、_on_HitBox_body_exited(body)メソッドの2つがスクリプト上で定義されている状態になったはずだ。\nなお、タイルマップに使っているタイルセットの内、ブロック系のタイルはコリジョン形状を設定済み（チュートリアル Part 2 ）なので、物理ボディとして検知可能である。\nではそれぞれのメソッドを以下のように編集してほしい。\n# 物理ボディがコリジョン形状に入った時に呼ばれるメソッド func _on_HitBox_body_entered(body): if body.is_in_group(\"Enemies\"): print(\"Enemy hit player. Damage is \", body.damage) emit_signal(\"enemy_hit\", body.damage) sprite.play(\"hit\") damage_sfx.play() # 衝突した物理ボディがプレイヤーキャラクター自身ではなかったら elif not body.name == \"Player\":: # 追加 # 地面に衝突していなければ（空中だったら） if not is_on_floor(): # 壁ジャンプが可能な状態なのでステートを true にする can_wall_jump = true # 物理ボディがコリジョン形状から出て行った時に呼ばれるメソッド func _on_HitBox_body_exited(body): # 追加 # 壁ジャンプが不可の状態なのでステートを false にする can_wall_jump = false elif not body.name == \"Player\":の部分がわかりにくいかもしれないので少し詳しく解説しておきたいと思う。\n「Player」シーンにおいて、「Player」ルートノードは「KinematicBody2D」クラス、つまり物理ボディだ。この「Player」のコリジョン形状は、壁の検知に再利用している「HitBox」のコリジョン形状と重なっている。そのため「HitBox」には常にこの「Player」が物理ボディとして検知されている状態になる。壁のみを検知したいので、elifの条件を『検知されたボディが「Player」以外だったら』という内容にしている。\nちなみに、もしこのelifの条件文がただのelse文だと、空中だったらいつでも壁ジャンプができてしまう状態になるので、スーパーマリオブラザーズ3のしっぽマリオのように、ジャンプボタンを連打しておけば壁ジャンプで永遠に飛行できてしまうのだ。それはそれで面白いので、その状態を GIF 画像でお見せしておこう。\nでは_physics_processメソッドを更新して、適切なタイミングでのみ壁ジャンプができるようにしていこう。「# 追加」のコメント箇所をみていただきたい。if is_on_floor() / elseのelseブロックの中にif can_wall_jumpブロックを追加した。\nfunc _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) else: velocity.x = clamp(velocity.x, -max_speed, max_speed) sprite.flip_h = x_input \u003c 0 if is_on_floor(): if x_input == 0: sprite.play(\"idle\") velocity.x = lerp(velocity.x, 0, friction) else: sprite.play(\"run\") if Input.is_action_just_pressed(\"jump\"): sprite.play(\"jump\") velocity.y = -jump_force jump_sfx.play() else: if x_input == 0: velocity.x = lerp(velocity.x, 0, air_resistance) if Input.is_action_just_released(\"jump\") and velocity.y \u003c -jump_force / 2: velocity.y = -jump_force / 2 if velocity.y \u003e 0: sprite.play(\"fall\") # 壁ジャンプ可能ステートであれば if can_wall_jump: # 追加 # jump キー（上矢印）を押したら if Input.is_action_just_pressed(\"jump\"): # 速度のy軸方向の値にジャンプ力（上方向なのでマイナス）を適用する velocity.y = -jump_force # 壁ジャンプのアニメーションを再生する sprite.play(\"wall_jump\") # ジャンプ時の SFX を再生する jump_sfx.play() velocity = move_and_slide(velocity, Vector2.UP) if position.x \u003c 16: position.x = 16 壁ジャンプがうまく実装できたか「Level1」シーンを実行して見てみよう。テスト用に「Level1」シーンの「TileMap」ノードに適当な幅でブロックの壁を左右に作ると確認しやすい。\nダブルジャンプを実装する ダブルジャンプ（2段ジャンプ）は、ジャンプ中に空中でさらにもう一回ジャンプするという、2Dアクションゲームではよく使われる定番のアクションである。\nダブルジャンプのアニメーションも、チュートリアル Part 1 ですでに作成済みだ。特定のタイミングで「AnimatedSprite」ノードの該当のアニメーションを再生するように、のちほどスクリプトを編集する。\nダブルジャンプがいつでも何回でもできてしまわないように、プレイヤーキャラクターが空中にいる間に一回だけできるように制御する必要がある。\nでは「Player.gd」スクリプトを編集していこう。\nまずは、壁ジャンプと同様にダブルジャンプのステート用にプロパティを1つ定義する。\n# ダブルジャンプ可能かどうかを示すプロパティ（可能な場合は true） var can_double_jump = false # 追加 続いて_physics_processメソッドをさらに更新する。ちょっとコードが長くなってきたが更新箇所は2箇所だけだ。「# 追加」のコメントを目印にして確認してほしい。\nfunc _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) else: velocity.x = clamp(velocity.x, -max_speed, max_speed) sprite.flip_h = x_input \u003c 0 if is_on_floor(): if x_input == 0: sprite.play(\"idle\") velocity.x = lerp(velocity.x, 0, friction) else: sprite.play(\"run\") if Input.is_action_just_pressed(\"jump\"): # ダブルジャンプ可能ステートに変更 can_double_jump = true # 追加 sprite.play(\"jump\") velocity.y = -jump_force jump_sfx.play() else: if x_input == 0: velocity.x = lerp(velocity.x, 0, air_resistance) if Input.is_action_just_released(\"jump\") and velocity.y \u003c -jump_force / 2: velocity.y = -jump_force / 2 if velocity.y \u003e 0: sprite.play(\"fall\") if can_wall_jump: if Input.is_action_just_pressed(\"jump\"): velocity.y = -jump_force sprite.play(\"wall_jump\") jump_sfx.play() else: # 追加 # もしダブルジャンプ可能ステートだったら if can_double_jump: # jump アクションのキーを押したら if Input.is_action_just_pressed(\"jump\"): # ダブルジャンプ不可ステートに変更 can_double_jump = false # AnimatedSprite ノードの double_jump アニメーションを再生 sprite.play(\"double_jump\") # 速度のy軸方向の値にジャンプ力を適用 velocity.y = -jump_force # ジャンプの SFX を再生 jump_sfx.play() まずif is_on_floor() / else構文のifブロック内でネストされたif Input.is_action_just_pressed(\"jump\")ブロックにて、can_double_jumpプロパティをtrueにしてダブルジャンプ可能ステートにしている。これで、地面に接している状態からジャンプするときにダブルジャンプ可能ステートにリセットされる仕組みだ。\nif is_on_floor() / else構文のelseブロック内でネストされているif can_wall_jumpの箇所にelseブロックを追加した。そしてそこにif can_double_jumpの条件分岐をさらにネストした。これは空中ではダブルジャンプより壁ジャンプを優先するためだ。\nif can_double_jumpのブロック内で、さらにネストしたif Input.is_action_just_pressed(\"jump\")（jump アクションキーを押したら）の条件分岐を追加した。このif構文のブロック内にダブルジャンプ実行時に必要なコードを記述した。処理内容の詳細はコード内のコメントを参照いただきたい。\nさてこれでダブルジャンプが実装できたはずだ。空中で1回だけダブルジャンプできるか「Level1」シーンで試してみよう。\n走っている時の砂埃を実装する 次は砂埃だ。現実には走って砂埃が大袈裟に舞うことはあまりないが、わかりやすい演出なので、プラットフォーマーゲームではよく採用されている。\n実装の流れとしては、まず、砂埃のシーンを「Particles2D」クラスのノードで作成する。続いて、スクリプトで、走っている時だけ砂埃のシーンをインスタンス化して画面上に表示させる。\nではまず砂埃のシーン作成からやっていこう。\n砂埃のシーンを作る 「シーン」＞「新規シーン」で表示される「ルートノード生成」で「その他のノード」を選択し、「Particles2D」クラスのノードをルートノードとして追加しよう。名前は「Dust」に変更する。これ以外のノードは不要だ。\n名前を変更したら、そのままシーンを保存しておこう。ファイルパスを「res://Player/Dust.tscn」として保存しよう。\nDust ノードのプロパティを編集する 「Particles2D」クラスはプロパティが多いので少し大変だが、以下の通りに編集してみてほしい。編集するプロパティ以外はデフォルトのままにしておくこと。\nまずは「Particles2D」クラスのプロパティから編集する。パーティクルの見た目や動きに関わる部分だ。\nEmitting: オフ（他のプロパティの設定が終わるまでは確認しやすいようにオンしておいて良い）\nAmount: 4\nTime:\nLifetime: 0.2 One Shot: オン（他のプロパティの設定が終わるまでは確認しやすいようにオフにしておいて良い） Speed Scale: 0.2\nTextures:\nTexture: ファイルシステムからリソース「res://Assets/Other/Dust Particle.png」を適用する\n*インスペクターでは少し下の方にあるプロパティだが 2D ワークスペースで見た目を確認するには先に設定すべき項目である\nProcess Material:\nMaterial: 新規 ParticlesMaterial を適用する\n以下は「Material」プロパティに適用したリソースのプロパティ編集 Gravity: Gravity: (0, -32, 0)\nInitial velocity: Velocity: 160\nScale: Scale: 2 Scale Random: 1\nColor: Color: #a0ffffff Color Ramp: 新規 GradientTexture を適用する\n以下は「Color Ramp」プロパティに適用したリソースのプロパティ編集 Gradient: 新規 Gradient\n以下は「Gradient」プロパティに適用したリソースのプロパティ編集 Offset: PoolFloatArray(size 3) サイズ: 3 0: 0.003 1: 0.711 2: 1\nColors: PoolColorArray(size 3) サイズ: 3 0: #00ffffff 1: #50ffffff 2: #4affffff\n最後に「Node2D」クラスのプロパティを編集する。これはプレイヤーキャラクターより常に背面に表示させるための設定だ。\nZ Index:\nZ Index: -1\n2Dワークスペースでは以下のようなアニメーションになっているはずだ。\n確認し終わったら「Emitting」プロパティをオフに、「Time」＞「One Shot」プロパティをオンすることを忘れないようにしよう。\nでは今作った「Dust.tscn」シーンのインスタンスを「Player」シーンに追加する。ただし、プレイヤーキャラクターが走っている時だけ都度インスタンスを追加したいので、「Player.gd」スクリプト内にそれをコーディングしよう。\n「Player.gd」スクリプトを開いたら、まずはpreloadした「Dust.tscn」シーンファイルを参照するプロパティを定義しよう。\n# Dust.tscn シーンのプリロード onready var dust_tscn = preload(\"res://Player/Dust.tscn\") # 追加 次に以下のspawn_dustメソッドを新たに定義する。\n# 砂埃を生み出すメソッド func spawn_dust(): # プリロードした Dust.tscn シーンをインスタンス化 var dust = dust_tscn.instance() # Player ノードではなくその親（Level_ノード）の子として Dust.tscn のインスタンスノードを追加 get_parent().add_child(dust) # Dust の位置を Player の位置の y 軸方向に 11 だけ下の位置に配置（足元に来るように） dust.global_position = Vector2(global_position.x, global_position.y + 11) # ダッシュ中の場合 if Input.is_action_pressed(\"dash\"): # 砂埃のマテリアルのサイズを最大4倍にする dust.process_material.scale = 4 # ダッシュ中ではない場合 else: # 砂埃のマテリアルのサイズを最大2倍にする dust.process_material.scale = 2 # Dust の Emitting プロパティをオンにする dust.emitting = true # Dust の One Shot の Emitting が終わるまで待機 yield(get_tree().create_timer(dust.amount * dust.lifetime), \"timeout\") # 追加した Dust のインスタンスを解放 dust.queue_free() このメソッドを少し解説しておく。まず「Dust」シーンをインスタンス化した後、それを「Player」ノードではなく「Player」の親ノード（つまり「Level_」ノード）の子として追加されている。つまり「Player」ノードと「Dust」ノードはシーンツリー上、同階層になる。\nなぜ「Player」ノードに直接追加しないかというと、子ノードの位置は親ノードとの相対的な位置を維持し続けるため、もし「Player」ノードの子として「Dust」ノードを追加すると、プレイヤーキャラクターの位置が移動するのに連動して、生成された砂埃も一緒に移動してしまうからだ。砂埃には生成されたらその場に止まってもらう必要があるので、敢えて「Player」ではなく一階層上の「Level_」シーンのルートノードの子にしているというわけだ。\nさて、ここからはまた_physics_processメソッドを編集する。\n上記spawn_dustメソッドをプレイヤーキャラクターが走っている時に呼ぶようにするには、if is_on_floor()ブロック内でネストされたif x_input == 0 / else構文のelseブロック内のsprite.play(\"run\")のコードの後にspawn_dustメソッドを追加しよう。これで、走っている間だけ砂埃が舞うようになる。\nif x_input != 0ブロックのネストされたif Input.is_action_pressed(\"dash\")ブロックのコードを、ダッシュ時は「AnimatedSprite」の「run」アニメーションが2倍速で再生されるように更新しておく。これで「プレイヤーキャラクターの動きが速くなったから砂埃も増えた」という演出になる。「# 追加」とコメントしている箇所を確認してほしい。\nfunc _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) # ダッシュ時はAnimatedSpriteのアニメーションのスピードを2倍にする sprite.speed_scale = 2 # 追加 else: velocity.x = clamp(velocity.x, -max_speed, max_speed) # ダッシュしていない時はAnimatedSpriteのアニメーションのスピードを通常にする sprite.speed_scale = 1 # 追加 sprite.flip_h = x_input \u003c 0 if is_on_floor(): if x_input == 0: sprite.play(\"idle\") velocity.x = lerp(velocity.x, 0, friction) else: sprite.play(\"run\") # 砂埃を発生するメソッドを呼ぶ spawn_dust() # 追加 if Input.is_action_just_pressed(\"jump\"): # 中略 else: # 中略 velocity = move_and_slide(velocity, Vector2.UP) if position.x \u003c 16: position.x = 16 では「Level1」シーンで確認してみよう。下のGIF画像は 12 FPS なので少しわかりづらいところがあるが、実際のダッシュ時のアニメーションはスムーズだ。\nダッシュ時にゴーストエフェクトを追加する さて、最後はゴーストエフェクトだ。残像効果とも言う。プラットフォーマー、メトロイドバニア、キャッスルバニアなど横スクロールアクションのジャンルで多用される、視覚的にとてもかっこいい演出だ。\nこちらも砂埃を実装した時と考え方は同様で、まずゴーストの雛形となるシーンを作成し、そのインスタンスをダッシュ時にキャラクターの位置に配置し、一定時間経過後に追加したインスタンスを解放するという手法だ。\nではシーンを作るところから始めよう。\nゴーストのシーンを作る 「シーン」＞「新規シーン」で表示される「ルートノード生成」で「その他のノード」を選択し、「Player」シーンのノードに合わせて、「AnimatedSprite」クラスのノードをルートノードとして追加しよう。名前を「Ghost」に変更したら、ファイルパスを「res://Player/Ghost.tscn」としてシーンを保存しよう。\n次に「Ghost」ルートノードに「Tween」クラスのノードを一つ追加する。このノードはシンプルなアニメーション（トランジション）をお手軽に実装するためによく使用される。\n公式オンラインドキュメント Tween シーンツリーは以下のスクリーンショットのようになったはずだ。\nノードのプロパティを編集する シーンツリードックを見ると「Ghost」ルートノードに⚠️マークが表示されている。これは「AnimatedSprite」クラスのノードには「Frames」プロパティに「SpriteFrames」リソースを適用する必要があるからだ。しかし、今回はシーンをインスタンス化する時に、スクリプトでリソースを適用するので、インスペクター上「Frames」プロパティは[空]のままで良い。\n少し詳しく解説しておこう。ゴーストエフェクトは、ゴーストが生成される時点でのプレイヤーキャラクターの見た目、位置、向きをそのままコピーして生成する必要がある。つまり「Ghost」シーンをインスタンス化するタイミングで、「Player」シーンの「AnimatedSprite」ノードの下記プロパティの値を「Ghost」ルートノードの同じプロパティに割り当てる必要があるのだ。\n「Frames」プロパティの値（「SpriteFrames」リソース） 「Animation」プロパティの値（「run」アニメーション） 「Frame」プロパティの値 「Position」プロパティの値（正確には「global_position」プロパティの値） 「Flip H」プロパティの値 これらの値はゴーストが生成されるその時々によって変わるため、前もってインスペクター上で設定することができないのだ。\n一方、インスペクター上で編集すべきプロパティはあるので順番に見ていこう。\n「Z Index」＞「Z Index」プロパティの値を -2 にしておく。これはプレイヤーキャラクターより背面に表示させている砂埃のインスタンス（こちらの「Z Index」は -1）よりさらに背面に表示させたいからだ。\nそして生成されるゴーストの色味も設定しておきたい。「Visibility」＞「Modulate」プロパティの値を変更しよう。あなたのお好みの色に設定していただいて構わない。このチュートリアルでは、#5073a0ff を選択した。不透明度を下げた寒色系の色だ。\nGhost ルートノードにスクリプトをアタッチする 「Ghost」ルートノードにスクリプトをアタッチしよう。少しコーディングして以下の制御を実装する。\nゴーストが生成されたら徐々に消えるアニメーションを演出する ゴーストが完全に消えたらゴーストのインスタンスを解放する 先にも少し説明したが「Tween」クラスは特定のノードにおける一つのプロパティの値を滑らかに変化させるアニメーションが得意だ。シンプルなアニメーションなら、わざわざ「AnimationPlayer」クラスを利用しなくても「Tween」で表現できるということだ。\nでは「Ghost」ルートノードにスクリプトを新規作成してアタッチしよう。スクリプトのパスは「res://Player/Ghost.gd」とする。\nスクリプトエディタが開いたら、そのままコーディングしていこう。\nextends AnimatedSprite # Tween ノードの参照 onready var tween = $Tween func _ready(): # Ghost ノードの Modulate プロパティを #c85578b4 から #00ffffff へ　0.5秒かけて変化させる設定 tween.interpolate_property(self, \"modulate\", Color(\"c85578b4\"), Color(\"00ffffff\"), 0.5) # tween を開始 tween.start() これで「Ghost」シーンのインスタンスが生成された瞬間からゴーストの色味が次第に透明になる。「Tween」ノードのinterpolate_propertyメソッドの引数の多さに引き気味になりそうなのでこれを少し解説しておこう。\n第1引数: アニメーションさせたい対象のノードを指定する。ここではselfつまりこのスクリプトがアタッチされている「Ghost」ルートノードを指定している。 第2引数: 対象のプロパティを指定する。ここでは「Modulate」プロパティを指定した。 第3引数: アニメーション開始時のプロパティの値を指定する。ここでは先ほどインスペクターで編集した色と同じ #c85578b4 を指定している。 第4引数: アニメーション終了時のプロパティの値を指定する。今回、ゴーストには最終的に完全に消えて欲しいので、不透明度が 0 の #00ffffff を指定した。 第5引数: アニメーションにかける時間を秒単位で指定する。ここでは 0.5 秒とした。 第6引数（今回は省略）: アニメーションのトランジションタイプを組み込みの enum のパラメータから指定する。デフォルトで 0 が指定されている。0 は　TRANS_LINEAR で、常に一定の変化でアニメーションする。 第7引数（今回は省略）: アニメーションのイーズタイプを組み込みの enum のパラメータから指定する。デフォルトでは 2 が指定されている。2 は EASE_IN_OUT で、アニメーションの最初と最後の変化がゆっくりになる。 第8引数（今回は省略）: どれくらいアニメーションの再生を遅らせるかを秒単位で指定する。デフォルトで 0 が指定されている。 そして、生成された「Ghost」シーンのインスタンスをそのまま放置すると見た目は透明で見えなくても、実際には一つ一つのゴーストがメモリを消費したままの状態になる。これを避けるために、完全に透明になったらインスタンスを解放するようにしたい。ありがたいことに「Tween」には、アニメーション終了時に発信するシグナルが備わっているので、これを利用する。\nでは「Tween」ノードの「tween_completed(object: Object, key: NodePath)」を「Ghost.gd」スクリプトに接続しよう。接続したら自動生成された_on_Tween_tween_completedメソッドを以下のように編集して欲しい。\n# Tween ノードの tween が完了したらシグナルで呼ばれるメソッド func _on_Tween_tween_completed(object, key): # Ghost ノードを解放する queue_free() これで、ゴーストが透明になったらそのインスタンス（とメモリ）が解放される。\n以上で、「Ghost.gd」スクリプトの編集は完了だ。\nPlayer シーンに Timer を追加する 次に、一定間隔でゴーストを生成するためのタイマーを用意する。「Player」シーンの「Player」ルートノードに「Timer」クラスのノードを追加しよう。名前は「GhostTimer」に変更しておく。\nインスペクターで「GhostTimer」ノードのプロパティを以下のように編集する。\nWait Time: 0.1 One Shot: オン Player.gd スクリプトを編集する ではここから「Player.gd」スクリプトを編集していこう。ここで制御したいのは、プレイヤーキャラクターがダッシュしている間は、「GhostTimer」の残り時間が 0 秒になるたびに（0.1秒おきに）「Ghost」シーンのインスタンスを生成する、という内容だ。\nまずはプロパティを2つ新たに定義する。\n# GhostTimerノードの参照 onready var ghost_timer = $GhostTimer # 追加 # Ghost.tscnリソースファイルのプリロード onready var ghost_tscn = preload(\"res://Player/Ghost.tscn\") # 追加 続いて「Ghost」シーンのインスタンスを生成するメソッドspawn_ghostを新たに定義する。\nfunc spawn_ghost(): # プリロードしていた Ghost.tscn シーンをインスタンス化 var ghost = ghost_tscn.instance() # Ghost インスタンスノードを親ノード（Level_ノード）の子として追加 get_parent().add_child(ghost) # Ghost ノードの位置を Player ノードと同じにする ghost.global_position = global_position # Ghost ノードの Frames プロパティ（SpriteFramesリソース）を Player シーンの AnimatedSprite ノードと同じにする ghost.frames = sprite.frames # Ghost ノードの Animation プロパティを Player シーンの AnimatedSprite ノードと同じにする ghost.animation = sprite.animation # Ghost ノードの Frame プロパティを Player シーンの AnimatedSprite ノードと同じにする ghost.frame = sprite.frame # Ghost ノードの Flip H プロパティを Player シーンの AnimatedSprite ノードと同じにする ghost.flip_h = sprite.flip_h # GhostTimer ノードのタイマーを開始する ghost_timer.start() 「Ghost」シーンをインスタンス化した後、それを「Player」ノードではなく「Player」の親ノード（つまり「Level_」ノード）の子として追加しているのは、砂埃の時と同様だ。つまり、プレイヤーキャラクターの位置が移動しても、生成されたゴーストにはその場に止まってもらうようにするためだ。\nその後の処理としては、「Ghost」ノードの位置や「AnimatedSprite」クラスのプロパティである「SpriteFrames」のリソース、再生するアニメーション、アニメーションのフレーム数、そして左右反転するかどうかの「Flip H」プロパティの値を、「Player」ノードの子「AnimatedSprite」ノードのそれらの値と同じにしている。これで、その瞬間のプレイヤーキャラクターの見た目、位置、向きをそっくりそのまま適用したゴーストを生成することができる。\nそして最後に「GhostTimer」をスタートさせている。\n次に、定義したspawn_ghostメソッドを呼び出すあたりを実装していこう。編集するのは今回も_physics_processメソッドだ。\nfunc _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) sprite.speed_scale = 2 # ダッシュ時に GhostTimer の残り時間が 0 の時にゴーストを生成する if ghost_timer.time_left \u003c= 0: # 追加 spawn_ghost() else: velocity.x = clamp(velocity.x, -max_speed, max_speed) sprite.speed_scale = 1 sprite.flip_h = x_input \u003c 0 # 以下省略 上記編集により、プレイヤーキャラクターがダッシュしている間だけ、「GhostTimer」ノードの残り時間が 0 になるたび（0.1秒おき）にゴーストが生成される。\n以上でゴーストエフェクトに関するコーディングは完了だ。これも「Level1」シーンを実行して動作を確認しておこう。\n最後にプロジェクトを実行して、今回実装した以下のプレイヤーキャラクターの追加要素をまとめて確認してみよう。\n落下時のアニメーション 壁ジャンプ ダブルジャンプ 砂埃 ゴーストエフェクト Part 14 で編集したスクリプトのコード 最後に今回の Part 14 で編集したスクリプトのコードを共有しておくので、必要に応じて確認してほしい。\nPlayer.gd の全コード extends KinematicBody2D # Created @ Part 1 signal enemy_hit(damage) # Added @ Part 8 signal item_hit(point) # Added @ Part 8 export var acceleration = 256 export var max_speed = 64 export var max_dash_speed = 200 export var friction = 0.1 export var gravity = 512 export var jump_force = 224 export var air_resistance = 0.02 var velocity = Vector2() var can_wall_jump = false # Added @ Part 14 var can_double_jump = false # Added @ Part 14 onready var sprite = $AnimatedSprite onready var anim_player = $AnimationPlayer # Added @ Part 7 onready var step_sfx = $StepSFX # Added @ Part 13 onready var jump_sfx = $JumpSFX # Added @ Part 13 onready var damage_sfx = $DamageSFX # Added @ Part 13 onready var die_sfx = $DieSFX # Added @ Part 13 onready var ghost_timer = $GhostTimer # Added @ Part 14 onready var ghost_tscn = preload(\"res://Player/Ghost.tscn\") # Added @ Part 14 onready var dust_tscn = preload(\"res://Player/Dust.tscn\") # Added @ Part 14 func _ready(): # Added @ Part 7 sprite.position = Vector2(0, 0) sprite.scale = Vector2(1, 1) sprite.modulate = Color(1, 1, 1, 1) func _physics_process(delta): velocity.y += gravity * delta var x_input = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\") if x_input != 0: velocity.x += x_input * acceleration if Input.is_action_pressed(\"dash\"): velocity.x = clamp(velocity.x, -max_dash_speed, max_dash_speed) sprite.speed_scale = 2 # Added @ Part 14 if ghost_timer.time_left \u003c= 0: # Added @ Part 14 spawn_ghost() else: velocity.x = clamp(velocity.x, -max_speed, max_speed) sprite.speed_scale = 1 # Added @ Part 14 sprite.flip_h = x_input \u003c 0 if is_on_floor(): if x_input == 0: sprite.play(\"idle\") velocity.x = lerp(velocity.x, 0, friction) else: sprite.play(\"run\") spawn_dust() # Added @ Part 14 if Input.is_action_just_pressed(\"jump\"): can_double_jump = true # Added @ Part 14 sprite.play(\"jump\") velocity.y = -jump_force jump_sfx.play() # Added @ Part 13 else: if x_input == 0: velocity.x = lerp(velocity.x, 0, air_resistance) if Input.is_action_just_released(\"jump\") and velocity.y \u003c -jump_force / 2: velocity.y = -jump_force / 2 if velocity.y \u003e 0: # Added @ Part 14 sprite.play(\"fall\") if can_wall_jump: # Added @ Part 14 if Input.is_action_just_pressed(\"jump\"): print(\"wall jumped.\") velocity.y = -jump_force sprite.play(\"wall_jump\") jump_sfx.play() else: # Added @ Part 14 if can_double_jump: if Input.is_action_just_pressed(\"jump\"): print(\"double jumped.\") can_double_jump = false sprite.play(\"double_jump\") velocity.y = -jump_force jump_sfx.play() velocity = move_and_slide(velocity, Vector2.UP) # Added @ Part 3 if position.x \u003c 16: position.x = 16 func _on_HitBox_body_entered(body): # Added @ Part 8 if body.is_in_group(\"Enemies\"): print(\"Enemy hit player. Damage is \", body.damage) emit_signal(\"enemy_hit\", body.damage) sprite.play(\"hit\") damage_sfx.play() # Added @ Part 13 elif not body.name == \"Player\": # Added @ Part 14 if not is_on_floor(): can_wall_jump = true #print(\"can_wall_jump: \", can_wall_jump) func _on_HitBox_body_exited(body): # Added @ Part 14 can_wall_jump = false #print(\"can_wall_jump: \", can_wall_jump) func _on_AnimatedSprite_frame_changed(): # Added @ Part 13 if sprite.animation == \"run\": if sprite.frame == 4 or sprite.frame == 10: step_sfx.play() func spawn_dust(): var dust = dust_tscn.instance() get_parent().add_child(dust) dust.global_position = Vector2(global_position.x, global_position.y + 11) if Input.is_action_pressed(\"dash\"): dust.process_material.scale = 4 else: dust.process_material.scale = 2 dust.emitting = true yield(get_tree().create_timer(dust.amount * dust.lifetime), \"timeout\") dust.queue_free() func spawn_ghost(): # Added @ Part 14 var ghost = ghost_tscn.instance() get_parent().add_child(ghost) ghost.global_position = global_position ghost.frames = sprite.frames ghost.animation = sprite.animation ghost.frame = sprite.frame ghost.flip_h = sprite.flip_h ghost_timer.start() Ghost.gd の全コード extends AnimatedSprite onready var tween = $Tween func _ready(): tween.interpolate_property(self, \"modulate\", Color(\"c85578b4\"), Color(\"00ffffff\"), 0.5) tween.start() func _on_Tween_tween_completed(object, key): queue_free() おわりに 以上で Part 14 は完了だ。\n今回はプレイヤーキャラクターの動きをアップデートする要素をいくつか追加で実装した。壁ジャンプ、ダブルジャンプ、砂埃、ゴーストエフェクト、はどれもプラットフォーマーゲームでは定番のアクションだ。実装してプレイしてみると、操作している時の爽快感が飛躍的に上がる印象を受けた方は多いのではないだろうか。デベロッパーがこぞって実装したくなる理由を体感いただけたのではないだろうか。\n壁ジャンプとダブルジャンプは、それぞれのステート用の bool 型プロパティを用意し、該当のジャンプアクションが可能な時とそうでない時で true と false を切り替えて制御した。このようにステート用のプロパティを用いてプログラムを作ることはゲームのジャンルを問わずかなり多い。true と false の2択では賄えないステートを扱う場合は enum を利用したりもする。ちなみに、ステートによってキャラクターの動きを制御するようなプログラムをステートマシンまたはステートデザインパターンと呼ぶ。Google で検索すると資料がたくさん出てくるので、興味があれば是非確認してみよう。\n公式オンラインドキュメント: State design pattern 一方、砂埃やゴーストエフェクトは、オブジェクトのシーンを別で用意しておき、然るべきタイミングでそれらのインスタンスを連続的に追加し、一定時間後に解放する、という方法で実装した。砂埃の方は「Particles2D」のインスタンスは一つにして「One Shot」プロパティをオフにしても実装できそうだ。ゴーストエフェクトでは、インスタンスを敢えて「Player」ノードではなくその親ノードに追加した。プログラムの複雑さはできるだけ抑えたいものだが、目的に合わせて柔軟にプログラミングすることも重要である。\nさて、次回は最終回になる予定だ。内容は、ゲームクリア画面やポーズ画面という案もあったが、スタート画面やゲームオーバー画面の応用でしかないので、却下だ。データ保存やゲームのエクスポートもプラットフォーマーじゃなくてもできることなので却下だ。せっかくプラットフォーマーのチュートリアルなので、最後はステージ上にいくつかのギミックを追加してみようと思う。例えば、動く床、火が出る装置、スパイク、バネ仕掛けの床などはインポート済みのアセットにテクスチャがあるので、ボリュームが大きくなりすぎない範囲で実装してみたいと思う。\nそれでは次回もお楽しみに。\nReferences: How to make a Wall jump properly ? - Godot Engine - Q\u0026A\nGodot 3 - Make Your Character Double Jump / UmaiPixel - YouTube\n【Godot】残像エフェクトの作り方 / 2dgames.jp - Blog\n【Godot】Timerを使った残像エフェクトの作り方【Ghost Trail】/ tatsuya_ゲーム制作 - note\nMake a 2D Ghost effect in Godot / Mister Taft Creates - YouTube\n","wordCount":"13261","inLanguage":"ja","image":"https://www.peanuts-code.com/images/tutorials/gd0005_platformer/platformer_14/img24.gif","datePublished":"2022-04-14T02:07:00+09:00","dateModified":"2022-04-14T02:07:00+09:00","author":{"@type":"Person","name":"gobo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_14/"},"publisher":{"@type":"Organization","name":"Peanuts Code","logo":{"@type":"ImageObject","url":"https://www.peanuts-code.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.peanuts-code.com/ja/ accesskey=h title="Peanuts Code (Alt + H)"><img src=https://www.peanuts-code.com/images/logomark.png alt aria-label=logo height=35>Peanuts Code</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.peanuts-code.com/en/ title=English aria-label=🇬🇧English>🇬🇧English</a></li></ul></div></div><ul id=menu><li><a href=https://www.peanuts-code.com/ja/ title=ホーム><span>ホーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/portfolio/ title=ゲーム><span>ゲーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/posts/ title=ブログ><span>ブログ</span></a></li><li><a href=https://www.peanuts-code.com/ja/tutorials/ title=チュート><span>チュート</span></a></li><li><a href=https://www.peanuts-code.com/ja/about/ title=サイト紹介><span>サイト紹介</span></a></li><li><a href=https://www.peanuts-code.com/ja/search/ title="サイト内検索 (Alt + /)" accesskey=/><span>サイト内検索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.peanuts-code.com/ja/>ホーム</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/tutorials/>🤖 チュート</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/>🤖 シリーズ：Godot で作るプラットフォーマー</a></div><h1 class="post-title entry-hint-parent">Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！</h1><div class=post-meta><span title='2022-04-14 02:07:00 +0900 +0900'>2022-04-14</span>&nbsp;·&nbsp;27 分</div><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on x" href="https://x.com/intent/tweet/?text=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%20Part%2014%ef%bc%9a%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%e3%81%ae%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e3%82%a2%e3%83%83%e3%83%97%e3%83%87%e3%83%bc%e3%83%88%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f&amp;hashtags=GodotEngine%2cGameDev%2c2D%2c%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%b2%e3%83%bc%e3%83%a0%2c%e6%a8%aa%e3%82%b9%e3%82%af%e3%83%ad%e3%83%bc%e3%83%ab%2c%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%2c%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%2c%e3%82%b4%e3%83%bc%e3%82%b9%e3%83%88%e3%82%a8%e3%83%95%e3%82%a7%e3%82%af%e3%83%88%2c%e3%83%80%e3%83%96%e3%83%ab%e3%82%b8%e3%83%a3%e3%83%b3%e3%83%97%2c%e5%a3%81%e3%82%b8%e3%83%a3%e3%83%b3%e3%83%97%2c%e7%a0%82%e5%9f%83"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f&title=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%20Part%2014%ef%bc%9a%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%e3%81%ae%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e3%82%a2%e3%83%83%e3%83%97%e3%83%87%e3%83%bc%e3%83%88%e3%81%97%e3%82%88%e3%81%86%ef%bc%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><ul class=post-tags><li><a href=https://www.peanuts-code.com/ja/tags/godotengine/>GodotEngine</a></li><li><a href=https://www.peanuts-code.com/ja/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/2d/>2D</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B2%E3%83%BC%E3%83%A0/>アクションゲーム</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E6%A8%AA%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB/>横スクロール</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%BC/>プラットフォーマー</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%AD%E3%83%A3%E3%83%A9%E3%82%AF%E3%82%BF%E3%83%BC/>プレイヤーキャラクター</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%B4%E3%83%BC%E3%82%B9%E3%83%88%E3%82%A8%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88/>ゴーストエフェクト</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%80%E3%83%96%E3%83%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97/>ダブルジャンプ</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E5%A3%81%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97/>壁ジャンプ</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E7%A0%82%E5%9F%83/>砂埃</a></li></ul></header><figure class=entry-cover><img loading=eager src=https://www.peanuts-code.com/images/tutorials/gd0005_platformer/platformer_14/img24.gif alt="プラットフォーマー Part 14 サムネイル"></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#砂埃のシーンを作る>砂埃のシーンを作る</a></li><li><a href=#dust-ノードのプロパティを編集する>Dust ノードのプロパティを編集する</a></li></ul><ul><li><a href=#ゴーストのシーンを作る>ゴーストのシーンを作る</a></li><li><a href=#ノードのプロパティを編集する>ノードのプロパティを編集する</a></li><li><a href=#ghost-ルートノードにスクリプトをアタッチする>Ghost ルートノードにスクリプトをアタッチする</a></li><li><a href=#player-シーンに-timer-を追加する>Player シーンに Timer を追加する</a></li><li><a href=#playergd-スクリプトを編集する>Player.gd スクリプトを編集する</a></li></ul></nav></div></details></div><div class=post-content><p>第14回目の今回は、プレイヤーキャラクターのアクションをアップデートしていく。具体的には以下にリストアップしたジャンプとダッシュの動きや演出を追加していく。</p><ul><li>落下時のアニメーション</li><li>壁ジャンプ</li><li>ダブルジャンプ（2段ジャンプ）</li><li>走っている時の砂埃</li><li>ダッシュ時のゴーストエフェクト（残像効果）</li></ul><p>おまけのような内容だが、作って実際にプレイすると非常に楽しいところなので、是非やってみてほしい。</p><blockquote><p><em><strong><span style=color:salmon>Memo：</span></strong><br>過去のシリーズをまだご覧になっていない方は、そちらを先にご覧いただくことをおすすめします。<br><a href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/ title="Godot で作るプラットフォーマー">Godot で作るプラットフォーマー</a></em></p></blockquote><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=落下時のアニメーション>落下時のアニメーション</h1><p>実はチュートリアル Part 1 で実装しておけばいいのに放置したままなのが、この落下時のプレイヤーキャラクターのアニメーションだ。例えば、プレイヤーキャラクターがジャンプした時、現時点では地面から離れてまた地面に着地するまでずっと同じアニメーションだ。しかし今回、プレイヤーキャラクターがジャンプして一番高い位置まで達したあと、次に地面に着地するまでは別のアニメーションを再生するようにアップデートする。</p><p>実はアニメーション自体はチュートリアル Part 1 で、「Player」シーンの「AnimatedSprite」ノードに「fall」というアニメーションを作成済みだ。</p><blockquote><p><em><strong><span style=color:salmon>Memo:</span></strong><br><a href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_1/ title="Godot で作るプラットフォーマー Part 1：プレイヤーキャラクターを作ろう！">Godot で作るプラットフォーマー Part 1：プレイヤーキャラクターを作ろう！</a></em></p></blockquote><br><p>この作成済みのアニメーションを特定のタイミングで再生するようにスクリプトで制御する。</p><p>では「Player.gd」スクリプトを開いて編集しよう。編集するのはスクリプトの中の<code>_physics_process</code>メソッドだ。このメソッドの最後の方に「# 追加」とコメントしているところが更新箇所だ。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># 地面にいる場合</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>friction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>			<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1># 空中にいる場合</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>air_resistance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_released</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>		<span class=c1># y軸方向の速度が 0 より大きければ（下向きに落下）「fall」アニメーションを再生</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;fall&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nf>move_and_slide</span><span class=p>(</span><span class=n>velocity</span><span class=p>,</span> <span class=nc>Vector2</span><span class=o>.</span><span class=n>UP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>16</span>
</span></span></code></pre></div><br><p>コードの編集はこれだけだ。「Level1.tscn」シーンファイルを開いてシーンを実行して確認してみよう。一番高い位置までジャンプしたあとの落下時は「fall」アニメーションが再生されているのがわかるだろう。</p><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img2.gif alt=落下時のアニメーション確認でシーンを実行></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=壁ジャンプを実装する>壁ジャンプを実装する</h1><p>壁ジャンプというのは、プレイヤーキャラクターが壁に接触している状態からジャンプすることだ。これを利用して、マップによっては左右の壁を蹴りながら上方向に進むことができたり、画面下に落下しそうになった時に壁ジャンプで難を逃れたりすることができる。</p><p>壁ジャンプのアニメーションも、チュートリアル Part 1 ですでに作成済みだ。「Player」シーンの「AnimatedSprite」ノードの「wall_jump」アニメーションがそれだ。特定のタイミングでこのアニメーションを再生するように、のちほどスクリプトを編集する。</p><br><p>ところで、壁ジャンプを実装するにはプレイヤーキャラクターが壁に接触しているかどうかを判定する必要がある。これには「KinematicBody2D」クラスでもともと用意されている<code>is_on_wall</code>メソッドを使えば良い、と考えてしまいそうだが、実は少し扱いにくい。</p><p>このメソッドは、<code>move_and_slide</code>メソッドが最後に呼ばれた時（<code>_physics_process</code>メソッドで1フレーム前に呼ばれる）に壁と衝突していたら<code>true</code>を返すようだ。実際に検証してみたところ、常に壁に向かってプレイヤーキャラクターが移動しようとしている状態でなければ、検知し続けてくれないようだ。例えば、右側の壁にジャンプして<code>is_on_wall</code>メソッドで<code>true</code>を返させるにはには、空中で右矢印キーを押し続けなければならないが、壁ジャンプする時は壁と反対側にジャンプしたいものだ。右を押し続けている状態からジャンプすると、その直後はまだ右を押しているので、反対の左へ飛びにくい。この操作性の悪さから、このチュートリアルでは<code>is_on_wall</code>メソッドを利用する方法は不採用だ。</p><p>代わりの方法としてよく使われているのが、「Area2D」または「RayCast2D」クラスで壁との衝突を検出する方法だ。このチュートリアルでは、ちょうど「Player」ルートノードに「HitBox」という「Area2D」クラスのノードを追加している。このコリジョン形状は元々敵キャラクターとの衝突を検出するために利用しているが、壁との衝突にも流用してしまおうというわけだ。</p><p>では「Player.gd」スクリプトを更新していく。</p><p>まずは壁ジャンプが可能かどうかのステートを格納するプロパティ<code>can_wall_jump</code>を定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># 壁ジャンプ可能かどうかを示すプロパティ（壁ジャンプ可能な場合は true）</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>false</span> <span class=c1># 追加</span>
</span></span></code></pre></div><br><p>次に、壁が「Area2D」のコリジョン形状に入った時と出た時に発信されるシグナルを利用して、プレイヤーキャラクターが壁に接触しているかどうかを判定させたい。壁がコリジョン形状に入った時のシグナル「body_entered」はすでに接続済みだ。出た時のシグナル「body_exited」を新たにスクリプトに接続しよう。</p><p>これで<code>_on_HitBox_body_entered(body)</code>メソッドと、<code>_on_HitBox_body_exited(body)</code>メソッドの2つがスクリプト上で定義されている状態になったはずだ。</p><p>なお、タイルマップに使っているタイルセットの内、ブロック系のタイルはコリジョン形状を設定済み（<a href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_2/>チュートリアル Part 2</a>
）なので、物理ボディとして検知可能である。</p><p>ではそれぞれのメソッドを以下のように編集してほしい。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># 物理ボディがコリジョン形状に入った時に呼ばれるメソッド</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_HitBox_body_entered</span><span class=p>(</span><span class=n>body</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>body</span><span class=o>.</span><span class=nf>is_in_group</span><span class=p>(</span><span class=s2>&#34;Enemies&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Enemy hit player. Damage is &#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>.</span><span class=n>damage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>emit_signal</span><span class=p>(</span><span class=s2>&#34;enemy_hit&#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>.</span><span class=n>damage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;hit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>damage_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1># 衝突した物理ボディがプレイヤーキャラクター自身ではなかったら</span>
</span></span><span class=line><span class=cl>	<span class=k>elif</span> <span class=ow>not</span> <span class=n>body</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;Player&#34;</span><span class=p>::</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>		<span class=c1># 地面に衝突していなければ（空中だったら）</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=ow>not</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=c1># 壁ジャンプが可能な状態なのでステートを true にする</span>
</span></span><span class=line><span class=cl>			<span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 物理ボディがコリジョン形状から出て行った時に呼ばれるメソッド</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_HitBox_body_exited</span><span class=p>(</span><span class=n>body</span><span class=p>):</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>	<span class=c1># 壁ジャンプが不可の状態なのでステートを false にする</span>
</span></span><span class=line><span class=cl>	<span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>false</span>
</span></span></code></pre></div><p><code>elif not body.name == "Player":</code>の部分がわかりにくいかもしれないので少し詳しく解説しておきたいと思う。</p><p>「Player」シーンにおいて、「Player」ルートノードは「KinematicBody2D」クラス、つまり物理ボディだ。この「Player」のコリジョン形状は、壁の検知に再利用している「HitBox」のコリジョン形状と重なっている。そのため「HitBox」には常にこの「Player」が物理ボディとして検知されている状態になる。壁のみを検知したいので、<code>elif</code>の条件を『検知されたボディが「Player」以外だったら』という内容にしている。</p><p>ちなみに、もしこの<code>elif</code>の条件文がただの<code>else</code>文だと、空中だったらいつでも壁ジャンプができてしまう状態になるので、スーパーマリオブラザーズ3のしっぽマリオのように、ジャンプボタンを連打しておけば壁ジャンプで永遠に飛行できてしまうのだ。それはそれで面白いので、その状態を GIF 画像でお見せしておこう。</p><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img3.1.gif alt=壁ジャンプで永久飛行></p><br><p>では<code>_physics_process</code>メソッドを更新して、適切なタイミングでのみ壁ジャンプができるようにしていこう。「# 追加」のコメント箇所をみていただきたい。<code>if is_on_floor() / else</code>の<code>else</code>ブロックの中に<code>if can_wall_jump</code>ブロックを追加した。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>friction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>			<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>air_resistance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_released</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;fall&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=c1># 壁ジャンプ可能ステートであれば</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>can_wall_jump</span><span class=p>:</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>			<span class=c1># jump キー（上矢印）を押したら    </span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=c1># 速度のy軸方向の値にジャンプ力（上方向なのでマイナス）を適用する</span>
</span></span><span class=line><span class=cl>				<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>				<span class=c1># 壁ジャンプのアニメーションを再生する</span>
</span></span><span class=line><span class=cl>				<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;wall_jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=c1># ジャンプ時の SFX を再生する</span>
</span></span><span class=line><span class=cl>				<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nf>move_and_slide</span><span class=p>(</span><span class=n>velocity</span><span class=p>,</span> <span class=nc>Vector2</span><span class=o>.</span><span class=n>UP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>16</span>
</span></span></code></pre></div><p>壁ジャンプがうまく実装できたか「Level1」シーンを実行して見てみよう。テスト用に「Level1」シーンの「TileMap」ノードに適当な幅でブロックの壁を左右に作ると確認しやすい。</p><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img4.gif alt=壁ジャンプの確認のためLevel1シーンを実行></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=ダブルジャンプを実装する>ダブルジャンプを実装する</h1><p>ダブルジャンプ（2段ジャンプ）は、ジャンプ中に空中でさらにもう一回ジャンプするという、2Dアクションゲームではよく使われる定番のアクションである。</p><p>ダブルジャンプのアニメーションも、チュートリアル Part 1 ですでに作成済みだ。特定のタイミングで「AnimatedSprite」ノードの該当のアニメーションを再生するように、のちほどスクリプトを編集する。</p><p>ダブルジャンプがいつでも何回でもできてしまわないように、プレイヤーキャラクターが空中にいる間に一回だけできるように制御する必要がある。</p><p>では「Player.gd」スクリプトを編集していこう。</p><p>まずは、壁ジャンプと同様にダブルジャンプのステート用にプロパティを1つ定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># ダブルジャンプ可能かどうかを示すプロパティ（可能な場合は true）</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>false</span> <span class=c1># 追加</span>
</span></span></code></pre></div><br><p>続いて<code>_physics_process</code>メソッドをさらに更新する。ちょっとコードが長くなってきたが更新箇所は2箇所だけだ。「# 追加」のコメントを目印にして確認してほしい。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>friction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=c1># ダブルジャンプ可能ステートに変更</span>
</span></span><span class=line><span class=cl>			<span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>true</span>  <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>			<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>air_resistance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_released</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;fall&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>can_wall_jump</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>				<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;wall_jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>			<span class=c1># もしダブルジャンプ可能ステートだったら</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>can_double_jump</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1># jump アクションのキーを押したら</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>					<span class=c1># ダブルジャンプ不可ステートに変更</span>
</span></span><span class=line><span class=cl>					<span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>					<span class=c1># AnimatedSprite ノードの double_jump アニメーションを再生</span>
</span></span><span class=line><span class=cl>					<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;double_jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=c1># 速度のy軸方向の値にジャンプ力を適用</span>
</span></span><span class=line><span class=cl>					<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>					<span class=c1># ジャンプの SFX を再生</span>
</span></span><span class=line><span class=cl>					<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span></code></pre></div><p>まず<code>if is_on_floor() / else</code>構文の<code>if</code>ブロック内でネストされた<code>if Input.is_action_just_pressed("jump")</code>ブロックにて、<code>can_double_jump</code>プロパティを<code>true</code>にしてダブルジャンプ可能ステートにしている。これで、地面に接している状態からジャンプするときにダブルジャンプ可能ステートにリセットされる仕組みだ。</p><p><code>if is_on_floor() / else</code>構文の<code>else</code>ブロック内でネストされている<code>if can_wall_jump</code>の箇所に<code>else</code>ブロックを追加した。そしてそこに<code>if can_double_jump</code>の条件分岐をさらにネストした。これは空中ではダブルジャンプより壁ジャンプを優先するためだ。</p><p><code>if can_double_jump</code>のブロック内で、さらにネストした<code>if Input.is_action_just_pressed("jump")</code>（jump アクションキーを押したら）の条件分岐を追加した。この<code>if</code>構文のブロック内にダブルジャンプ実行時に必要なコードを記述した。処理内容の詳細はコード内のコメントを参照いただきたい。</p><p>さてこれでダブルジャンプが実装できたはずだ。空中で1回だけダブルジャンプできるか「Level1」シーンで試してみよう。</p><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img5.gif alt=ダブルジャンプの確認のためLevel1シーンを実行></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=走っている時の砂埃を実装する>走っている時の砂埃を実装する</h1><p>次は砂埃だ。現実には走って砂埃が大袈裟に舞うことはあまりないが、わかりやすい演出なので、プラットフォーマーゲームではよく採用されている。</p><p>実装の流れとしては、まず、砂埃のシーンを「Particles2D」クラスのノードで作成する。続いて、スクリプトで、走っている時だけ砂埃のシーンをインスタンス化して画面上に表示させる。</p><p>ではまず砂埃のシーン作成からやっていこう。</p><br><h2 id=砂埃のシーンを作る>砂埃のシーンを作る</h2><p>「シーン」＞「新規シーン」で表示される「ルートノード生成」で「その他のノード」を選択し、「Particles2D」クラスのノードをルートノードとして追加しよう。名前は「Dust」に変更する。これ以外のノードは不要だ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img6.png alt=ダブルジャンプの確認のためLevel1シーンを実行></p><p>名前を変更したら、そのままシーンを保存しておこう。ファイルパスを「res://Player/Dust.tscn」として保存しよう。</p><br><h2 id=dust-ノードのプロパティを編集する>Dust ノードのプロパティを編集する</h2><p>「Particles2D」クラスはプロパティが多いので少し大変だが、以下の通りに編集してみてほしい。編集するプロパティ以外はデフォルトのままにしておくこと。</p><p>まずは「Particles2D」クラスのプロパティから編集する。パーティクルの見た目や動きに関わる部分だ。</p><ul><li><p>Emitting: オフ（他のプロパティの設定が終わるまでは確認しやすいようにオンしておいて良い）</p></li><li><p>Amount: 4<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img7.png alt=Particles2Dノードのプロパティ1></p></li><li><p>Time:</p><ul><li>Lifetime: 0.2</li><li>One Shot: オン（他のプロパティの設定が終わるまでは確認しやすいようにオフにしておいて良い）</li><li>Speed Scale: 0.2<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img8.png alt=Particles2Dノードのプロパティ2></li></ul></li><li><p>Textures:</p><ul><li>Texture: ファイルシステムからリソース「res://Assets/Other/Dust Particle.png」を適用する<br>*<em>インスペクターでは少し下の方にあるプロパティだが 2D ワークスペースで見た目を確認するには先に設定すべき項目である</em><br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img9.png alt=Particles2Dノードのプロパティ3></li></ul></li><li><p>Process Material:</p><ul><li>Material: 新規 ParticlesMaterial を適用する<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img10.png alt=Particles2Dノードのプロパティ4><br><em>以下は「Material」プロパティに適用したリソースのプロパティ編集</em><ul><li>Gravity:<ul><li>Gravity: (0, -32, 0)<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img11.png alt=Particles2Dノードのプロパティ5></li></ul></li><li>Initial velocity:<ul><li>Velocity: 160<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img11.1.png alt=Particles2Dノードのプロパティ5></li></ul></li><li>Scale:<ul><li>Scale: 2</li><li>Scale Random: 1<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img12.png alt=Particles2Dノードのプロパティ6></li></ul></li><li>Color:<ul><li>Color: #a0ffffff</li><li>Color Ramp: 新規 GradientTexture を適用する<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img13.png alt=Particles2Dノードのプロパティ7><br><em>以下は「Color Ramp」プロパティに適用したリソースのプロパティ編集</em><ul><li>Gradient: 新規 Gradient<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img13.1.png alt=Particles2Dノードのプロパティ7><br><em>以下は「Gradient」プロパティに適用したリソースのプロパティ編集</em><ul><li>Offset: PoolFloatArray(size 3)<ul><li>サイズ: 3</li><li>0: 0.003</li><li>1: 0.711</li><li>2: 1<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img13.2.png alt=Particles2Dノードのプロパティ7></li></ul></li><li>Colors: PoolColorArray(size 3)<ul><li>サイズ: 3</li><li>0: #00ffffff</li><li>1: #50ffffff</li><li>2: #4affffff<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img13.3.png alt=Particles2Dノードのプロパティ7></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul><p>最後に「Node2D」クラスのプロパティを編集する。これはプレイヤーキャラクターより常に背面に表示させるための設定だ。</p><ul><li>Z Index:<br>Z Index: -1<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img14.png alt=Particles2Dノードのプロパティ7></li></ul><p>2Dワークスペースでは以下のようなアニメーションになっているはずだ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img15.gif alt=パーティクルの確認></p><p>確認し終わったら「Emitting」プロパティをオフに、「Time」＞「One Shot」プロパティをオンすることを忘れないようにしよう。</p><br><p>では今作った「Dust.tscn」シーンのインスタンスを「Player」シーンに追加する。ただし、プレイヤーキャラクターが走っている時だけ都度インスタンスを追加したいので、「Player.gd」スクリプト内にそれをコーディングしよう。</p><p>「Player.gd」スクリプトを開いたら、まずは<code>preload</code>した「Dust.tscn」シーンファイルを参照するプロパティを定義しよう。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># Dust.tscn シーンのプリロード</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>dust_tscn</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://Player/Dust.tscn&#34;</span><span class=p>)</span> <span class=c1># 追加</span>
</span></span></code></pre></div><br><p>次に以下の<code>spawn_dust</code>メソッドを新たに定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># 砂埃を生み出すメソッド</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>spawn_dust</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=c1># プリロードした Dust.tscn シーンをインスタンス化</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>dust</span> <span class=o>=</span> <span class=n>dust_tscn</span><span class=o>.</span><span class=nf>instance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1># Player ノードではなくその親（Level_ノード）の子として Dust.tscn のインスタンスノードを追加</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_parent</span><span class=p>()</span><span class=o>.</span><span class=nf>add_child</span><span class=p>(</span><span class=n>dust</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1># Dust の位置を Player の位置の y 軸方向に 11 だけ下の位置に配置（足元に来るように）</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=n>global_position</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=n>global_position</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>global_position</span><span class=o>.</span><span class=n>y</span> <span class=o>+</span> <span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1># ダッシュ中の場合</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=c1># 砂埃のマテリアルのサイズを最大4倍にする</span>
</span></span><span class=line><span class=cl>		<span class=n>dust</span><span class=o>.</span><span class=n>process_material</span><span class=o>.</span><span class=n>scale</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>	<span class=c1># ダッシュ中ではない場合</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1># 砂埃のマテリアルのサイズを最大2倍にする</span>
</span></span><span class=line><span class=cl>		<span class=n>dust</span><span class=o>.</span><span class=n>process_material</span><span class=o>.</span><span class=n>scale</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=c1># Dust の Emitting プロパティをオンにする</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=n>emitting</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=c1># Dust の One Shot の Emitting が終わるまで待機</span>
</span></span><span class=line><span class=cl>	<span class=k>yield</span><span class=p>(</span><span class=nf>get_tree</span><span class=p>()</span><span class=o>.</span><span class=nf>create_timer</span><span class=p>(</span><span class=n>dust</span><span class=o>.</span><span class=n>amount</span> <span class=o>*</span> <span class=n>dust</span><span class=o>.</span><span class=n>lifetime</span><span class=p>),</span> <span class=s2>&#34;timeout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1># 追加した Dust のインスタンスを解放</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=nf>queue_free</span><span class=p>()</span>
</span></span></code></pre></div><p>このメソッドを少し解説しておく。まず「Dust」シーンをインスタンス化した後、それを「Player」ノードではなく「Player」の親ノード（つまり「Level_」ノード）の子として追加されている。つまり「Player」ノードと「Dust」ノードはシーンツリー上、同階層になる。</p><p>なぜ「Player」ノードに直接追加しないかというと、子ノードの位置は親ノードとの相対的な位置を維持し続けるため、もし「Player」ノードの子として「Dust」ノードを追加すると、プレイヤーキャラクターの位置が移動するのに連動して、生成された砂埃も一緒に移動してしまうからだ。砂埃には生成されたらその場に止まってもらう必要があるので、敢えて「Player」ではなく一階層上の「Level_」シーンのルートノードの子にしているというわけだ。</p><br><p>さて、ここからはまた<code>_physics_process</code>メソッドを編集する。</p><p>上記<code>spawn_dust</code>メソッドをプレイヤーキャラクターが走っている時に呼ぶようにするには、<code>if is_on_floor()</code>ブロック内でネストされた<code>if x_input == 0 / else</code>構文の<code>else</code>ブロック内の<code>sprite.play("run")</code>のコードの後に<code>spawn_dust</code>メソッドを追加しよう。これで、走っている間だけ砂埃が舞うようになる。</p><p><code>if x_input != 0</code>ブロックのネストされた<code>if Input.is_action_pressed("dash")</code>ブロックのコードを、ダッシュ時は「AnimatedSprite」の「run」アニメーションが2倍速で再生されるように更新しておく。これで「プレイヤーキャラクターの動きが速くなったから砂埃も増えた」という演出になる。「# 追加」とコメントしている箇所を確認してほしい。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1># ダッシュ時はAnimatedSpriteのアニメーションのスピードを2倍にする</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>2</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1># ダッシュしていない時はAnimatedSpriteのアニメーションのスピードを通常にする</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>1</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>friction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1># 砂埃を発生するメソッドを呼ぶ</span>
</span></span><span class=line><span class=cl>			<span class=nf>spawn_dust</span><span class=p>()</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=c1># 中略</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1># 中略</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nf>move_and_slide</span><span class=p>(</span><span class=n>velocity</span><span class=p>,</span> <span class=nc>Vector2</span><span class=o>.</span><span class=n>UP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>16</span>
</span></span></code></pre></div><br><p>では「Level1」シーンで確認してみよう。下のGIF画像は 12 FPS なので少しわかりづらいところがあるが、実際のダッシュ時のアニメーションはスムーズだ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img16.gif alt=砂埃の確認></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=ダッシュ時にゴーストエフェクトを追加する>ダッシュ時にゴーストエフェクトを追加する</h1><p>さて、最後はゴーストエフェクトだ。残像効果とも言う。プラットフォーマー、メトロイドバニア、キャッスルバニアなど横スクロールアクションのジャンルで多用される、視覚的にとてもかっこいい演出だ。</p><p>こちらも砂埃を実装した時と考え方は同様で、まずゴーストの雛形となるシーンを作成し、そのインスタンスをダッシュ時にキャラクターの位置に配置し、一定時間経過後に追加したインスタンスを解放するという手法だ。</p><p>ではシーンを作るところから始めよう。</p><br><h2 id=ゴーストのシーンを作る>ゴーストのシーンを作る</h2><p>「シーン」＞「新規シーン」で表示される「ルートノード生成」で「その他のノード」を選択し、「Player」シーンのノードに合わせて、「AnimatedSprite」クラスのノードをルートノードとして追加しよう。名前を「Ghost」に変更したら、ファイルパスを「res://Player/Ghost.tscn」としてシーンを保存しよう。</p><p>次に「Ghost」ルートノードに「Tween」クラスのノードを一つ追加する。このノードはシンプルなアニメーション（トランジション）をお手軽に実装するためによく使用される。</p><blockquote><p><em><strong><span style=color:salmon>公式オンラインドキュメント</span></strong><br><a href=https://docs.godotengine.org/ja/stable/classes/class_tween.html target=_blank>Tween</a></em></p></blockquote><p>シーンツリーは以下のスクリーンショットのようになったはずだ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img17.png alt=Ghostシーンツリー></p><br><h2 id=ノードのプロパティを編集する>ノードのプロパティを編集する</h2><p>シーンツリードックを見ると「Ghost」ルートノードに⚠️マークが表示されている。これは「AnimatedSprite」クラスのノードには「Frames」プロパティに「SpriteFrames」リソースを適用する必要があるからだ。しかし、今回はシーンをインスタンス化する時に、スクリプトでリソースを適用するので、インスペクター上「Frames」プロパティは[空]のままで良い。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img17.1.png alt=GhostノードFramesプロパティは[空]></p><p>少し詳しく解説しておこう。ゴーストエフェクトは、ゴーストが生成される時点でのプレイヤーキャラクターの見た目、位置、向きをそのままコピーして生成する必要がある。つまり「Ghost」シーンをインスタンス化するタイミングで、「Player」シーンの「AnimatedSprite」ノードの下記プロパティの値を「Ghost」ルートノードの同じプロパティに割り当てる必要があるのだ。</p><ul><li>「Frames」プロパティの値（「SpriteFrames」リソース）</li><li>「Animation」プロパティの値（「run」アニメーション）</li><li>「Frame」プロパティの値</li><li>「Position」プロパティの値（正確には「global_position」プロパティの値）</li><li>「Flip H」プロパティの値</li></ul><p>これらの値はゴーストが生成されるその時々によって変わるため、前もってインスペクター上で設定することができないのだ。</p><br><p>一方、インスペクター上で編集すべきプロパティはあるので順番に見ていこう。</p><p>「Z Index」＞「Z Index」プロパティの値を -2 にしておく。これはプレイヤーキャラクターより背面に表示させている砂埃のインスタンス（こちらの「Z Index」は -1）よりさらに背面に表示させたいからだ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img18.png alt="GhostのZ Indexプロパティ"></p><p>そして生成されるゴーストの色味も設定しておきたい。「Visibility」＞「Modulate」プロパティの値を変更しよう。あなたのお好みの色に設定していただいて構わない。このチュートリアルでは、#5073a0ff を選択した。不透明度を下げた寒色系の色だ。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img19.png alt="GhostのZ Indexプロパティ"></p><br><h2 id=ghost-ルートノードにスクリプトをアタッチする>Ghost ルートノードにスクリプトをアタッチする</h2><p>「Ghost」ルートノードにスクリプトをアタッチしよう。少しコーディングして以下の制御を実装する。</p><ol><li>ゴーストが生成されたら徐々に消えるアニメーションを演出する</li><li>ゴーストが完全に消えたらゴーストのインスタンスを解放する</li></ol><p>先にも少し説明したが「Tween」クラスは特定のノードにおける一つのプロパティの値を滑らかに変化させるアニメーションが得意だ。シンプルなアニメーションなら、わざわざ「AnimationPlayer」クラスを利用しなくても「Tween」で表現できるということだ。</p><p>では「Ghost」ルートノードにスクリプトを新規作成してアタッチしよう。スクリプトのパスは「res://Player/Ghost.gd」とする。</p><p>スクリプトエディタが開いたら、そのままコーディングしていこう。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>extends</span> <span class=nc>AnimatedSprite</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tween ノードの参照</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>tween</span> <span class=o>=</span> <span class=nx>$Tween</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの Modulate プロパティを #c85578b4 から #00ffffff へ　0.5秒かけて変化させる設定</span>
</span></span><span class=line><span class=cl>	<span class=n>tween</span><span class=o>.</span><span class=nf>interpolate_property</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;modulate&#34;</span><span class=p>,</span> <span class=nc>Color</span><span class=p>(</span><span class=s2>&#34;c85578b4&#34;</span><span class=p>),</span> <span class=nc>Color</span><span class=p>(</span><span class=s2>&#34;00ffffff&#34;</span><span class=p>),</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1># tween を開始</span>
</span></span><span class=line><span class=cl>	<span class=n>tween</span><span class=o>.</span><span class=nf>start</span><span class=p>()</span>
</span></span></code></pre></div><p>これで「Ghost」シーンのインスタンスが生成された瞬間からゴーストの色味が次第に透明になる。「Tween」ノードの<code>interpolate_property</code>メソッドの引数の多さに引き気味になりそうなのでこれを少し解説しておこう。</p><ul><li>第1引数: アニメーションさせたい対象のノードを指定する。ここでは<code>self</code>つまりこのスクリプトがアタッチされている「Ghost」ルートノードを指定している。</li><li>第2引数: 対象のプロパティを指定する。ここでは「Modulate」プロパティを指定した。</li><li>第3引数: アニメーション開始時のプロパティの値を指定する。ここでは先ほどインスペクターで編集した色と同じ #c85578b4 を指定している。</li><li>第4引数: アニメーション終了時のプロパティの値を指定する。今回、ゴーストには最終的に完全に消えて欲しいので、不透明度が 0 の #00ffffff を指定した。</li><li>第5引数: アニメーションにかける時間を秒単位で指定する。ここでは 0.5 秒とした。</li><li>第6引数（今回は省略）: アニメーションのトランジションタイプを組み込みの enum のパラメータから指定する。デフォルトで 0 が指定されている。0 は　TRANS_LINEAR で、常に一定の変化でアニメーションする。</li><li>第7引数（今回は省略）: アニメーションのイーズタイプを組み込みの enum のパラメータから指定する。デフォルトでは 2 が指定されている。2 は EASE_IN_OUT で、アニメーションの最初と最後の変化がゆっくりになる。</li><li>第8引数（今回は省略）: どれくらいアニメーションの再生を遅らせるかを秒単位で指定する。デフォルトで 0 が指定されている。</li></ul><br><p>そして、生成された「Ghost」シーンのインスタンスをそのまま放置すると見た目は透明で見えなくても、実際には一つ一つのゴーストがメモリを消費したままの状態になる。これを避けるために、完全に透明になったらインスタンスを解放するようにしたい。ありがたいことに「Tween」には、アニメーション終了時に発信するシグナルが備わっているので、これを利用する。</p><p>では「Tween」ノードの「tween_completed(object: Object, key: NodePath)」を「Ghost.gd」スクリプトに接続しよう。接続したら自動生成された<code>_on_Tween_tween_completed</code>メソッドを以下のように編集して欲しい。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># Tween ノードの tween が完了したらシグナルで呼ばれるメソッド</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_Tween_tween_completed</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードを解放する</span>
</span></span><span class=line><span class=cl>	<span class=nf>queue_free</span><span class=p>()</span>
</span></span></code></pre></div><p>これで、ゴーストが透明になったらそのインスタンス（とメモリ）が解放される。</p><p>以上で、「Ghost.gd」スクリプトの編集は完了だ。</p><br><h2 id=player-シーンに-timer-を追加する>Player シーンに Timer を追加する</h2><p>次に、一定間隔でゴーストを生成するためのタイマーを用意する。「Player」シーンの「Player」ルートノードに「Timer」クラスのノードを追加しよう。名前は「GhostTimer」に変更しておく。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img21.png alt=GhostTimerノードを追加></p><br><p>インスペクターで「GhostTimer」ノードのプロパティを以下のように編集する。</p><ul><li>Wait Time: 0.1</li><li>One Shot: オン</li></ul><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img22.png alt=GhostTimerのプロパティ></p><br><h2 id=playergd-スクリプトを編集する>Player.gd スクリプトを編集する</h2><p>ではここから「Player.gd」スクリプトを編集していこう。ここで制御したいのは、プレイヤーキャラクターがダッシュしている間は、「GhostTimer」の残り時間が 0 秒になるたびに（0.1秒おきに）「Ghost」シーンのインスタンスを生成する、という内容だ。</p><p>まずはプロパティを2つ新たに定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># GhostTimerノードの参照</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>ghost_timer</span> <span class=o>=</span> <span class=nx>$GhostTimer</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl><span class=c1># Ghost.tscnリソースファイルのプリロード</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>ghost_tscn</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://Player/Ghost.tscn&#34;</span><span class=p>)</span> <span class=c1># 追加</span>
</span></span></code></pre></div><br><p>続いて「Ghost」シーンのインスタンスを生成するメソッド<code>spawn_ghost</code>を新たに定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>spawn_ghost</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=c1># プリロードしていた Ghost.tscn シーンをインスタンス化</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>ghost</span> <span class=o>=</span> <span class=n>ghost_tscn</span><span class=o>.</span><span class=nf>instance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost インスタンスノードを親ノード（Level_ノード）の子として追加</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_parent</span><span class=p>()</span><span class=o>.</span><span class=nf>add_child</span><span class=p>(</span><span class=n>ghost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの位置を Player ノードと同じにする</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>global_position</span> <span class=o>=</span> <span class=n>global_position</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの Frames プロパティ（SpriteFramesリソース）を Player シーンの AnimatedSprite ノードと同じにする</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>frames</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frames</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの Animation プロパティを Player シーンの AnimatedSprite ノードと同じにする</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>animation</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>animation</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの Frame プロパティを Player シーンの AnimatedSprite ノードと同じにする</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>frame</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frame</span>
</span></span><span class=line><span class=cl>	<span class=c1># Ghost ノードの Flip H プロパティを Player シーンの AnimatedSprite ノードと同じにする</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span>
</span></span><span class=line><span class=cl>	<span class=c1># GhostTimer ノードのタイマーを開始する</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost_timer</span><span class=o>.</span><span class=nf>start</span><span class=p>()</span>
</span></span></code></pre></div><p>「Ghost」シーンをインスタンス化した後、それを「Player」ノードではなく「Player」の親ノード（つまり「Level_」ノード）の子として追加しているのは、砂埃の時と同様だ。つまり、プレイヤーキャラクターの位置が移動しても、生成されたゴーストにはその場に止まってもらうようにするためだ。</p><p>その後の処理としては、「Ghost」ノードの位置や「AnimatedSprite」クラスのプロパティである「SpriteFrames」のリソース、再生するアニメーション、アニメーションのフレーム数、そして左右反転するかどうかの「Flip H」プロパティの値を、「Player」ノードの子「AnimatedSprite」ノードのそれらの値と同じにしている。これで、その瞬間のプレイヤーキャラクターの見た目、位置、向きをそっくりそのまま適用したゴーストを生成することができる。</p><p>そして最後に「GhostTimer」をスタートさせている。</p><p>次に、定義した<code>spawn_ghost</code>メソッドを呼び出すあたりを実装していこう。編集するのは今回も<code>_physics_process</code>メソッドだ。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>			<span class=c1># ダッシュ時に GhostTimer の残り時間が 0 の時にゴーストを生成する</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>ghost_timer</span><span class=o>.</span><span class=n>time_left</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span> <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>				<span class=nf>spawn_ghost</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 以下省略</span>
</span></span></code></pre></div><p>上記編集により、プレイヤーキャラクターがダッシュしている間だけ、「GhostTimer」ノードの残り時間が 0 になるたび（0.1秒おき）にゴーストが生成される。<br><br></p><p>以上でゴーストエフェクトに関するコーディングは完了だ。これも「Level1」シーンを実行して動作を確認しておこう。<br><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img23.gif alt=ゴーストエフェクトの確認></p><br><p>最後にプロジェクトを実行して、今回実装した以下のプレイヤーキャラクターの追加要素をまとめて確認してみよう。</p><ul><li>落下時のアニメーション</li><li>壁ジャンプ</li><li>ダブルジャンプ</li><li>砂埃</li><li>ゴーストエフェクト</li></ul><p><img loading=lazy src=/images/tutorials/gd0005_platformer/platformer_14/img24.gif alt=プロジェクトを実行して全ての追加要素をまとめて確認></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h1 id=part-14-で編集したスクリプトのコード>Part 14 で編集したスクリプトのコード</h1><p>最後に今回の Part 14 で編集したスクリプトのコードを共有しておくので、必要に応じて確認してほしい。</p><details><summary>Player.gd の全コード</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>extends</span> <span class=nc>KinematicBody2D</span> <span class=c1># Created @ Part 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>signal</span> <span class=nf>enemy_hit</span><span class=p>(</span><span class=n>damage</span><span class=p>)</span> <span class=c1># Added @ Part 8</span>
</span></span><span class=line><span class=cl><span class=kd>signal</span> <span class=nf>item_hit</span><span class=p>(</span><span class=n>point</span><span class=p>)</span> <span class=c1># Added @ Part 8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>acceleration</span> <span class=o>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>max_speed</span> <span class=o>=</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>max_dash_speed</span> <span class=o>=</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>friction</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>gravity</span> <span class=o>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>jump_force</span> <span class=o>=</span> <span class=mi>224</span>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=kd>var</span> <span class=n>air_resistance</span> <span class=o>=</span> <span class=mf>0.02</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>velocity</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>false</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>false</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>sprite</span> <span class=o>=</span> <span class=nx>$AnimatedSprite</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>anim_player</span> <span class=o>=</span> <span class=nx>$AnimationPlayer</span> <span class=c1># Added @ Part 7</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>step_sfx</span> <span class=o>=</span> <span class=nx>$StepSFX</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>jump_sfx</span> <span class=o>=</span> <span class=nx>$JumpSFX</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>damage_sfx</span> <span class=o>=</span> <span class=nx>$DamageSFX</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>die_sfx</span> <span class=o>=</span> <span class=nx>$DieSFX</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>ghost_timer</span> <span class=o>=</span> <span class=nx>$GhostTimer</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>ghost_tscn</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://Player/Ghost.tscn&#34;</span><span class=p>)</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>dust_tscn</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://Player/Dust.tscn&#34;</span><span class=p>)</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_ready</span><span class=p>():</span> <span class=c1># Added @ Part 7</span>
</span></span><span class=line><span class=cl>	<span class=n>sprite</span><span class=o>.</span><span class=n>position</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sprite</span><span class=o>.</span><span class=n>scale</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sprite</span><span class=o>.</span><span class=n>modulate</span> <span class=o>=</span> <span class=nc>Color</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>+=</span> <span class=n>gravity</span> <span class=o>*</span> <span class=n>delta</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>x_input</span> <span class=o>=</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>get_action_strength</span><span class=p>(</span><span class=s2>&#34;move_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>x_input</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>+=</span> <span class=n>x_input</span> <span class=o>*</span> <span class=n>acceleration</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_dash_speed</span><span class=p>,</span> <span class=n>max_dash_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>2</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>ghost_timer</span><span class=o>.</span><span class=n>time_left</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>				<span class=nf>spawn_ghost</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>clamp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>max_speed</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=n>speed_scale</span> <span class=o>=</span> <span class=mi>1</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>x_input</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;idle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>friction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;run&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>spawn_dust</span><span class=p>()</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>true</span>  <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>			<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>x_input</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=nb>lerp</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>air_resistance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_released</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>			<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;fall&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>can_wall_jump</span><span class=p>:</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;wall jumped.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>				<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;wall_jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>can_double_jump</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>					<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;double jumped.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=n>can_double_jump</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>					<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;double_jump&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>jump_force</span>
</span></span><span class=line><span class=cl>					<span class=n>jump_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=n>velocity</span> <span class=o>=</span> <span class=nf>move_and_slide</span><span class=p>(</span><span class=n>velocity</span><span class=p>,</span> <span class=nc>Vector2</span><span class=o>.</span><span class=n>UP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># Added @ Part 3</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_HitBox_body_entered</span><span class=p>(</span><span class=n>body</span><span class=p>):</span> <span class=c1># Added @ Part 8</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>body</span><span class=o>.</span><span class=nf>is_in_group</span><span class=p>(</span><span class=s2>&#34;Enemies&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Enemy hit player. Damage is &#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>.</span><span class=n>damage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>emit_signal</span><span class=p>(</span><span class=s2>&#34;enemy_hit&#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>.</span><span class=n>damage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sprite</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;hit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>damage_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl>	<span class=k>elif</span> <span class=ow>not</span> <span class=n>body</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;Player&#34;</span><span class=p>:</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=ow>not</span> <span class=nf>is_on_floor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=c1>#print(&#34;can_wall_jump: &#34;, can_wall_jump)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_HitBox_body_exited</span><span class=p>(</span><span class=n>body</span><span class=p>):</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>	<span class=n>can_wall_jump</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=c1>#print(&#34;can_wall_jump: &#34;, can_wall_jump)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_AnimatedSprite_frame_changed</span><span class=p>():</span> <span class=c1># Added @ Part 13</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>sprite</span><span class=o>.</span><span class=n>animation</span> <span class=o>==</span> <span class=s2>&#34;run&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frame</span> <span class=o>==</span> <span class=mi>4</span>  <span class=ow>or</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frame</span> <span class=o>==</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>step_sfx</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>spawn_dust</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>dust</span> <span class=o>=</span> <span class=n>dust_tscn</span><span class=o>.</span><span class=nf>instance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_parent</span><span class=p>()</span><span class=o>.</span><span class=nf>add_child</span><span class=p>(</span><span class=n>dust</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=n>global_position</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=n>global_position</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>global_position</span><span class=o>.</span><span class=n>y</span> <span class=o>+</span> <span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_pressed</span><span class=p>(</span><span class=s2>&#34;dash&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>dust</span><span class=o>.</span><span class=n>process_material</span><span class=o>.</span><span class=n>scale</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>dust</span><span class=o>.</span><span class=n>process_material</span><span class=o>.</span><span class=n>scale</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=n>emitting</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>yield</span><span class=p>(</span><span class=nf>get_tree</span><span class=p>()</span><span class=o>.</span><span class=nf>create_timer</span><span class=p>(</span><span class=n>dust</span><span class=o>.</span><span class=n>amount</span> <span class=o>*</span> <span class=n>dust</span><span class=o>.</span><span class=n>lifetime</span><span class=p>),</span> <span class=s2>&#34;timeout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>dust</span><span class=o>.</span><span class=nf>queue_free</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>spawn_ghost</span><span class=p>():</span> <span class=c1># Added @ Part 14</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=n>ghost</span> <span class=o>=</span> <span class=n>ghost_tscn</span><span class=o>.</span><span class=nf>instance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_parent</span><span class=p>()</span><span class=o>.</span><span class=nf>add_child</span><span class=p>(</span><span class=n>ghost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>global_position</span> <span class=o>=</span> <span class=n>global_position</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>frames</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frames</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>animation</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>animation</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>frame</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>frame</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>flip_h</span>
</span></span><span class=line><span class=cl>	<span class=n>ghost_timer</span><span class=o>.</span><span class=nf>start</span><span class=p>()</span>
</span></span></code></pre></div></details><br><details><summary>Ghost.gd の全コード</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>extends</span> <span class=nc>AnimatedSprite</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>onready</span> <span class=kd>var</span> <span class=n>tween</span> <span class=o>=</span> <span class=nx>$Tween</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>tween</span><span class=o>.</span><span class=nf>interpolate_property</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;modulate&#34;</span><span class=p>,</span> <span class=nc>Color</span><span class=p>(</span><span class=s2>&#34;c85578b4&#34;</span><span class=p>),</span> <span class=nc>Color</span><span class=p>(</span><span class=s2>&#34;00ffffff&#34;</span><span class=p>),</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>tween</span><span class=o>.</span><span class=nf>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_Tween_tween_completed</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=nf>queue_free</span><span class=p>()</span>
</span></span></code></pre></div></details><br><hr><h1 id=おわりに>おわりに</h1><p>以上で Part 14 は完了だ。</p><p>今回はプレイヤーキャラクターの動きをアップデートする要素をいくつか追加で実装した。壁ジャンプ、ダブルジャンプ、砂埃、ゴーストエフェクト、はどれもプラットフォーマーゲームでは定番のアクションだ。実装してプレイしてみると、操作している時の爽快感が飛躍的に上がる印象を受けた方は多いのではないだろうか。デベロッパーがこぞって実装したくなる理由を体感いただけたのではないだろうか。</p><p>壁ジャンプとダブルジャンプは、それぞれのステート用の bool 型プロパティを用意し、該当のジャンプアクションが可能な時とそうでない時で true と false を切り替えて制御した。このようにステート用のプロパティを用いてプログラムを作ることはゲームのジャンルを問わずかなり多い。true と false の2択では賄えないステートを扱う場合は enum を利用したりもする。ちなみに、ステートによってキャラクターの動きを制御するようなプログラムをステートマシンまたはステートデザインパターンと呼ぶ。Google で検索すると資料がたくさん出てくるので、興味があれば是非確認してみよう。</p><blockquote><p><em><strong><span style=color:salmon>公式オンラインドキュメント:</span></strong><br><a href=https://docs.godotengine.org/en/3.3/tutorials/misc/state_design_pattern.html target=_blank>State design pattern</a></em></p></blockquote><p>一方、砂埃やゴーストエフェクトは、オブジェクトのシーンを別で用意しておき、然るべきタイミングでそれらのインスタンスを連続的に追加し、一定時間後に解放する、という方法で実装した。砂埃の方は「Particles2D」のインスタンスは一つにして「One Shot」プロパティをオフにしても実装できそうだ。ゴーストエフェクトでは、インスタンスを敢えて「Player」ノードではなくその親ノードに追加した。プログラムの複雑さはできるだけ抑えたいものだが、目的に合わせて柔軟にプログラミングすることも重要である。</p><p>さて、次回は最終回になる予定だ。内容は、ゲームクリア画面やポーズ画面という案もあったが、スタート画面やゲームオーバー画面の応用でしかないので、却下だ。データ保存やゲームのエクスポートもプラットフォーマーじゃなくてもできることなので却下だ。せっかくプラットフォーマーのチュートリアルなので、最後はステージ上にいくつかのギミックを追加してみようと思う。例えば、動く床、火が出る装置、スパイク、バネ仕掛けの床などはインポート済みのアセットにテクスチャがあるので、ボリュームが大きくなりすぎない範囲で実装してみたいと思う。</p><p>それでは次回もお楽しみに。</p><blockquote><p><em><strong><span style=color:salmon>References:</span></strong><br><a href=https://godotengine.org/qa/25233/how-to-make-a-wall-jump-properly target=_blank>How to make a Wall jump properly ?</a>
- Godot Engine - Q&amp;A<br><a href=https://youtu.be/9lwI-dGvxk8 target=_blank>Godot 3 - Make Your Character Double Jump / UmaiPixel</a>
- YouTube<br><a href=https://2dgames.jp/godot-ghost_effect/ target=_blank>【Godot】残像エフェクトの作り方 / 2dgames.jp</a>
- Blog<br><a href=https://note.com/tatsuya_game/n/nf9b8ae31f7b1 target=_blank>【Godot】Timerを使った残像エフェクトの作り方【Ghost Trail】/ tatsuya_ゲーム制作</a>
- note<br><a href=https://youtu.be/_8AzOdLuUyA target=_blank>Make a 2D Ghost effect in Godot / Mister Taft Creates</a>
- YouTube</em></p></blockquote><hr></div><footer class=post-footer><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on x" href="https://x.com/intent/tweet/?text=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%20Part%2014%ef%bc%9a%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%e3%81%ae%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e3%82%a2%e3%83%83%e3%83%97%e3%83%87%e3%83%bc%e3%83%88%e3%81%97%e3%82%88%e3%81%86%ef%bc%81&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f&amp;hashtags=GodotEngine%2cGameDev%2c2D%2c%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%b2%e3%83%bc%e3%83%a0%2c%e6%a8%aa%e3%82%b9%e3%82%af%e3%83%ad%e3%83%bc%e3%83%ab%2c%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%2c%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%2c%e3%82%b4%e3%83%bc%e3%82%b9%e3%83%88%e3%82%a8%e3%83%95%e3%82%a7%e3%82%af%e3%83%88%2c%e3%83%80%e3%83%96%e3%83%ab%e3%82%b8%e3%83%a3%e3%83%b3%e3%83%97%2c%e5%a3%81%e3%82%b8%e3%83%a3%e3%83%b3%e3%83%97%2c%e7%a0%82%e5%9f%83"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f&title=Godot%20%e3%81%a7%e4%bd%9c%e3%82%8b%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%bc%20Part%2014%ef%bc%9a%e3%83%97%e3%83%ac%e3%82%a4%e3%83%a4%e3%83%bc%e3%82%ad%e3%83%a3%e3%83%a9%e3%82%af%e3%82%bf%e3%83%bc%e3%81%ae%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e3%82%a2%e3%83%83%e3%83%97%e3%83%87%e3%83%bc%e3%83%88%e3%81%97%e3%82%88%e3%81%86%ef%bc%81"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Godot で作るプラットフォーマー Part 14：プレイヤーキャラクターのアクションをアップデートしよう！ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fja%2ftutorials%2fgd0005_platformer%2fplatformer_14%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><ul class=post-tags><li><a href=https://www.peanuts-code.com/ja/tags/godotengine/>GodotEngine</a></li><li><a href=https://www.peanuts-code.com/ja/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/2d/>2D</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B2%E3%83%BC%E3%83%A0/>アクションゲーム</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E6%A8%AA%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB/>横スクロール</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%BC/>プラットフォーマー</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%AD%E3%83%A3%E3%83%A9%E3%82%AF%E3%82%BF%E3%83%BC/>プレイヤーキャラクター</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%B4%E3%83%BC%E3%82%B9%E3%83%88%E3%82%A8%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88/>ゴーストエフェクト</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%83%80%E3%83%96%E3%83%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97/>ダブルジャンプ</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E5%A3%81%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97/>壁ジャンプ</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E7%A0%82%E5%9F%83/>砂埃</a></li></ul><nav class=paginav><a class=prev href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_15/><span class=title>« 前へ</span><br><span>Godot で作るプラットフォーマー Part 15：いろいろな仕掛けを追加しよう！</span>
</a><a class=next href=https://www.peanuts-code.com/ja/tutorials/gd0005_platformer/platformer_13/><span class=title>次へ »</span><br><span>Godot で作るプラットフォーマー Part 13：サウンドを追加しよう！</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.peanuts-code.com/ja/>Peanuts Code</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>