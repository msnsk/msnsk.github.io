<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>📔 開発ログ：もの切り侍【ロジック編】 | Peanuts Code</title>
<meta name=keywords content="GameDev,IndieDev,Devlog,MobileGame,iOS,もの切り侍"><meta name=description content="この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。 「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。 必要な画"><meta name=author content="gobo"><link rel=canonical href=https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.peanuts-code.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.peanuts-code.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.peanuts-code.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.peanuts-code.com/apple-touch-icon.png><link rel=mask-icon href=https://www.peanuts-code.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/><link rel=alternate hreflang=en href=https://www.peanuts-code.com/en/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="📔 開発ログ：もの切り侍【ロジック編】"><meta property="og:description" content="この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。 「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。 必要な画"><meta property="og:type" content="article"><meta property="og:url" content="https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/"><meta property="og:image" content="https://www.peanuts-code.com/images/posts/post0005/3_logic/07.gif"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-30T23:00:00+09:00"><meta property="article:modified_time" content="2023-12-31T06:00:00+09:00"><meta property="og:site_name" content="Peanuts Code 🥜"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.peanuts-code.com/images/posts/post0005/3_logic/07.gif"><meta name=twitter:title content="📔 開発ログ：もの切り侍【ロジック編】"><meta name=twitter:description content="この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。 「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。 必要な画"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📔 ブログ","item":"https://www.peanuts-code.com/ja/posts/"},{"@type":"ListItem","position":2,"name":"📔 開発ログシリーズ：もの切り侍","item":"https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/"},{"@type":"ListItem","position":3,"name":"📔 開発ログ：もの切り侍【ロジック編】","item":"https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"📔 開発ログ：もの切り侍【ロジック編】","name":"📔 開発ログ：もの切り侍【ロジック編】","description":"この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。 「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。 必要な画","keywords":["GameDev","IndieDev","Devlog","MobileGame","iOS","もの切り侍"],"articleBody":"この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。\n「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。\n必要な画面の洗い出し 私は割と見た目から入るタイプだ。ゲーム開発も例に漏れず、Godot で「もの切り侍」を作り始めるにあたり、まずは必要な画面の洗い出しからスタートした。その流れで画面遷移も考えた。最終的に変更点は多々あったが、ベースは当初考えたものからさほどブレていないと思う。\n開発当初は以下の画面を用意する計画だった。\nスタート画面 プレイ画面(ポーズ画面含む) ステージ選択画面 設定画面 最終的には、さらに以下の画面を追加することになった。\nプロローグ画面 メニュー画面 クレジット画面 スコア画面 落ち物記録画面 この開発ログでは、当初計画していたゲームの中心となる画面について記録する。\nスタート画面とプロローグ画面 カジュアルゲームを追求するならば、スタート画面はむしろ不要ではないかとさえ思っている。がしかし、開発者にとって、スタート画面ほど用意したくなる画面が他にあるだろうか（たぶん、ある）。スタート画面からプレイ画面、設定画面、クレジット画面へそれぞれ遷移できるように考えていたが、世間のモバイルゲームの仕様を見てみると、ただ「スタート」ボタンがあるだけのものが割と多かった。流行にはそれなりに理由があるのだろう、とわけもなく信じて模倣することにした。\n次に、スタート画面に少しでも楽しい要素を追加するため、プレイヤーキャラクターの侍を中央に配置して、アニメーションさせた。開発当初から、「スタート」ボタンを押すと侍が刀を振ってポーズを決めるイメージが浮かんでいたので、それをそのまま実装した。実際には、プレイ画面で使用する Player シーンを先に作って、それを流用したという順番である。\nその後、カジュアルゲームであるにも関わらず、色々な要素を盛り込み始めた。情熱という名のバカである。盛り込んだ要素の一つがプロローグだ。最初はスタート画面を放置していると数秒後に自動的にプロローグ画面に遷移する仕組みにしていた。しかし、次画面のロードに少しばかり時間が必要になってきたため、「待っている間にどうぞ」と言わんばかりに「プロローグ」ボタンをスタート画面に配置した。\nプロローグ画面の構造はいたってシンプルだ。基本的には TextureRect ノードに背景用のパターンテクスチャを適用し、 ScrollContainer ノードにプロローグの文章を適用した Label ノードを入れるという構造だ。自動的に下から上に流れていく仕組みは以下のコードで実装した。\nconst MAX_SCROLL : int = 5924 func _process(_delta): if scroll_container.scroll_vertical \u003c MAX_SCROLL: scroll_container.scroll_vertical += 1 プレイ画面 プレイ画面はゲームの主たるパートなので、ボリューミーだ。Game シーンを最上位として、その下に必要なシーンを追加していった。最終形態はごちゃごちゃと細かいノードを追加しているが、ベースとしては以下のような構成になっている。\nGame: Node World: Node2D Backgournd: Node2D Player: CharacterBody2D Obj: RigidBody2D UI: Control Background シーン Background シーンを作成して、それを World シーンのブランチとして追加した。このシーンには、Full Rect の TextureRect ノードに背景のパターンテクスチャをセットし、画面下部にはプレイヤーキャラクターが歩く足場として StaticBody2D ノードをセットした。\n細かい演出だが、東から西へ動く太陽と満ち欠けする月を開発中版で追加した。太陽と月のスプライトは、Asprite アプリで自作したものだ。\n太陽と月の動き、および日の出、日没、夜の暗がりなどの空の色の変化など、背景で変化する部分はすべて AnimationPlayer にまとめた。\nPlayer シーン Player シーンを作成して、それをブランチとして World ノードに追加した。このシーンは CharacterBody2D ノードを最上位にして、Sprite2D にドット絵の侍をテクスチャとしてセットしている。\n落ち物の的に対して、侍側にも当たり判定エリアが必要なため、Area2D ノードで Hitbox を用意した。ボックスといいながら、線である。それをプレイヤーに視覚的に示すために、HitBox の CollisionShape2D の線の長さと同じ Line2D ノードを用意した。色はイメージカラーの紫っぽい色にした。侍の登場や退場をトリガーに呼び出すメソッドがあったので VisibleOnScreenNotifier2D ノードも追加して、そのシグナルをスクリプト内で利用している。\n開発後半で侍にセリフを喋らせる仕様にしたため、吹き出し 💬 を表示する Bubble シーンを作り、それを Player シーンのブランチとして追加した。この Bubble シーンには DialogueManager というプラグインを利用させていただいている。実装に少し苦戦したが、チュートリアルもしっかり用意してくれているので、比較的利用しやすいプラグインだと思う。\n少し侍のアクションを派手に演出するため、プレイヤーキャラクターのゴーストエフェクトも追加した。\n侍に使用する効果音、例えば、足音やジャンプ、着地の音、刀で切る音などはすべて、ひとつずつ AudioStreamPlayer ノードを追加した。シーンツリーがやや冗長になるが、プレイ中に効果音アセットを都度読み込んでノードにセットするよりは処理が速いと考えたからだ。\n画面をタッチして侍がジャンプ、そのままタッチをキープして一定の高さまで上昇、その後画面から指をリリースして当たり判定へ、という操作手順は unhandled_input() メソッドで実装した。メソッド内には、侍の吹き出し 💬 を閉じる操作も含めている。\nfunc _unhandled_input(_event): if player_state == PlayerState.IDLING \\ and is_on_floor() \\ and Input.is_action_just_pressed(\"touch\"): if speech_state == SpeechState.SAID: bubble.hide() elif speech_state == SpeechState.SILENT: print(\"Screen Touched\") is_touching = true hit_box_col_shape.disabled = false # CollisionShape2D of Hitbox node sfx_jump.play() # AudioStreamPlayer anim_player.play(\"jump\") # AnimationPlayer velocity.y = -JUMP_SPEED player_state = PlayerState.JUMPING if is_touching\\ and not is_on_floor()\\ and Input.is_action_just_released(\"touch\"): print(\"Screen Released\") is_touching = false released.emit() hit_box.hide() hit_box_col_shape.disabled = true if player_state == PlayerState.JUMPING: velocity.y = move_toward(velocity.y, 0, 1600) Obj シーン Obj とは、Object の略で、落ち物のためのシーンである。このシーンを World シーンのブランチとして追加した。Obj シーンのルートには、RigidBody2D ノードを採用した。物理計算を自動でしてくれるので、落ち物を画面上部から落下させるのは非常に簡単だった。次に、侍に切られた落ち物を等分して分断させる方法について少し悩んだ。もしかしたら Shader を使いこなせれば簡単に実装できるのかもしれない（いまだに可能かすらわからない）。しかし、私は Shader のスキルがまるでないので、他の方法で進める他なかった。落ち物のスプライトをそのまま分裂させることが難しいのであれば、擬似的にそう見せれば良いと閃いた。つまり、最初から切られているものを綺麗に並べ、まるで切られていないように見せる、という方法だ。以下の動画は、この方法で実装した開発初期のものだ。\n擬似的分断の演出は以下の方法で実装することにした。\n落ち物が侍に切られたら、Obj ノードをフリーズさせる（Freeze プロパティをオンにする） Obj シーンを等分した数だけ ObjPiece シーンを Obj ノードの子ノードとして追加する 各 ObjPiece ノードを親の Obj ノードのスプライトと重なるように、等間隔に配置する 各 ObjPiece ノードには、Obj シーンのスプライトを元に AtlasTexture クラスを使って等分したテクスチャを適用する 各 ObjPiece ノードに対して、AtlasTexture の不透明部分から CollisionPolygon2D を生成して子ノードとして適用する 上記のロジックをコーディングしたのが以下のスクリプトである。\nObj ノードのスクリプト：\nconst PIECE_SCENE : PackedScene = preload(\"res://obj_base/obj_piece/obj_piece.tscn\") @onready var sprite: Sprite2D = $Sprite2D func generate_obj_pieces(): var tex_image = sprite.texture var tex_size = sprite.texture.get_size() var h_cuts := 12 var v_cuts := 8 var frag_size = Vector2(tex_size.x / h_cuts, tex_size.y / v_cuts) for i in h_cuts: for j in v_cuts: var pce = PIECE_SCENE.instantiate() var cor = Vector2(frag_size.x * i, frag_size.y * j) var pos = (cor + frag_size/2 - tex_size/2) pieces.call_deferred(\"add_child\", pce) pce.position = pos pce.call_deferred(\"set_sprite\", tex_image, cor, frag_size) pce.call_deferred(\"set_col_poly\") ObjPiece ノードのスクリプト：\nfunc set_sprite(tex_image:Texture2D, frag_pos:Vector2, frag_size:Vector2): var tex := AtlasTexture.new() tex.set_atlas(tex_image) tex.set_region(Rect2(frag_pos, frag_size)) sprite.texture = tex func set_col_poly(): var polygons = sprite.create_polygons() if not polygons.is_empty(): for i in polygons.size(): var col_poly := CollisionPolygon2D.new() col_poly.set_polygon(polygons[i]) col_poly.position -= sprite.texture.get_size() / 2 col_poly.disabled = false call_deferred(\"add_child\", col_poly) ObjPiece ノードの子 Sprite ノードのスクリプト：\nfunc create_polygons(): var bitmap = BitMap.new() bitmap.create_from_image_alpha(texture.get_image()) var rect := Rect2(Vector2.ZERO, texture.get_size()) var polygons = bitmap.opaque_to_polygons(rect) return polygons ObjPiece ノードだけ先に落下したり、逆に親の Obj ノードが落ちているのに子の ObjPiece ノードだけ空中に残ったりしてしまうので、かなり悩んだ。結果的に、事前にインスペクターで、 ObjPiece (RigidBody2D) ルートノードの Freeze をオンにし、かつ Freeze Mode を Kinematic にしておく必要があることに気づいた。\n最終的には、落ち物に「一本」と「技あり」の当たり判定領域を設け、それぞれで落ち物を等分する数を決めて、スクリプト上で条件分岐させた。「一本」のほうがより細かく切る（より気持ち良い）演出だ。\nUI シーン プレイ画面の UI として、まず HUD を画面下端に配置した。これは Background シーンの侍の足場である StaticBody2D ノードの CollisionShape2D 子ノードの領域と重なるようにしている。この HUD に「一時停止する」「再開する」「設定画面を開く」「ステージ選択画面に移動する」の4つのボタンを設けた。ボタンのデザインは、アイコンのみロイヤリティフリーの素材を使用しているが、それ以外のボタンのデザインやレイアウトは、ノードそれぞれのプロパティを調整するのみにして、シンプルに留めた。\n一時停止画面も UI シーンのひとつとして作成した。ColorRect ノードで全画面に半透明の薄い緑色を重ね、Label ノードで「一時停止中」の文字を表示させた。HUD の「一時停止する」ボタン以外は一時停止中でなければ押せない仕様にした。これは誤操作防止策の一つだ。\n「ステージ選択画面に移動する」ボタンを押した際、「本当にゲームを中断してステージ選択画面に移動しても良いか」の確認ダイアログを表示させるようにした。最終的なオプションボタンの文言は「はい」と「いいえ」だが、開発初期は、ゲームの雰囲気を出すのに躍起になっていたので、「承知した」「断る」のような文言にしていた。雰囲気よりわかりやすさのほうが優先度が高いと判断してボツにした。\n開発終盤にはチュートリアルを追加した。正直、チュートリアルがなくてもすぐにわかるような操作性にしたつもりだったが、いつでもチュートリアルが見られるようにしておく優しさはあっても良いと思った。そういうわけで、一時停止中に画面右上の（？）アイコンを押すとチュートリアルが始まるようにした。\n侍が刀を鞘に収め、落ち物が分断されたタイミングで、当たり判定の「一本」または「技あり」が表示されるようにした。特大のフォントサイズから一瞬で標準サイズにアニメーションするようにしていたが、これが開発終盤まで苦しんだメモリリーク問題に関わっていた。結論から言えば、Label ノードの文字を拡大縮小させるなどアニメーションさせたい場合、素直に scale プロパティの値を変化させるのが正解だ。しかし、私は「文字のサイズを変化させる」=「フォントサイズを変化させる」と考えてしまった。そして AnimationPlayer ノードで、Theme Overrides Font Size プロパティの値を変化させてしまっていた。詳しい理由は不明だが、このアニメーションが実行されるたびに約 150 MB ずつメモリの消費量が増えていき、いくつかステージをクリアしていくと、必ずゲームがクラッシュするという状態であった。思い込みには要注意である。\nステージクリア後のオプションボタンも実装した。「次へ参る」「再び挑む」「ステージ選択」の3つだ。モバイルカジュアルゲームといえば、通勤通学中の電車やバスでの操作を想定する必要があるだろう。場合によっては片手での操作もありうる。そこで、これらのオプションボタンは画面の下部に配置した。「次へ参る」を押す機会が一番多いはずなので、順番は一番下にもってきた。\nステージ選択画面 ステージ選択画面はプレイ画面とは別物として用意した。この画面を起点に、設定画面、メニュー画面、落物記録画面へ遷移するようにした。メニュー画面にはさらに、スコア画面、クレジット/ライセンス画面への遷移や、Appレビューページへのリンク、ゲームデータ消去機能を実装した。\nステージ選択画面は、当初、ステージ選択用のアイコンを ScrollContainer の中に全200ステージ分用意しており、VisibleOnScreenEnabler2D ノードによって、画面上に表示される前後で、表示 / 非表示を自動で切り替え、コンピュータのリソースを節約するようなロジックで実装していた。しかし、それでも画面をスクロールさせたときのもっさりした動きが気になってしまうレベルだったので、構成を変更した。レベル切り替えボタンを新たに配置し、1 画面内には 1 レベル 20 ステージ分のアイコンしか表示されないように調整した。これにより、もっさり感はなくなった。\nプレイ画面同様、このステージ選択画面も若干操作方法に迷う可能性があると判断し、チュートリアルを用意した。右上の（？）アイコンからいつでも表示できる仕組みもプレイ画面のそれと同じである。\n設定画面 設定画面のつくり自体は至ってシンプルだ。Container 系のノードを使って、レイアウトを整理しただけである。ボタンのアイコンはロイヤリティフリーの素材を使用している。\nボタンはすべて Toggle Mode をオンにして、toggled(button_pressed: bool) シグナルをルートノードのスクリプトに紐づけた。例えば、BGMボタンのシグナルは以下のメソッドに紐づいている。\nfunc _on_background_music_button_toggled(button_pressed): if button_pressed: Gamedata.bgm_enabled = true if Gamedata.sfx_enabled: enabled_sound_player.play() bgm_disabled.emit() else: Gamedata.bgm_enabled = false if Gamedata.sfx_enabled: disabled_sound_player.play() bgm_enabled.emit() bgm_button.release_focus() 上記コードのうち、Gamedata というのは、Godot の Autoload 機能で読み込んでいるスクリプトだ。設定を保存するには、設定ファイルを用意する必要があるので、セーブ/ロード機能をまとめた gamedata.gd スクリプトを作り、Autoload でゲーム開始時に自動で読み込ませるようにした。スクリプトのコードは以下のようになっている。\nconst OPTIONS_PATH := \"user://options.save\" var bgm_enabled := true var sfx_enabled := true var background_pattern := true var ippon_only := false var speech_bubble_enabled := true var speech_bubble_auto_hide := false func save_options(): var options = { \"bgm_enabled\": bgm_enabled, \"sfx_enabled\": sfx_enabled, \"background_pattern\": background_pattern, \"ippon_only\": ippon_only, \"speech_bubble_enabled\": speech_bubble_enabled, \"speech_bubble_auto_hide\": speech_bubble_auto_hide } var file = FileAccess.open(OPTIONS_PATH, FileAccess.WRITE) file.store_var(options) file.close() func load_options(): var file = FileAccess.open(OPTIONS_PATH, FileAccess.READ) if !file: return var options = file.get_var() if !options: file.close() return if options.has(\"bgm_enabled\"): bgm_enabled = options[\"bgm_enabled\"] if options.has(\"sfx_enabled\"): sfx_enabled = options[\"sfx_enabled\"] if options.has(\"background_pattern\"): background_pattern = options[\"background_pattern\"] if options.has(\"ippon_only\"): ippon_only = options[\"ippon_only\"] if options.has(\"speech_bubble_enabled\"): speech_bubble_enabled = options[\"speech_bubble_enabled\"] if options.has(\"speech_bubble_auto_hide\"): speech_bubble_auto_hide = options[\"speech_bubble_auto_hide\"] file.close() おわりに ということで、この開発ログには「もの切り侍」のロジックに関わる部分を記した。\n3D ゲームはわからないが、2D ゲームに関しては、Godot に用意されている様々なクラスを組み合わせれば、実現したいことはだいたいできてしまうのではないか、と思った。しかし、それと同時に、ゲームのアイデアをアルゴリズムに落とし込んで、それを実現するためにドキュメントを読み込んで検証する作業は、時に相当の忍耐が必要になるということもわかった。\nこの開発ログがどなたかのゲーム開発の一助になれば幸いだ。\n","wordCount":"5716","inLanguage":"ja","image":"https://www.peanuts-code.com/images/posts/post0005/3_logic/07.gif","datePublished":"2023-12-30T23:00:00+09:00","dateModified":"2023-12-31T06:00:00+09:00","author":{"@type":"Person","name":"gobo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/"},"publisher":{"@type":"Organization","name":"Peanuts Code","logo":{"@type":"ImageObject","url":"https://www.peanuts-code.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.peanuts-code.com/ja/ accesskey=h title="Peanuts Code (Alt + H)"><img src=https://www.peanuts-code.com/images/logomark.png alt aria-label=logo height=35>Peanuts Code</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.peanuts-code.com/en/ title=English aria-label=🇬🇧English>🇬🇧English</a></li></ul></div></div><ul id=menu><li><a href=https://www.peanuts-code.com/ja/ title=ホーム><span>ホーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/portfolio/ title=ゲーム><span>ゲーム</span></a></li><li><a href=https://www.peanuts-code.com/ja/posts/ title=ブログ><span>ブログ</span></a></li><li><a href=https://www.peanuts-code.com/ja/tutorials/ title=チュート><span>チュート</span></a></li><li><a href=https://www.peanuts-code.com/ja/about/ title=サイト紹介><span>サイト紹介</span></a></li><li><a href=https://www.peanuts-code.com/ja/search/ title="サイト内検索 (Alt + /)" accesskey=/><span>サイト内検索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.peanuts-code.com/ja/>ホーム</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/posts/>📔 ブログ</a>&nbsp;»&nbsp;<a href=https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/>📔 開発ログシリーズ：もの切り侍</a></div><h1 class="post-title entry-hint-parent">📔 開発ログ：もの切り侍【ロジック編】</h1><ul class=post-tags><li><a href=https://www.peanuts-code.com/ja/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/indiedev/>IndieDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/devlog/>Devlog</a></li><li><a href=https://www.peanuts-code.com/ja/tags/mobilegame/>MobileGame</a></li><li><a href=https://www.peanuts-code.com/ja/tags/ios/>IOS</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%82%E3%81%AE%E5%88%87%E3%82%8A%E4%BE%8D/>もの切り侍</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 開発ログ：もの切り侍【ロジック編】 on x" href="https://x.com/intent/tweet/?text=%f0%9f%93%94%20%e9%96%8b%e7%99%ba%e3%83%ad%e3%82%b0%ef%bc%9a%e3%82%82%e3%81%ae%e5%88%87%e3%82%8a%e4%be%8d%e3%80%90%e3%83%ad%e3%82%b8%e3%83%83%e3%82%af%e7%b7%a8%e3%80%91&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2fposts%2fpost0005_slashing_samurai_devlogs%2fslashing_samurai_devlog_3%2f&amp;hashtags=GameDev%2cIndieDev%2cDevlog%2cMobileGame%2ciOS%2c%e3%82%82%e3%81%ae%e5%88%87%e3%82%8a%e4%be%8d"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 開発ログ：もの切り侍【ロジック編】 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fja%2fposts%2fpost0005_slashing_samurai_devlogs%2fslashing_samurai_devlog_3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><div class=post-meta><span title='2023-12-30 23:00:00 +0900 +0900'>2023-12-30</span>&nbsp;·&nbsp;12 分&nbsp;|&nbsp;言語:<ul class=i18n_list><li><a href=https://www.peanuts-code.com/en/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_3/>🇬🇧English</a></li></ul></div></header><figure class=entry-cover><img loading=eager src=https://www.peanuts-code.com/images/posts/post0005/3_logic/07.gif alt=開発ブログ：もの切り侍【ロジック編】></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#%e5%bf%85%e8%a6%81%e3%81%aa%e7%94%bb%e9%9d%a2%e3%81%ae%e6%b4%97%e3%81%84%e5%87%ba%e3%81%97 aria-label=必要な画面の洗い出し>必要な画面の洗い出し</a></li><li><a href=#%e3%82%b9%e3%82%bf%e3%83%bc%e3%83%88%e7%94%bb%e9%9d%a2%e3%81%a8%e3%83%97%e3%83%ad%e3%83%ad%e3%83%bc%e3%82%b0%e7%94%bb%e9%9d%a2 aria-label=スタート画面とプロローグ画面>スタート画面とプロローグ画面</a></li><li><a href=#%e3%83%97%e3%83%ac%e3%82%a4%e7%94%bb%e9%9d%a2 aria-label=プレイ画面>プレイ画面</a><ul><li><a href=#background-%e3%82%b7%e3%83%bc%e3%83%b3 aria-label="Background シーン">Background シーン</a></li><li><a href=#player-%e3%82%b7%e3%83%bc%e3%83%b3 aria-label="Player シーン">Player シーン</a></li><li><a href=#obj-%e3%82%b7%e3%83%bc%e3%83%b3 aria-label="Obj シーン">Obj シーン</a></li><li><a href=#ui-%e3%82%b7%e3%83%bc%e3%83%b3 aria-label="UI シーン">UI シーン</a></li></ul></li><li><a href=#%e3%82%b9%e3%83%86%e3%83%bc%e3%82%b8%e9%81%b8%e6%8a%9e%e7%94%bb%e9%9d%a2 aria-label=ステージ選択画面>ステージ選択画面</a></li><li><a href=#%e8%a8%ad%e5%ae%9a%e7%94%bb%e9%9d%a2 aria-label=設定画面>設定画面</a></li><li><a href=#%e3%81%8a%e3%82%8f%e3%82%8a%e3%81%ab aria-label=おわりに>おわりに</a></li></ul></div></details></div><div class=post-content><p>この記事は 2023/12/15 に App Store でリリースされた iOS 対応モバイルゲーム「もの切り侍」の（事後の）開発ログのうちGodot Engine で作っていく「ロジック」に関する記録である。とはいえ、あまり具体的なコードなどを載せると長くなってしまうので、そのあたりは控えめにしようと思う。</p><p>「もの切り侍」は下の App Store のバナーから、無料でダウンロードできるので、興味があればぜひ遊んでみてほしい。</p><figure><a href=https://apps.apple.com/jp/app/slashing-samurai/id6473121142><img loading=lazy src=/images/banners/app_store/Download_on_the_App_Store_Badge_US-UK_RGB_blk_092917.svg width=200px></a></figure><br><hr><h2 id=必要な画面の洗い出し>必要な画面の洗い出し</h2><p>私は割と見た目から入るタイプだ。ゲーム開発も例に漏れず、Godot で「もの切り侍」を作り始めるにあたり、まずは必要な画面の洗い出しからスタートした。その流れで画面遷移も考えた。最終的に変更点は多々あったが、ベースは当初考えたものからさほどブレていないと思う。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/01.webp alt=ノート：画面遷移></p><p>開発当初は以下の画面を用意する計画だった。</p><ul><li>スタート画面</li><li>プレイ画面(ポーズ画面含む)</li><li>ステージ選択画面</li><li>設定画面</li></ul><p>最終的には、さらに以下の画面を追加することになった。</p><ul><li>プロローグ画面</li><li>メニュー画面<ul><li>クレジット画面</li><li>スコア画面</li></ul></li><li>落ち物記録画面</li></ul><p>この開発ログでは、当初計画していたゲームの中心となる画面について記録する。</p><br><hr><h2 id=スタート画面とプロローグ画面>スタート画面とプロローグ画面</h2><p>カジュアルゲームを追求するならば、スタート画面はむしろ不要ではないかとさえ思っている。がしかし、開発者にとって、スタート画面ほど用意したくなる画面が他にあるだろうか（たぶん、ある）。スタート画面からプレイ画面、設定画面、クレジット画面へそれぞれ遷移できるように考えていたが、世間のモバイルゲームの仕様を見てみると、ただ「スタート」ボタンがあるだけのものが割と多かった。流行にはそれなりに理由があるのだろう、とわけもなく信じて模倣することにした。</p><p>次に、スタート画面に少しでも楽しい要素を追加するため、プレイヤーキャラクターの侍を中央に配置して、アニメーションさせた。開発当初から、「スタート」ボタンを押すと侍が刀を振ってポーズを決めるイメージが浮かんでいたので、それをそのまま実装した。実際には、プレイ画面で使用する Player シーンを先に作って、それを流用したという順番である。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/02.gif alt=スタートボタン押下の前後></p><p>その後、カジュアルゲームであるにも関わらず、色々な要素を盛り込み始めた。情熱という名のバカである。盛り込んだ要素の一つがプロローグだ。最初はスタート画面を放置していると数秒後に自動的にプロローグ画面に遷移する仕組みにしていた。しかし、次画面のロードに少しばかり時間が必要になってきたため、「待っている間にどうぞ」と言わんばかりに「プロローグ」ボタンをスタート画面に配置した。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/03.gif alt=スタート画面からプロローグ画面への遷移></p><p>プロローグ画面の構造はいたってシンプルだ。基本的には TextureRect ノードに背景用のパターンテクスチャを適用し、 ScrollContainer ノードにプロローグの文章を適用した Label ノードを入れるという構造だ。自動的に下から上に流れていく仕組みは以下のコードで実装した。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>const</span> <span class=n>MAX_SCROLL</span> <span class=p>:</span> <span class=kt>int</span> <span class=o>=</span> <span class=mi>5924</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_process</span><span class=p>(</span><span class=n>_delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>scroll_container</span><span class=o>.</span><span class=n>scroll_vertical</span> <span class=o>&lt;</span> <span class=n>MAX_SCROLL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scroll_container</span><span class=o>.</span><span class=n>scroll_vertical</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></div><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=プレイ画面>プレイ画面</h2><p>プレイ画面はゲームの主たるパートなので、ボリューミーだ。Game シーンを最上位として、その下に必要なシーンを追加していった。最終形態はごちゃごちゃと細かいノードを追加しているが、ベースとしては以下のような構成になっている。</p><ul><li>Game: Node<ul><li>World: Node2D<ul><li>Backgournd: Node2D</li><li>Player: CharacterBody2D</li><li>Obj: RigidBody2D</li></ul></li><li>UI: Control</li></ul></li></ul><h3 id=background-シーン>Background シーン</h3><p><img loading=lazy src=/images/posts/post0005/3_logic/04.webp alt="Backgound シーン"></p><p>Background シーンを作成して、それを World シーンのブランチとして追加した。このシーンには、Full Rect の TextureRect ノードに背景のパターンテクスチャをセットし、画面下部にはプレイヤーキャラクターが歩く足場として StaticBody2D ノードをセットした。</p><p>細かい演出だが、東から西へ動く太陽と満ち欠けする月を開発中版で追加した。太陽と月のスプライトは、Asprite アプリで自作したものだ。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/04_2.gif alt=月の満ち欠け></p><p>太陽と月の動き、および日の出、日没、夜の暗がりなどの空の色の変化など、背景で変化する部分はすべて AnimationPlayer にまとめた。</p><h3 id=player-シーン>Player シーン</h3><p>Player シーンを作成して、それをブランチとして World ノードに追加した。このシーンは CharacterBody2D ノードを最上位にして、Sprite2D にドット絵の侍をテクスチャとしてセットしている。</p><p>落ち物の的に対して、侍側にも当たり判定エリアが必要なため、Area2D ノードで Hitbox を用意した。ボックスといいながら、線である。それをプレイヤーに視覚的に示すために、HitBox の CollisionShape2D の線の長さと同じ Line2D ノードを用意した。色はイメージカラーの紫っぽい色にした。侍の登場や退場をトリガーに呼び出すメソッドがあったので VisibleOnScreenNotifier2D ノードも追加して、そのシグナルをスクリプト内で利用している。</p><p>開発後半で侍にセリフを喋らせる仕様にしたため、吹き出し 💬 を表示する Bubble シーンを作り、それを Player シーンのブランチとして追加した。この Bubble シーンには <a href=https://github.com/nathanhoad/godot_dialogue_manager target=_blank>DialogueManager</a>
というプラグインを利用させていただいている。実装に少し苦戦したが、チュートリアルもしっかり用意してくれているので、比較的利用しやすいプラグインだと思う。</p><p>少し侍のアクションを派手に演出するため、プレイヤーキャラクターのゴーストエフェクトも追加した。</p><p>侍に使用する効果音、例えば、足音やジャンプ、着地の音、刀で切る音などはすべて、ひとつずつ AudioStreamPlayer ノードを追加した。シーンツリーがやや冗長になるが、プレイ中に効果音アセットを都度読み込んでノードにセットするよりは処理が速いと考えたからだ。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/05.webp alt="Player シーン"></p><p>画面をタッチして侍がジャンプ、そのままタッチをキープして一定の高さまで上昇、その後画面から指をリリースして当たり判定へ、という操作手順は <code>unhandled_input()</code> メソッドで実装した。メソッド内には、侍の吹き出し 💬 を閉じる操作も含めている。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_unhandled_input</span><span class=p>(</span><span class=n>_event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>player_state</span> <span class=o>==</span> <span class=n>PlayerState</span><span class=o>.</span><span class=n>IDLING</span> \
</span></span><span class=line><span class=cl>    <span class=ow>and</span> <span class=nf>is_on_floor</span><span class=p>()</span> \
</span></span><span class=line><span class=cl>    <span class=ow>and</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;touch&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>speech_state</span> <span class=o>==</span> <span class=n>SpeechState</span><span class=o>.</span><span class=n>SAID</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>bubble</span><span class=o>.</span><span class=nf>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>speech_state</span> <span class=o>==</span> <span class=n>SpeechState</span><span class=o>.</span><span class=n>SILENT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Screen Touched&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>is_touching</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=n>hit_box_col_shape</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=kc>false</span> <span class=c1># CollisionShape2D of Hitbox node</span>
</span></span><span class=line><span class=cl>            <span class=n>sfx_jump</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span> <span class=c1># AudioStreamPlayer</span>
</span></span><span class=line><span class=cl>            <span class=n>anim_player</span><span class=o>.</span><span class=nf>play</span><span class=p>(</span><span class=s2>&#34;jump&#34;</span><span class=p>)</span> <span class=c1># AnimationPlayer</span>
</span></span><span class=line><span class=cl>            <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=o>-</span><span class=n>JUMP_SPEED</span>
</span></span><span class=line><span class=cl>            <span class=n>player_state</span> <span class=o>=</span> <span class=n>PlayerState</span><span class=o>.</span><span class=n>JUMPING</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>is_touching</span>\
</span></span><span class=line><span class=cl>    <span class=ow>and</span> <span class=ow>not</span> <span class=nf>is_on_floor</span><span class=p>()</span>\
</span></span><span class=line><span class=cl>    <span class=ow>and</span> <span class=nc>Input</span><span class=o>.</span><span class=nf>is_action_just_released</span><span class=p>(</span><span class=s2>&#34;touch&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Screen Released&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>is_touching</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=n>released</span><span class=o>.</span><span class=nf>emit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>hit_box</span><span class=o>.</span><span class=nf>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>hit_box_col_shape</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>player_state</span> <span class=o>==</span> <span class=n>PlayerState</span><span class=o>.</span><span class=n>JUMPING</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>velocity</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=nb>move_toward</span><span class=p>(</span><span class=n>velocity</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1600</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=obj-シーン>Obj シーン</h3><p>Obj とは、Object の略で、落ち物のためのシーンである。このシーンを World シーンのブランチとして追加した。Obj シーンのルートには、RigidBody2D ノードを採用した。物理計算を自動でしてくれるので、落ち物を画面上部から落下させるのは非常に簡単だった。次に、侍に切られた落ち物を等分して分断させる方法について少し悩んだ。もしかしたら Shader を使いこなせれば簡単に実装できるのかもしれない（いまだに可能かすらわからない）。しかし、私は Shader のスキルがまるでないので、他の方法で進める他なかった。落ち物のスプライトをそのまま分裂させることが難しいのであれば、擬似的にそう見せれば良いと閃いた。つまり、最初から切られているものを綺麗に並べ、まるで切られていないように見せる、という方法だ。以下の動画は、この方法で実装した開発初期のものだ。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/06.gif alt=開発初期のオブジェクトを切るデモ1></p><p><img loading=lazy src=/images/posts/post0005/3_logic/07.gif alt=開発初期のオブジェクトを切るデモ2></p><p>擬似的分断の演出は以下の方法で実装することにした。</p><ol><li>落ち物が侍に切られたら、Obj ノードをフリーズさせる（Freeze プロパティをオンにする）</li><li>Obj シーンを等分した数だけ ObjPiece シーンを Obj ノードの子ノードとして追加する</li><li>各 ObjPiece ノードを親の Obj ノードのスプライトと重なるように、等間隔に配置する</li><li>各 ObjPiece ノードには、Obj シーンのスプライトを元に AtlasTexture クラスを使って等分したテクスチャを適用する</li><li>各 ObjPiece ノードに対して、AtlasTexture の不透明部分から CollisionPolygon2D を生成して子ノードとして適用する</li></ol><p>上記のロジックをコーディングしたのが以下のスクリプトである。</p><p>Obj ノードのスクリプト：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>const</span> <span class=n>PIECE_SCENE</span> <span class=p>:</span> <span class=nc>PackedScene</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://obj_base/obj_piece/obj_piece.tscn&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@onready</span> <span class=kd>var</span> <span class=n>sprite</span><span class=p>:</span> <span class=nc>Sprite2D</span> <span class=o>=</span> <span class=nx>$Sprite2D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>generate_obj_pieces</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>tex_image</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>texture</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>tex_size</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>texture</span><span class=o>.</span><span class=nf>get_size</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>h_cuts</span> <span class=o>:=</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>v_cuts</span> <span class=o>:=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>frag_size</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=n>tex_size</span><span class=o>.</span><span class=n>x</span> <span class=o>/</span> <span class=n>h_cuts</span><span class=p>,</span> <span class=n>tex_size</span><span class=o>.</span><span class=n>y</span> <span class=o>/</span> <span class=n>v_cuts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>h_cuts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>v_cuts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=n>pce</span> <span class=o>=</span> <span class=n>PIECE_SCENE</span><span class=o>.</span><span class=nf>instantiate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=n>cor</span> <span class=o>=</span> <span class=nc>Vector2</span><span class=p>(</span><span class=n>frag_size</span><span class=o>.</span><span class=n>x</span> <span class=o>*</span> <span class=n>i</span><span class=p>,</span> <span class=n>frag_size</span><span class=o>.</span><span class=n>y</span> <span class=o>*</span> <span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=n>pos</span> <span class=o>=</span> <span class=p>(</span><span class=n>cor</span> <span class=o>+</span> <span class=n>frag_size</span><span class=o>/</span><span class=mi>2</span> <span class=o>-</span> <span class=n>tex_size</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>pieces</span><span class=o>.</span><span class=nf>call_deferred</span><span class=p>(</span><span class=s2>&#34;add_child&#34;</span><span class=p>,</span> <span class=n>pce</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pce</span><span class=o>.</span><span class=n>position</span> <span class=o>=</span> <span class=n>pos</span>
</span></span><span class=line><span class=cl>            <span class=n>pce</span><span class=o>.</span><span class=nf>call_deferred</span><span class=p>(</span><span class=s2>&#34;set_sprite&#34;</span><span class=p>,</span> <span class=n>tex_image</span><span class=p>,</span> <span class=n>cor</span><span class=p>,</span> <span class=n>frag_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pce</span><span class=o>.</span><span class=nf>call_deferred</span><span class=p>(</span><span class=s2>&#34;set_col_poly&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>ObjPiece ノードのスクリプト：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>set_sprite</span><span class=p>(</span><span class=n>tex_image</span><span class=p>:</span><span class=nc>Texture2D</span><span class=p>,</span> <span class=n>frag_pos</span><span class=p>:</span><span class=nc>Vector2</span><span class=p>,</span> <span class=n>frag_size</span><span class=p>:</span><span class=nc>Vector2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>tex</span> <span class=o>:=</span> <span class=nc>AtlasTexture</span><span class=o>.</span><span class=nf>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>tex</span><span class=o>.</span><span class=nf>set_atlas</span><span class=p>(</span><span class=n>tex_image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tex</span><span class=o>.</span><span class=nf>set_region</span><span class=p>(</span><span class=nc>Rect2</span><span class=p>(</span><span class=n>frag_pos</span><span class=p>,</span> <span class=n>frag_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sprite</span><span class=o>.</span><span class=n>texture</span> <span class=o>=</span> <span class=n>tex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>set_col_poly</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>polygons</span> <span class=o>=</span> <span class=n>sprite</span><span class=o>.</span><span class=nf>create_polygons</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>polygons</span><span class=o>.</span><span class=nf>is_empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>polygons</span><span class=o>.</span><span class=nf>size</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=n>col_poly</span> <span class=o>:=</span> <span class=nc>CollisionPolygon2D</span><span class=o>.</span><span class=nf>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>col_poly</span><span class=o>.</span><span class=nf>set_polygon</span><span class=p>(</span><span class=n>polygons</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>col_poly</span><span class=o>.</span><span class=n>position</span> <span class=o>-=</span> <span class=n>sprite</span><span class=o>.</span><span class=n>texture</span><span class=o>.</span><span class=nf>get_size</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>col_poly</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>            <span class=nf>call_deferred</span><span class=p>(</span><span class=s2>&#34;add_child&#34;</span><span class=p>,</span> <span class=n>col_poly</span><span class=p>)</span>
</span></span></code></pre></div><p>ObjPiece ノードの子 Sprite ノードのスクリプト：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>create_polygons</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>bitmap</span> <span class=o>=</span> <span class=nc>BitMap</span><span class=o>.</span><span class=nf>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>bitmap</span><span class=o>.</span><span class=nf>create_from_image_alpha</span><span class=p>(</span><span class=n>texture</span><span class=o>.</span><span class=nf>get_image</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>rect</span> <span class=o>:=</span> <span class=nc>Rect2</span><span class=p>(</span><span class=nc>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span> <span class=n>texture</span><span class=o>.</span><span class=nf>get_size</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>polygons</span> <span class=o>=</span> <span class=n>bitmap</span><span class=o>.</span><span class=nf>opaque_to_polygons</span><span class=p>(</span><span class=n>rect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>polygons</span>
</span></span></code></pre></div><p>ObjPiece ノードだけ先に落下したり、逆に親の Obj ノードが落ちているのに子の ObjPiece ノードだけ空中に残ったりしてしまうので、かなり悩んだ。結果的に、事前にインスペクターで、 ObjPiece (RigidBody2D) ルートノードの <code>Freeze</code> をオンにし、かつ <code>Freeze Mode</code> を <code>Kinematic</code> にしておく必要があることに気づいた。</p><p>最終的には、落ち物に「一本」と「技あり」の当たり判定領域を設け、それぞれで落ち物を等分する数を決めて、スクリプト上で条件分岐させた。「一本」のほうがより細かく切る（より気持ち良い）演出だ。</p><h3 id=ui-シーン>UI シーン</h3><p>プレイ画面の UI として、まず HUD を画面下端に配置した。これは Background シーンの侍の足場である StaticBody2D ノードの CollisionShape2D 子ノードの領域と重なるようにしている。この HUD に「一時停止する」「再開する」「設定画面を開く」「ステージ選択画面に移動する」の4つのボタンを設けた。ボタンのデザインは、アイコンのみロイヤリティフリーの素材を使用しているが、それ以外のボタンのデザインやレイアウトは、ノードそれぞれのプロパティを調整するのみにして、シンプルに留めた。</p><p>一時停止画面も UI シーンのひとつとして作成した。ColorRect ノードで全画面に半透明の薄い緑色を重ね、Label ノードで「一時停止中」の文字を表示させた。HUD の「一時停止する」ボタン以外は一時停止中でなければ押せない仕様にした。これは誤操作防止策の一つだ。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/08.webp alt=HUD></p><p>「ステージ選択画面に移動する」ボタンを押した際、「本当にゲームを中断してステージ選択画面に移動しても良いか」の確認ダイアログを表示させるようにした。最終的なオプションボタンの文言は「はい」と「いいえ」だが、開発初期は、ゲームの雰囲気を出すのに躍起になっていたので、「承知した」「断る」のような文言にしていた。雰囲気よりわかりやすさのほうが優先度が高いと判断してボツにした。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/09.webp alt=確認ダイアログ></p><p>開発終盤にはチュートリアルを追加した。正直、チュートリアルがなくてもすぐにわかるような操作性にしたつもりだったが、いつでもチュートリアルが見られるようにしておく優しさはあっても良いと思った。そういうわけで、一時停止中に画面右上の（？）アイコンを押すとチュートリアルが始まるようにした。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/10.webp alt=チュートリアル></p><p>侍が刀を鞘に収め、落ち物が分断されたタイミングで、当たり判定の「一本」または「技あり」が表示されるようにした。特大のフォントサイズから一瞬で標準サイズにアニメーションするようにしていたが、これが開発終盤まで苦しんだメモリリーク問題に関わっていた。結論から言えば、Label ノードの文字を拡大縮小させるなどアニメーションさせたい場合、素直に <code>scale</code> プロパティの値を変化させるのが正解だ。しかし、私は「文字のサイズを変化させる」=「フォントサイズを変化させる」と考えてしまった。そして AnimationPlayer ノードで、<code>Theme Overrides Font Size</code> プロパティの値を変化させてしまっていた。詳しい理由は不明だが、このアニメーションが実行されるたびに約 150 MB ずつメモリの消費量が増えていき、いくつかステージをクリアしていくと、必ずゲームがクラッシュするという状態であった。思い込みには要注意である。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/11.gif alt=当たり判定表示アニメーション></p><p>ステージクリア後のオプションボタンも実装した。「次へ参る」「再び挑む」「ステージ選択」の3つだ。モバイルカジュアルゲームといえば、通勤通学中の電車やバスでの操作を想定する必要があるだろう。場合によっては片手での操作もありうる。そこで、これらのオプションボタンは画面の下部に配置した。「次へ参る」を押す機会が一番多いはずなので、順番は一番下にもってきた。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/12.webp alt=ステージクリア後のオプションボタン></p><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=ステージ選択画面>ステージ選択画面</h2><p>ステージ選択画面はプレイ画面とは別物として用意した。この画面を起点に、設定画面、メニュー画面、落物記録画面へ遷移するようにした。メニュー画面にはさらに、スコア画面、クレジット/ライセンス画面への遷移や、Appレビューページへのリンク、ゲームデータ消去機能を実装した。</p><p>ステージ選択画面は、当初、ステージ選択用のアイコンを ScrollContainer の中に全200ステージ分用意しており、VisibleOnScreenEnabler2D ノードによって、画面上に表示される前後で、表示 / 非表示を自動で切り替え、コンピュータのリソースを節約するようなロジックで実装していた。しかし、それでも画面をスクロールさせたときのもっさりした動きが気になってしまうレベルだったので、構成を変更した。レベル切り替えボタンを新たに配置し、1 画面内には 1 レベル 20 ステージ分のアイコンしか表示されないように調整した。これにより、もっさり感はなくなった。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/13.gif alt=ステージ選択画面></p><p>プレイ画面同様、このステージ選択画面も若干操作方法に迷う可能性があると判断し、チュートリアルを用意した。右上の（？）アイコンからいつでも表示できる仕組みもプレイ画面のそれと同じである。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/14.gif alt=ステージ選択画面のチュートリアル></p><br><hr><h2 id=設定画面>設定画面</h2><p>設定画面のつくり自体は至ってシンプルだ。Container 系のノードを使って、レイアウトを整理しただけである。ボタンのアイコンはロイヤリティフリーの素材を使用している。</p><p><img loading=lazy src=/images/posts/post0005/3_logic/15.webp alt=設定画面></p><p>ボタンはすべて <code>Toggle Mode</code> をオンにして、<code>toggled(button_pressed: bool)</code> シグナルをルートノードのスクリプトに紐づけた。例えば、BGMボタンのシグナルは以下のメソッドに紐づいている。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_on_background_music_button_toggled</span><span class=p>(</span><span class=n>button_pressed</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>button_pressed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Gamedata</span><span class=o>.</span><span class=n>bgm_enabled</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>Gamedata</span><span class=o>.</span><span class=n>sfx_enabled</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>enabled_sound_player</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>bgm_disabled</span><span class=o>.</span><span class=nf>emit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Gamedata</span><span class=o>.</span><span class=n>bgm_enabled</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>Gamedata</span><span class=o>.</span><span class=n>sfx_enabled</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>disabled_sound_player</span><span class=o>.</span><span class=nf>play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>bgm_enabled</span><span class=o>.</span><span class=nf>emit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bgm_button</span><span class=o>.</span><span class=nf>release_focus</span><span class=p>()</span>
</span></span></code></pre></div><p>上記コードのうち、<code>Gamedata</code> というのは、Godot の Autoload 機能で読み込んでいるスクリプトだ。設定を保存するには、設定ファイルを用意する必要があるので、セーブ/ロード機能をまとめた gamedata.gd スクリプトを作り、Autoload でゲーム開始時に自動で読み込ませるようにした。スクリプトのコードは以下のようになっている。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=kd>const</span> <span class=n>OPTIONS_PATH</span> <span class=o>:=</span> <span class=s2>&#34;user://options.save&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>bgm_enabled</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>sfx_enabled</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>background_pattern</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>ippon_only</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>speech_bubble_enabled</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=n>speech_bubble_auto_hide</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>save_options</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;bgm_enabled&#34;</span><span class=p>:</span> <span class=n>bgm_enabled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sfx_enabled&#34;</span><span class=p>:</span> <span class=n>sfx_enabled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;background_pattern&#34;</span><span class=p>:</span> <span class=n>background_pattern</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ippon_only&#34;</span><span class=p>:</span> <span class=n>ippon_only</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;speech_bubble_enabled&#34;</span><span class=p>:</span> <span class=n>speech_bubble_enabled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;speech_bubble_auto_hide&#34;</span><span class=p>:</span> <span class=n>speech_bubble_auto_hide</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>file</span> <span class=o>=</span> <span class=nc>FileAccess</span><span class=o>.</span><span class=nf>open</span><span class=p>(</span><span class=n>OPTIONS_PATH</span><span class=p>,</span> <span class=nc>FileAccess</span><span class=o>.</span><span class=n>WRITE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=o>.</span><span class=nf>store_var</span><span class=p>(</span><span class=n>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=o>.</span><span class=nf>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>load_options</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>file</span> <span class=o>=</span> <span class=nc>FileAccess</span><span class=o>.</span><span class=nf>open</span><span class=p>(</span><span class=n>OPTIONS_PATH</span><span class=p>,</span> <span class=nc>FileAccess</span><span class=o>.</span><span class=n>READ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>!</span><span class=n>file</span><span class=p>:</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=n>options</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=nf>get_var</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>!</span><span class=n>options</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>file</span><span class=o>.</span><span class=nf>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;bgm_enabled&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>bgm_enabled</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;bgm_enabled&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;sfx_enabled&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>sfx_enabled</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;sfx_enabled&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;background_pattern&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>background_pattern</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;background_pattern&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;ippon_only&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ippon_only</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;ippon_only&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;speech_bubble_enabled&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>speech_bubble_enabled</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;speech_bubble_enabled&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=nf>has</span><span class=p>(</span><span class=s2>&#34;speech_bubble_auto_hide&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>speech_bubble_auto_hide</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s2>&#34;speech_bubble_auto_hide&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=o>.</span><span class=nf>close</span><span class=p>()</span>
</span></span></code></pre></div><br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4952908839423901" crossorigin=anonymous></script><p><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-4952908839423901 data-ad-slot=9419515863></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><hr><h2 id=おわりに>おわりに</h2><p>ということで、この開発ログには「もの切り侍」のロジックに関わる部分を記した。</p><p>3D ゲームはわからないが、2D ゲームに関しては、Godot に用意されている様々なクラスを組み合わせれば、実現したいことはだいたいできてしまうのではないか、と思った。しかし、それと同時に、ゲームのアイデアをアルゴリズムに落とし込んで、それを実現するためにドキュメントを読み込んで検証する作業は、時に相当の忍耐が必要になるということもわかった。</p><p>この開発ログがどなたかのゲーム開発の一助になれば幸いだ。</p><br><hr></div><footer class=post-footer><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 開発ログ：もの切り侍【ロジック編】 on x" href="https://x.com/intent/tweet/?text=%f0%9f%93%94%20%e9%96%8b%e7%99%ba%e3%83%ad%e3%82%b0%ef%bc%9a%e3%82%82%e3%81%ae%e5%88%87%e3%82%8a%e4%be%8d%e3%80%90%e3%83%ad%e3%82%b8%e3%83%83%e3%82%af%e7%b7%a8%e3%80%91&amp;url=https%3a%2f%2fwww.peanuts-code.com%2fja%2fposts%2fpost0005_slashing_samurai_devlogs%2fslashing_samurai_devlog_3%2f&amp;hashtags=GameDev%2cIndieDev%2cDevlog%2cMobileGame%2ciOS%2c%e3%82%82%e3%81%ae%e5%88%87%e3%82%8a%e4%be%8d"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 開発ログ：もの切り侍【ロジック編】 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.peanuts-code.com%2fja%2fposts%2fpost0005_slashing_samurai_devlogs%2fslashing_samurai_devlog_3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li></ul><ul class=post-tags><li><a href=https://www.peanuts-code.com/ja/tags/gamedev/>GameDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/indiedev/>IndieDev</a></li><li><a href=https://www.peanuts-code.com/ja/tags/devlog/>Devlog</a></li><li><a href=https://www.peanuts-code.com/ja/tags/mobilegame/>MobileGame</a></li><li><a href=https://www.peanuts-code.com/ja/tags/ios/>IOS</a></li><li><a href=https://www.peanuts-code.com/ja/tags/%E3%82%82%E3%81%AE%E5%88%87%E3%82%8A%E4%BE%8D/>もの切り侍</a></li></ul><nav class=paginav><a class=prev href=https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_4/><span class=title>« 前へ</span><br><span>📔 開発ログ：もの切り侍【反省編】</span>
</a><a class=next href=https://www.peanuts-code.com/ja/posts/post0005_slashing_samurai_devlogs/slashing_samurai_devlog_1/><span class=title>次へ »</span><br><span>📔 開発ログ：もの切り侍【企画編】</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.peanuts-code.com/ja/>Peanuts Code</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>